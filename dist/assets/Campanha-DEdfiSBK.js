import{p as e,i as a,g as t,j as i,m as s}from"./utils-CdldNp8C.js";import{r as n}from"./react-vendor-qiAl16-a.js";import{u as r,a as o,p as l,L as d}from"./index-Bskpd325.js";import{F as c,i as u,J as m,K as p,C as f,a0 as h,b as x,a1 as g,a2 as j,a3 as A,I as S,f as v,S as y,o as C,U as O,a4 as b,a5 as D,c as I,B as N,V as E,v as w,a6 as M,$ as T,w as U,A as _,s as F,T as k,t as R,D as L,u as V}from"./ui-vendor-ENUJtt81.js";function z({open:s,initial:k,onCancel:R,onSaved:L}){const[V]=c.useForm(),[z,P]=n.useState("eleitores"),[q,B]=n.useState([]),[H,J]=n.useState([]),[$,G]=n.useState(void 0),Y=r(),{user:W}=o(),[K,Q]=n.useState(0),[X,Z]=n.useState(0),[ee,ae]=n.useState(0),[te,ie]=n.useState(0),[se,ne]=n.useState(0),[re,oe]=n.useState(0),le=n.useMemo(()=>{const t=W?.login_time;if(!t)return null;const i=e(t);if(a(i))return i;const s=new Date(t);return isNaN(s.getTime())?null:s},[W]),[de,ce]=n.useState(""),ue=le?t(le,"dd/MM/yyyy HH:mm",{locale:l}):"",me=String(localStorage.getItem("tenantSlug")||"captar"),pe=String(localStorage.getItem("tenantName")||"CAPTAR");n.useEffect(()=>{const e=()=>{if(!le)return void ce("");const e=Date.now()-le.getTime(),a=Math.floor(e/36e5),t=Math.floor(e%36e5/6e4),i=Math.floor(e%6e4/1e3),s=String(a).padStart(2,"0"),n=String(t).padStart(2,"0"),r=String(i).padStart(2,"0");ce(`${s}:${n}:${r}`)};e();const a=setInterval(e,1e3);return()=>clearInterval(a)},[le]),n.useEffect(()=>{if(s)if(k){V.setFieldsValue({...k,data_inicio:k.data_inicio?e(k.data_inicio):void 0,data_fim:k.data_fim?e(k.data_fim):void 0}),k.AnexoJSON||k.Anexo?P("arquivo"):P("eleitores"),Q(k.meta||0),Z(k.enviados||0),ae(k.nao_enviados||0),ie(k.positivos||0),ne(k.negativos||0);const a=(k.enviados||0)-((k.positivos||0)+(k.negativos||0));oe(void 0!==k.aguardando?k.aguardando:a>0?a:0)}else V.resetFields(),P("eleitores"),B([]),J([]),G(void 0),Q(0),Z(0),ae(0),ie(0),ne(0),oe(0)},[s,k]),n.useEffect(()=>{(async()=>{if("eleitores"===z)try{const e=await Y.getDashboardStats();Q(e.totalEleitores||0)}catch(e){console.error("Erro ao buscar total de eleitores",e)}else if("arquivo"===z&&q.length>0){const e=q[0].originFileObj;if(e)if(e.name.endsWith(".json"))try{const a=await e.text(),t=JSON.parse(a);if(Array.isArray(t)&&(Q(t.length),t.length>0)){Object.keys(t[0]).map(e=>e.toLowerCase()).includes("whatsapp")||F.warning('Atenção: O arquivo JSON não contém a chave "whatsapp".')}}catch{}else if(e.name.endsWith(".csv"))try{const a=(await e.text()).split("\n").filter(e=>e.trim().length>0);if(a.length>0){a[0].toLowerCase().includes("whatsapp")||F.warning('Atenção: O arquivo CSV não contém a coluna "whatsapp".'),Q(Math.max(0,a.length-1))}else Q(0)}catch{}}})()},[z,q,Y]);const fe=n.useMemo(()=>{if(!k?.id)return!1;const e=V.getFieldValue("data_inicio"),a=V.getFieldValue("data_fim");if(!e)return!1;const t=new Date;try{const i=e.toDate?e.toDate():new Date(e),s=a?a.toDate?a.toDate():new Date(a):new Date(2100,0,1);return t>=i&&t<=s}catch{return!1}},[k,V.getFieldValue("data_inicio"),V.getFieldValue("data_fim")]);return i.jsxs(u,{open:s,title:i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[i.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[i.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),i.jsxs("div",{style:{fontSize:12},children:["TENANT: ",i.jsx("strong",{style:{color:"#333"},children:String(pe||me).toUpperCase()})]})]}),i.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[i.jsxs("div",{style:{textAlign:"right"},children:[i.jsx("div",{style:{fontWeight:700},children:W?.usuario?String(W?.usuario).toUpperCase():String(W?.nome||"").toUpperCase()||"USUÁRIO"}),i.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(W?.funcao||"").toUpperCase()} | PERFIL: ${String(W?.perfil||"").toUpperCase()}`}),i.jsx("div",{style:{fontSize:12},children:`LOGIN: ${ue||"--"} | TEMPO CONECTADO: ${de||"--:--:--"}`})]}),i.jsx(_,{size:"large"})]})]}),onCancel:R,footer:null,destroyOnHidden:!0,width:980,closable:!1,maskClosable:!1,className:"campanhas-modal",children:[i.jsx("style",{children:".campanhas-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .campanhas-modal .ant-modal-content{ border-radius: 0 !important; } .campanhas-modal .ant-form-item{ margin-bottom:6px; }"}),i.jsxs(m,{gutter:16,style:{marginBottom:16},children:[i.jsx(p,{span:4,children:i.jsx(f,{size:"small",style:{textAlign:"center",background:"#f0f5ff",borderColor:"#adc6ff"},children:i.jsx(h,{title:"META",value:K,valueStyle:{color:"#2f54eb"},prefix:i.jsx(x,{})})})}),i.jsx(p,{span:4,children:i.jsx(f,{size:"small",style:{textAlign:"center",background:"#f6ffed",borderColor:"#b7eb8f"},children:i.jsx(h,{title:"ENVIADOS",value:X,valueStyle:{color:"#3f8600"},prefix:i.jsx(g,{})})})}),i.jsx(p,{span:4,children:i.jsx(f,{size:"small",style:{textAlign:"center",background:"#fff1f0",borderColor:"#ffa39e"},children:i.jsx(h,{title:"NÃO ENVIADOS",value:ee,valueStyle:{color:"#cf1322"},prefix:i.jsx(j,{})})})}),i.jsx(p,{span:4,children:i.jsx(f,{size:"small",style:{textAlign:"center",background:"#e6f7ff",borderColor:"#91d5ff"},children:i.jsx(h,{title:"POSITIVOS",value:te,valueStyle:{color:"#096dd9"}})})}),i.jsx(p,{span:4,children:i.jsx(f,{size:"small",style:{textAlign:"center",background:"#fffbe6",borderColor:"#ffe58f"},children:i.jsx(h,{title:"NEGATIVOS",value:se,valueStyle:{color:"#d48806"}})})}),i.jsx(p,{span:4,children:i.jsx(f,{size:"small",style:{textAlign:"center",background:"#f9f0ff",borderColor:"#d3adf7"},children:i.jsx(h,{title:"AGUARDANDO",value:re,valueStyle:{color:"#722ed1"},prefix:i.jsx(A,{spin:re>0})})})})]}),i.jsxs(c,{form:V,layout:"vertical",children:[i.jsxs(f,{title:"DADOS DA CAMPANHA",size:"small",children:[i.jsx(c.Item,{name:"nome",label:"NOME DA CAMPANHA",rules:[{required:!0,message:"Informe o nome"}],getValueFromEvent:e=>{const a=e?.target?.value;return"string"==typeof a?a.toUpperCase():a},children:i.jsx(S,{prefix:i.jsx(v,{}),placeholder:"Ex: CAMPANHA DE DOAÇÃO"})}),i.jsx(c.Item,{name:"descricao",label:"DESCRIÇÃO / MENSAGEM",children:i.jsx(S.TextArea,{rows:4,placeholder:"Texto da mensagem que será enviada"})}),i.jsxs(y,{style:{display:"flex",marginBottom:8},align:"start",children:[i.jsx(c.Item,{name:"data_inicio",label:"DATA INÍCIO",rules:[{required:!0}],children:i.jsx(C,{style:{width:150},format:"DD/MM/YYYY"})}),i.jsx(c.Item,{name:"data_fim",label:"DATA FIM",children:i.jsx(C,{style:{width:150},format:"DD/MM/YYYY"})})]}),i.jsx(c.Item,{label:"IMAGEM DA MENSAGEM",children:i.jsx(O,{listType:"picture-card",maxCount:1,fileList:H,onChange:({fileList:e})=>J(e),beforeUpload:()=>!1,accept:"image/*",children:H.length<1&&i.jsxs("div",{children:[i.jsx(b,{}),i.jsx("div",{style:{marginTop:8},children:"Upload"})]})})})]}),i.jsxs(f,{title:"DESTINATÁRIOS",size:"small",style:{marginTop:16},children:[i.jsx(c.Item,{label:"SELECIONE A ORIGEM DOS CONTATOS",children:i.jsxs(D.Group,{value:z,onChange:e=>P(e.target.value),children:[i.jsxs(D.Button,{value:"eleitores",children:[i.jsx(x,{})," BASE DE ELEITORES"]}),i.jsxs(D.Button,{value:"arquivo",children:[i.jsx(I,{})," IMPORTAR ARQUIVO"]})]})}),"arquivo"===z&&i.jsxs(c.Item,{label:"ARQUIVO DE CONTATOS (JSON, CSV, XLS, PDF)",required:!0,children:[i.jsx(O,{maxCount:1,fileList:q,onChange:({fileList:e})=>B(e),beforeUpload:()=>!1,accept:".json,.csv,.xls,.xlsx,.pdf",children:i.jsx(N,{icon:i.jsx(E,{}),children:"Selecionar Arquivo"})}),i.jsxs("div",{style:{marginTop:8,color:"#666",fontSize:"12px"},children:["JSON: O conteúdo será salvo no banco.",i.jsx("br",{}),"Outros: O arquivo será anexado."]})]})]}),i.jsxs(y,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[i.jsx(N,{onClick:R,icon:i.jsx(w,{}),children:"CANCELAR"}),i.jsx(M,{title:k?.id?fe?"Iniciar automação":"Fora do período de vigência":"Salve a campanha antes de enviar",children:i.jsx(N,{onClick:async()=>{k.id,V.getFieldValue("nome"),V.getFieldValue("descricao"),F.loading({content:"Iniciando automação...",key:"envio"});try{await new Promise(e=>setTimeout(e,1500)),F.success({content:"Automação iniciada com sucesso!",key:"envio"})}catch(e){F.error({content:"Erro ao iniciar automação",key:"envio"})}},disabled:!fe,icon:i.jsx(T,{}),style:{background:fe?"#52c41a":void 0,color:fe?"#fff":void 0,borderColor:fe?"#52c41a":void 0},children:"ENVIAR CAMPANHA"})}),i.jsx(N,{type:"primary",onClick:async()=>{try{const a=await V.validateFields(),i={...a,data_inicio:a.data_inicio?t(a.data_inicio,"yyyy-MM-dd"):null,data_fim:a.data_fim?t(a.data_fim,"yyyy-MM-dd"):null,meta:K,enviados:X,nao_enviados:ee,positivos:te,negativos:se,aguardando:re};if("arquivo"===z&&q.length>0){const a=q[0].originFileObj;if(a)if(a.name.endsWith(".json")){const t=await a.text();try{JSON.parse(t),i.AnexoJSON=t}catch(e){return void F.error("Arquivo JSON inválido")}}else i.AnexoFile=a}else"eleitores"===z&&(i.UsarEleitores=!0);let s;if(k?.id)await Y.updateCampanha(k.id,i),s=k.id,F.success("Campanha atualizada");else{s=(await Y.createCampanha(i)).id,F.success("Campanha criada")}if(H.length>0){const e=H[0].originFileObj;e&&await Y.uploadCampanhaAnexo(s,{file:e,type:"imagem"})}"arquivo"===z&&i.AnexoFile&&await Y.uploadCampanhaAnexo(s,{file:i.AnexoFile,type:"anexo"}),L()}catch(e){F.error(e?.response?.data?.detail||"Erro ao salvar campanha")}},icon:i.jsx(U,{}),children:"SALVAR"})]})]})]})}function P(){const[e,a]=n.useState([]),[t,l]=n.useState(!1),[d,c]=n.useState(!1),[u,m]=n.useState(null),[p,f]=n.useState([]),[h,x]=n.useState({}),[g,j]=n.useState([]),A=r(),{user:S}=o(),v=()=>i.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:[i.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z",fill:"currentColor"}),i.jsx("path",{d:"M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",fill:"currentColor"})]}),C=()=>i.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:i.jsx("path",{d:"M6 7h12M9 7v10m6-10v10M4 7h16l-1 14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),O=()=>i.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:i.jsx("path",{d:"M3 4h6v16H3V4zm12 0h6v16h-6V4z",fill:"currentColor"})}),b=()=>i.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:i.jsx("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),D=async()=>{try{l(!0);const e=await A.getCampanhasSchema(),t=["id","nome","status","meta","enviados","aguardando","data_inicio","data_fim","created_at"],i={};for(const a of e.columns||[])i[a.name]=a;const s=t.filter(e=>i[e]).map(e=>i[e]),n=(e.columns||[]).filter(e=>!t.includes(e.name));f([...s,...n]);const r=(await A.getCampanhas()).rows||[];a(r);const o={};for(const a of t)i[a]&&(o[a]=!0);for(const a of n)o[a.name]=!1;const d=`campanhas.columns.visible.${S?.usuario||"default"}`,c=localStorage.getItem(d);x(c?JSON.parse(c):o);const u=`campanhas.columns.order.${S?.usuario||"default"}`,m=localStorage.getItem(u);j(m?JSON.parse(m):t.filter(e=>i[e]))}catch(e){F.error(e?.response?.data?.detail||"Erro ao carregar campanhas")}finally{l(!1)}};n.useEffect(()=>{D()},[]);const I=p.map(a=>{const t=a.name,s=Array.from(new Set((e||[]).map(e=>e[t]).filter(e=>null!=e))).slice(0,20).map(e=>({text:String(e).toUpperCase(),value:String(e).toUpperCase()})),n=(a.type||"").toLowerCase(),r=new Set(["id","status","data_inicio","data_fim","created_at"]);return{title:{id:"ID",nome:"NOME DA CAMPANHA",descricao:"DESCRIÇÃO",status:"STATUS",data_inicio:"INÍCIO",data_fim:"FIM",meta:"META",enviados:"ENVIADOS",nao_enviados:"NÃO ENVIADOS",positivos:"POSITIVOS",negativos:"NEGATIVOS",aguardando:"AGUARDANDO",created_at:"CRIADO EM"}[t]||t.toUpperCase(),dataIndex:t,align:r.has(t)?"center":"left",filters:s,onFilter:(e,a)=>String(a[t]).toUpperCase()===String(e).toUpperCase(),sorter:(e,a)=>{const i=e[t],s=a[t];return null==i?-1:null==s?1:n.includes("int")||n.includes("numeric")||n.includes("decimal")?Number(i)-Number(s):n.includes("date")||n.includes("timestamp")?new Date(i).getTime()-new Date(s).getTime():String(i).toUpperCase().localeCompare(String(s).toUpperCase())},render:e=>{if(null==e)return"";if(n.includes("date")||n.includes("timestamp")){const a=new Date(e);if(!isNaN(a.getTime()))return a.toLocaleDateString("pt-BR")}if("status"===t){let a="default";return"PLANEJAMENTO"===String(e).toUpperCase()&&(a="blue"),"EM_ANDAMENTO"===String(e).toUpperCase()&&(a="green"),"CONCLUIDA"===String(e).toUpperCase()&&(a="orange"),"CANCELADA"===String(e).toUpperCase()&&(a="red"),i.jsx(k,{color:a,children:String(e).toUpperCase()})}return String(e).toUpperCase()},onHeaderCell:()=>({draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain",t)},onDragOver:e=>{e.preventDefault()},onDrop:e=>{const a=e.dataTransfer.getData("text/plain"),i=t;a&&a!==i&&j(e=>{const t=e.filter(e=>e!==a),s=t.indexOf(i);if(-1===s)return e;t.splice(s,0,a);const n=`campanhas.columns.order.${S?.usuario||"default"}`;return localStorage.setItem(n,JSON.stringify(t)),t})}})}}),E={title:"AÇÕES",dataIndex:"__actions__",align:"center",render:(e,a)=>i.jsxs(y,{children:[i.jsx(N,{type:"text",icon:i.jsx(v,{}),title:"EDITAR",onClick:()=>{m(a),c(!0)}}),i.jsx(N,{type:"text",danger:!0,icon:i.jsx(C,{}),title:"DELETAR",onClick:async()=>{try{if(!a.id)return void F.info("REGISTRO SEM ID");await A.deleteCampanha(a.id),F.success("CAMPANHA DELETADA"),await D()}catch(e){F.error(e?.response?.data?.detail||"ERRO AO DELETAR CAMPANHA")}}})]})},w=(g.length?g:I.map(e=>e.dataIndex)).map(e=>I.find(a=>a.dataIndex===e)).filter(Boolean).filter(e=>h[e.dataIndex]).concat([E]),M=i.jsx("div",{style:{padding:12},children:p.map(e=>i.jsx("div",{style:{marginBottom:6},children:i.jsx(R,{checked:!!h[e.name],onChange:a=>{const t={...h,[e.name]:a.target.checked};x(t);const i=`campanhas.columns.visible.${S?.usuario||"default"}`;localStorage.setItem(i,JSON.stringify(t))},children:e.name.toUpperCase()})},e.name))});return i.jsxs(s.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[i.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:i.jsxs(y,{children:[i.jsx(L,{placement:"bottomRight",trigger:["click"],menu:{items:[]},popupRender:()=>M,children:i.jsx(N,{shape:"circle",icon:i.jsx(O,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},title:"VISUALIZAÇÃO DE COLUNAS"})}),i.jsx(N,{shape:"circle",icon:i.jsx(b,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},onClick:()=>{m(null),c(!0)},title:"NOVA CAMPANHA"})]})}),i.jsx("style",{children:"\n        .campanhas-table .ant-table-thead > tr > th{ background:#FFD700; color:#000; font-family: 'Arimo', Arial, sans-serif; }\n        .campanhas-table .ant-table-thead > tr > th .ant-table-column-title{ display:flex; justify-content:center; align-items:center; text-align:center; }\n        .campanhas-table .ant-table-tbody > tr > td{ font-family: 'Roboto Condensed', Arial, sans-serif; padding:2px 6px; line-height:0.95; height:22px; }\n      "}),i.jsx(V,{loading:t,dataSource:e,columns:w,rowKey:"id",bordered:!0,size:"small",className:"ant-table-striped campanhas-table"}),i.jsx(z,{open:d,initial:u||void 0,onCancel:()=>c(!1),onSaved:async()=>{c(!1),await D()}})]})}export{P as default};
