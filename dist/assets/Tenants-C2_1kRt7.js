import{p as e,i as t,g as a,j as n,m as r}from"./utils-CdldNp8C.js";import{r as s}from"./react-vendor-qiAl16-a.js";import{u as l,b as o,p as i,L as d}from"./index-p6nnnxfN.js";import{F as c,h as u,I as p,r as m,S as g,B as x,p as S,q as h,A as f,s as y,Q as j,D as C,v as b,l as T,T as I}from"./ui-vendor-Dus7eQak.js";function N({open:r,initial:y,onCancel:j,onSaved:C}){const[b]=c.useForm(),T=l(),{user:I}=o(),[N,A]=s.useState(""),v=s.useMemo(()=>{const a=I?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const r=new Date(a);return isNaN(r.getTime())?null:r},[I]),D=v?a(v,"dd/MM/yyyy HH:mm",{locale:i}):"",_=String(localStorage.getItem("tenantSlug")||"captar"),O=String(localStorage.getItem("tenantName")||"CAPTAR");s.useEffect(()=>{const e=()=>{if(!v)return void A("");const e=Date.now()-v.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),r=String(t).padStart(2,"0"),s=String(a).padStart(2,"0"),l=String(n).padStart(2,"0");A(`${r}:${s}:${l}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[v]),s.useEffect(()=>{r&&(y?b.setFieldsValue({Nome:y.Nome,Slug:y.Slug,Status:y.Status,Plano:y.Plano}):b.resetFields())},[r,y]);return n.jsxs(u,{open:r,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(O||_).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:I?.usuario?String(I?.usuario).toUpperCase():String(I?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(I?.funcao||"").toUpperCase()} | PERFIL: ${String(I?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${D||"--"} | TEMPO CONECTADO: ${N||"--:--:--"}`})]}),n.jsx(f,{size:"large"})]})]}),onCancel:j,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; } .tenants-modal .ant-form-item{ margin-bottom:6px; }"}),n.jsxs(c,{form:b,layout:"vertical",children:[n.jsx("div",{style:{display:"grid",gap:16},children:n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16},children:[n.jsxs("div",{children:[n.jsx(c.Item,{name:"Nome",label:"Nome",rules:[{required:!0}],children:n.jsx(p,{})}),n.jsx(c.Item,{name:"Slug",label:"Slug",rules:[{required:!0}],children:n.jsx(p,{})})]}),n.jsxs("div",{children:[n.jsx(c.Item,{name:"Status",label:"Status",children:n.jsx(m,{options:[{value:"ATIVO",label:"ATIVO"},{value:"INATIVO",label:"INATIVO"}]})}),n.jsx(c.Item,{name:"Plano",label:"Plano",children:n.jsx(m,{options:[{value:"PADRAO",label:"PADRÃO"},{value:"PRO",label:"PRO"}]})})]})]})}),n.jsxs(g,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(x,{onClick:j,icon:n.jsx(S,{}),children:"CANCELAR"}),n.jsx(x,{type:"primary",onClick:async()=>{try{const e=await b.validateFields();y?.IdTenant?await T.updateTenant(y.IdTenant,e):await T.createTenant(e),C()}catch{}},icon:n.jsx(h,{}),children:"SALVAR"})]})]})]})}function A({open:r,initial:m,onCancel:j,onSaved:C}){const[b]=c.useForm(),T=l(),{user:I}=o(),[N,A]=s.useState(""),v=s.useMemo(()=>{const a=I?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const r=new Date(a);return isNaN(r.getTime())?null:r},[I]),D=v?a(v,"dd/MM/yyyy HH:mm",{locale:i}):"",_=String(localStorage.getItem("tenantSlug")||"captar"),O=String(localStorage.getItem("tenantName")||"CAPTAR");s.useEffect(()=>{r&&(m?b.setFieldsValue(m):b.resetFields())},[r,m]),s.useEffect(()=>{const e=()=>{if(!v)return void A("");const e=Date.now()-v.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),r=String(t).padStart(2,"0"),s=String(a).padStart(2,"0"),l=String(n).padStart(2,"0");A(`${r}:${s}:${l}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[v]);return n.jsxs(u,{open:r,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(O||_).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:I?.usuario?String(I?.usuario).toUpperCase():String(I?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(I?.funcao||"").toUpperCase()} | PERFIL: ${String(I?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${D||"--"} | TEMPO CONECTADO: ${N||"--:--:--"}`})]}),n.jsx(f,{size:"large"})]})]}),onCancel:j,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; } .tenants-modal .ant-form-item{ margin-bottom:6px; }"}),n.jsxs(c,{form:b,layout:"vertical",children:[n.jsx(c.Item,{name:"nome",label:"Nome",rules:[{required:!0}],children:n.jsx(p,{})}),n.jsx(c.Item,{name:"slug",label:"Slug",rules:[{required:!0}],children:n.jsx(p,{})}),n.jsx(c.Item,{name:"db_name",label:"Nome do Banco",rules:[{required:!0}],children:n.jsx(p,{})}),n.jsx(c.Item,{name:"db_host",label:"Host",rules:[{required:!0}],children:n.jsx(p,{})}),n.jsx(c.Item,{name:"db_port",label:"Porta",rules:[{required:!0}],children:n.jsx(p,{})}),n.jsx(c.Item,{name:"db_user",label:"Usuário",rules:[{required:!0}],children:n.jsx(p,{})}),n.jsx(c.Item,{name:"db_password",label:"Senha",rules:[{required:!0}],children:n.jsx(p.Password,{})}),n.jsxs(g,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(x,{onClick:j,icon:n.jsx(S,{}),children:"CANCELAR"}),n.jsx(x,{type:"primary",onClick:async()=>{try{const e=await b.validateFields(),t=await T.provisionTenant(e);y.success(`Banco provisionado: ${t.dsn}`),C({idTenant:t.idTenant,dsn:t.dsn})}catch(e){y.error(e?.response?.data?.detail||"Erro ao provisionar banco")}},icon:n.jsx(h,{}),children:"SALVAR"})]})]})]})}function v({open:r,dsn:l,onCancel:c}){const{user:p}=o(),[m]=s.useState(""),g=s.useMemo(()=>{const a=p?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const r=new Date(a);return isNaN(r.getTime())?null:r},[p]),x=g?a(g,"dd/MM/yyyy HH:mm",{locale:i}):"",S=String(localStorage.getItem("tenantSlug")||"captar"),h=String(localStorage.getItem("tenantName")||"CAPTAR");return n.jsxs(u,{open:r,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(h||S).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:p?.usuario?String(p?.usuario).toUpperCase():String(p?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(p?.funcao||"").toUpperCase()} | PERFIL: ${String(p?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${x||"--"} | TEMPO CONECTADO: ${m||"--:--:--"}`})]}),n.jsx(f,{size:"large"})]})]}),onCancel:c,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; }"}),n.jsx("div",{style:{fontFamily:"monospace"},children:l||"—"})]})}function D(){const e=l(),{message:t,modal:a}=j.useApp(),[i,d]=s.useState([]),[c,p]=s.useState(!1),[m,S]=s.useState(!1),[h,f]=s.useState(null),[y,D]=s.useState(!1),[_,O]=s.useState(void 0),[E,w]=s.useState(!1),[R,U]=s.useState(""),[P,k]=s.useState({}),[F,$]=s.useState([]),{user:L}=o(),[B,M]=s.useState({open:!1}),V=async()=>{try{p(!0);const t=(await e.listTenants()).rows||[],a=await Promise.all(t.map(async t=>{try{const a=await e.listTenantParametros(t.IdTenant),n=(a.rows||[]).find(e=>"DB_DSN"===String(e.Chave||e.chave).toUpperCase()),r=(a.rows||[]).find(e=>"DB_CREATED_AT"===String(e.Chave||e.chave).toUpperCase());return{...t,__db__:!!n,__db_created_at__:r?String(r.Valor||r.valor||""):""}}catch{return{...t,__db__:!1,__db_created_at__:""}}}));d(a);const n=["IdTenant","Nome","Slug","Status","Plano","DataCadastro","DataUpdate"],r=`tenants.columns.visible.${L?.usuario||"default"}`,s=localStorage.getItem(r),l={};for(const e of n)l[e]=!0;k(s?JSON.parse(s):{...l,__db__:!0,__db_created_at__:!0});const o=`tenants.columns.order.${L?.usuario||"default"}`,i=localStorage.getItem(o);$(i?JSON.parse(i):n)}catch(a){t.error(a?.response?.data?.detail||"Erro ao carregar tenants")}finally{p(!1)}};s.useEffect(()=>{V()},[]);const z={IdTenant:"ID",Nome:"NOME",Slug:"SLUG",Status:"STATUS",Plano:"PLANO",DataCadastro:"DATA E HORA DE CADASTRO",DataUpdate:"DATA UPDATE"},H=new Set(["IdTenant","Status","Plano","DataCadastro","DataUpdate"]),q=["IdTenant","Nome","Slug","Status","Plano","DataCadastro","DataUpdate"].map(e=>{const t={title:z[e]||e.toUpperCase(),dataIndex:e,align:H.has(e)?"center":"left",sorter:(t,a)=>{const n=t[e],r=a[e];return null==n?-1:null==r?1:"IdTenant"===e?Number(r)-Number(n):e.includes("Data")?new Date(n).getTime()-new Date(r).getTime():String(n).toUpperCase().localeCompare(String(r).toUpperCase())},sortDirections:["ascend","descend"],render:t=>{if(null==t)return"";if(e.includes("Data")){const e=new Date(t);if(!isNaN(e.getTime()))return e.toLocaleString("pt-BR",{hour12:!1})}return String(t).toUpperCase()},onHeaderCell:()=>({draggable:!0,onDragStart:t=>{t.dataTransfer.setData("text/plain",e)},onDragOver:e=>{e.preventDefault()},onDrop:t=>{const a=t.dataTransfer.getData("text/plain"),n=e;a&&a!==n&&$(e=>{const t=e.filter(e=>e!==a),r=t.indexOf(n);if(-1===r)return e;t.splice(r,0,a);const s=`tenants.columns.order.${L?.usuario||"default"}`;return localStorage.setItem(s,JSON.stringify(t)),t})}})};return"IdTenant"===e&&(t.defaultSortOrder="descend"),t}),J=[{title:"DB",dataIndex:"__db__",onCell:()=>({title:"Estado do DSN do Tenant"}),render:e=>e?n.jsx(I,{color:"green",children:"CRIADO"}):n.jsx(I,{children:"NAO CRIADO"})},{title:"DB CRIADO",dataIndex:"__db_created_at__",render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—"},{title:"AÇÕES",dataIndex:"__actions__",render:(r,s)=>n.jsxs(g,{children:[n.jsx(x,{type:"text",onClick:()=>{f(s),S(!0)},children:"EDITAR"}),n.jsx(x,{type:"text",danger:!0,onClick:()=>{M({open:!0,record:s})},children:"DELETAR"}),n.jsx(x,{type:"text",onClick:async()=>{try{const t=((await e.listTenantParametros(s.IdTenant)).rows||[]).find(e=>"DB_DSN"===String(e.Chave||e.chave).toUpperCase());U(t?String(t.Valor||t.valor):"—"),w(!0)}catch{U("—"),w(!0)}},children:"VER DSN"}),s.__db__?n.jsx(x,{danger:!0,onClick:()=>{a.confirm({title:"Deseja realmente apagar o banco e recriá-lo?",okText:"Sobrescrever",okButtonProps:{danger:!0},cancelText:"Cancelar",onOk:async()=>{try{const a=String(s.Slug||"").toLowerCase(),n=await e.recreateTenantDb(a);t.success(`Banco recriado: ${n.dsn}`),await V()}catch(a){t.error(a?.response?.data?.detail||"Erro ao sobrescrever banco")}}})},children:"SOBRESCREVER O BANCO DE DADOS"}):n.jsx(x,{type:"primary",onClick:()=>{const e=s.IdTenant,t=String(s.Slug||"").toLowerCase(),a=String(s.Nome||""),n=`captar_t${String(e).padStart(2,"0")}_${t}`;O({nome:a,slug:t,db_name:n,db_host:"postgres",db_port:"5432",db_user:"captar",db_password:"captar"}),D(!0)},children:"CRIAR BANCO DE DADOS"})]})}],G=(F.length?F:q.map(e=>e.dataIndex)).map(e=>q.find(t=>t.dataIndex===e)).filter(Boolean).filter(e=>P[e.dataIndex]).concat(J);return n.jsxs(r.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[n.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:n.jsxs(g,{children:[n.jsx(C,{placement:"bottomRight",trigger:["click"],menu:{items:[]},popupRender:()=>n.jsx("div",{style:{padding:12},children:Object.keys(P).map(e=>n.jsx("div",{style:{marginBottom:6},children:n.jsx(b,{checked:!!P[e],onChange:t=>{const a={...P,[e]:t.target.checked};k(a);const n=`tenants.columns.visible.${L?.usuario||"default"}`;localStorage.setItem(n,JSON.stringify(a))},children:e.toUpperCase()})},e))}),children:n.jsx(x,{shape:"circle",style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},title:"VISUALIZAÇÃO DE COLUNAS"})}),n.jsx(x,{shape:"circle",style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},onClick:()=>{f(null),S(!0)},title:"NOVO TENANT"})]})}),n.jsx("style",{children:"\n        .tenants-table .ant-table-thead > tr > th{ background:#FFD700; color:#000; font-family: 'Arimo', Arial, sans-serif; }\n        .tenants-table .ant-table-thead > tr > th .ant-table-column-title{ display:flex; justify-content:center; align-items:center; text-align:center; }\n        .tenants-table .ant-table-tbody > tr > td{ font-family: 'Roboto Condensed', Arial, sans-serif; padding:2px 6px; line-height:0.95; height:22px; }\n      "}),n.jsx(T,{rowKey:e=>e.IdTenant||JSON.stringify(e),loading:c,dataSource:i,columns:G,bordered:!0,size:"small",className:"ant-table-striped tenants-table"}),n.jsx(N,{open:m,initial:h||void 0,onCancel:()=>S(!1),onSaved:async()=>{S(!1),await V()}}),n.jsx(A,{open:y,initial:_,onCancel:()=>D(!1),onSaved:async()=>{D(!1),await V()}}),n.jsx(v,{open:E,dsn:R,onCancel:()=>w(!1)}),n.jsxs(u,{open:B.open,title:"Apagar Tenant",onCancel:()=>M({open:!1}),footer:null,children:[n.jsx("div",{style:{marginBottom:12},children:"Esta ação pode remover o tenant e opcionalmente o seu banco de dados. Escolha a opção desejada."}),n.jsxs(g,{children:[n.jsx(x,{onClick:()=>M({open:!1}),children:"Cancelar"}),n.jsx(x,{danger:!0,onClick:async()=>{try{const a=B.record;if(!a)return;await e.deleteTenant(Number(a.IdTenant)),d(e=>e.filter(e=>Number(e.IdTenant)!==Number(a.IdTenant))),t.success("Tenant apagado (banco mantido)"),M({open:!1}),await V()}catch(a){t.error(a?.response?.data?.detail||"Erro ao deletar tenant")}},children:"DELETAR SOMENTE O TENANT E MANTER O BANCO DE DADOS"}),n.jsx(x,{danger:!0,type:"primary",onClick:async()=>{try{const a=B.record;if(!a)return;const n=String(a.Slug||"").toLowerCase();await e.deleteTenantAndDb(n),d(e=>e.filter(e=>Number(e.IdTenant)!==Number(a.IdTenant))),t.success("Tenant e banco apagados"),M({open:!1}),await V()}catch(a){t.error(a?.response?.data?.detail||"Erro ao deletar tenant e banco")}},children:"DELETAR TENANT E BANCO DE DADOS"})]})]})]})}export{D as default};
