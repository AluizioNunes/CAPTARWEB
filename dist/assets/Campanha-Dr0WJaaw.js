import{p as e,i as t,g as a,j as s,m as o}from"./utils-CdldNp8C.js";import{r as n}from"./react-vendor-qiAl16-a.js";import{u as i,a as r,p as l,L as c}from"./index-Di9gGO82.js";import{F as d,s as m,m as u,i as p,C as h,I as g,f,a0 as x,S,p as j,U as v,a1 as A,G as y,b,c as O,B as I,V as C,w as E,x as N,A as _,l as w,T as M,u as R,K as T,N as D,a2 as $,a3 as z,a4 as H,a5 as k,a6 as L,W as F,a7 as P,a8 as U,_ as V,$ as q,a9 as B,aa as W,ab as G,ac as J,ad as Y,D as X,v as K}from"./ui-vendor-W3kvUvq_.js";function Z({open:o,initial:w,onCancel:M,onSaved:R}){const[T]=d.useForm(),[D,$]=m.useMessage(),[z,H]=n.useState("eleitores"),[k,L]=n.useState([]),[F,P]=n.useState([]),[U,V]=n.useState("bottom"),[q,B]=n.useState("nenhum"),[W,G]=n.useState(""),[J,Y]=n.useState(!1),X=i(),{user:K}=r(),[Z,Q]=n.useState(0),[ee,te]=n.useState(0),[ae,se]=n.useState(0),[oe,ne]=n.useState(0),[ie,re]=n.useState(0),[le,ce]=n.useState(0),de=n.useMemo(()=>{const a=K?.login_time;if(!a)return null;const s=e(a);if(t(s))return s;const o=new Date(a);return isNaN(o.getTime())?null:o},[K]),[me,ue]=n.useState(""),pe=de?a(de,"dd/MM/yyyy HH:mm",{locale:l}):"",he=String(localStorage.getItem("tenantSlug")||"captar"),ge=String(localStorage.getItem("tenantName")||"CAPTAR"),fe=e=>{const t=String(e||"").trim();if(!t)return"";if(/^data:image\//i.test(t)&&/;base64,/i.test(t)){const e=t.split(/;base64,/i)[1]?.trim()||"";return e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://")||e.startsWith("static/")?e.startsWith("static/")?`/${e}`:e:t}return t.startsWith("data:")||t.startsWith("http://")||t.startsWith("https://")||t.startsWith("/static/")?t:t.startsWith("static/")?`/${t}`:t.startsWith("/")?t:/\.(png|jpg|jpeg|bmp|gif|webp)$/i.test(t)?`/static/campanhas/${t}`:t.includes("/")&&!t.startsWith("/")?`/${t}`:`data:image/png;base64,${t}`};n.useEffect(()=>{const e=()=>{if(!de)return void ue("");const e=Date.now()-de.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),s=Math.floor(e%6e4/1e3),o=String(t).padStart(2,"0"),n=String(a).padStart(2,"0"),i=String(s).padStart(2,"0");ue(`${o}:${n}:${i}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[de]),n.useEffect(()=>{if(o)if(w){T.setFieldsValue({...w,data_inicio:w.data_inicio?u(w.data_inicio):void 0,data_fim:w.data_fim?u(w.data_fim):void 0}),Y(!!w.recorrencia_ativa),P(w?.imagem?[{uid:"-1",name:"imagem",status:"done",url:fe(w.imagem)}]:[]);const e=w?.conteudo_arquivo||w?.AnexoJSON;let t=null;if(e)try{t="string"==typeof e?JSON.parse(e):e,!Array.isArray(t)&&t?.config&&(V(t.config.text_position||"bottom"),B("SIM_NAO"===t.config.response_mode?"sim_nao":"nenhum"),G(String(t.config.question||"")))}catch{}const a=!(!t||Array.isArray(t)||!0!==t?.usar_eleitores&&"eleitores"!==String(t?.source||"").toLowerCase());H(a?"eleitores":e?"arquivo":"eleitores"),Q(w.meta||0),te(w.enviados||0),se(w.nao_enviados||0),ne(w.positivos||0),re(w.negativos||0);const s=(w.enviados||0)-((w.positivos||0)+(w.negativos||0));ce(void 0!==w.aguardando?w.aguardando:s>0?s:0)}else T.resetFields(),T.setFieldsValue({recorrencia_ativa:!1,total_blocos:5,mensagens_por_bloco:500,blocos_por_dia:1,intervalo_min_seg:5,intervalo_max_seg:120,bloco_atual:0}),H("eleitores"),L([]),P([]),V("bottom"),B("nenhum"),G(""),Y(!1),Q(0),te(0),se(0),ne(0),re(0),ce(0)},[o,w]),n.useEffect(()=>{(async()=>{if("eleitores"===z)try{const e=await X.getDashboardStats();Q(e.totalEleitores||0)}catch(e){console.error("Erro ao buscar total de eleitores",e)}else if("arquivo"===z&&k.length>0){const e=k[0].originFileObj;if(e)if(e.name.endsWith(".json"))try{const t=await e.text(),a=JSON.parse(t);if(Array.isArray(a)&&(Q(a.length),a.length>0)){Object.keys(a[0]).map(e=>e.toLowerCase()).includes("whatsapp")||D.warning('Atenção: O arquivo JSON não contém a chave "whatsapp".')}}catch{}else if(e.name.endsWith(".csv"))try{const t=(await e.text()).split("\n").filter(e=>e.trim().length>0);if(t.length>0){t[0].toLowerCase().includes("whatsapp")||D.warning('Atenção: O arquivo CSV não contém a coluna "whatsapp".'),Q(Math.max(0,t.length-1))}else Q(0)}catch{}}})()},[z,k,X]);return s.jsxs(s.Fragment,{children:[$,s.jsxs(p,{open:o,title:s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("img",{src:c,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),s.jsxs("div",{style:{fontSize:12},children:["TENANT: ",s.jsx("strong",{style:{color:"#333"},children:String(ge||he).toUpperCase()})]})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[s.jsxs("div",{style:{textAlign:"right"},children:[s.jsx("div",{style:{fontWeight:700},children:K?.usuario?String(K?.usuario).toUpperCase():String(K?.nome||"").toUpperCase()||"USUÁRIO"}),s.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(K?.funcao||"").toUpperCase()} | PERFIL: ${String(K?.perfil||"").toUpperCase()}`}),s.jsx("div",{style:{fontSize:12},children:`LOGIN: ${pe||"--"} | TEMPO CONECTADO: ${me||"--:--:--"}`})]}),s.jsx(_,{size:"large"})]})]}),onCancel:M,footer:null,destroyOnHidden:!0,width:980,closable:!1,maskClosable:!1,className:"campanhas-modal",children:[s.jsx("style",{children:".campanhas-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .campanhas-modal .ant-modal-content{ border-radius: 0 !important; } .campanhas-modal .ant-form-item{ margin-bottom:6px; }"}),s.jsxs(d,{form:T,layout:"vertical",children:[s.jsxs(h,{title:"DADOS DA CAMPANHA",size:"small",children:[s.jsx(d.Item,{name:"nome",label:"NOME DA CAMPANHA",rules:[{required:!0,message:"Informe o nome"}],getValueFromEvent:e=>{const t=e?.target?.value;return"string"==typeof t?t.toUpperCase():t},children:s.jsx(g,{prefix:s.jsx(f,{}),placeholder:"Ex: CAMPANHA DE DOAÇÃO"})}),s.jsx(d.Item,{label:"TIPO DE ENVIO",children:s.jsxs(x.Group,{value:q,onChange:e=>B(e.target.value),children:[s.jsx(x.Button,{value:"nenhum",children:"MENSAGEM"}),s.jsx(x.Button,{value:"sim_nao",children:"PERGUNTA SIM / NÃO"})]})}),"sim_nao"===q&&s.jsx(d.Item,{label:"PERGUNTA (SIM/NÃO)",children:s.jsx(g,{value:W,onChange:e=>G(String(e.target.value||"").toUpperCase()),placeholder:"Ex: VOCÊ APOIA NOSSO PROJETO?"})}),s.jsx(d.Item,{name:"descricao",label:"DESCRIÇÃO / MENSAGEM",rules:[{whitespace:!0,message:"Mensagem inválida"}],extra:s.jsxs("div",{style:{fontSize:10,color:"#666"},children:["Dica: Use ",s.jsx("strong",{children:"(NOME)"})," ou ",s.jsx("strong",{children:"{NOME}"})," para substituir pelo nome do contato.",s.jsx("br",{}),'Certifique-se que seu arquivo contém uma coluna chamada "Nome", "Name", "Cliente" ou "Full Name".']}),children:s.jsx(g.TextArea,{rows:4,placeholder:"Texto da mensagem que será enviada"})}),s.jsxs(S,{style:{display:"flex",marginBottom:8},align:"start",children:[s.jsx(d.Item,{name:"data_inicio",label:"DATA INÍCIO",rules:[{required:!0}],children:s.jsx(j,{style:{width:150},format:"DD/MM/YYYY"})}),s.jsx(d.Item,{name:"data_fim",label:"DATA FIM",children:s.jsx(j,{style:{width:150},format:"DD/MM/YYYY"})})]}),s.jsx(d.Item,{label:"IMAGEM DA MENSAGEM",children:s.jsxs("div",{style:{display:"flex",gap:16,alignItems:"flex-start"},children:[s.jsx(v,{listType:"picture-card",maxCount:1,fileList:F,onChange:({fileList:e})=>P(e),beforeUpload:()=>!1,accept:"image/*",children:F.length<1&&s.jsxs("div",{children:[s.jsx(A,{}),s.jsx("div",{style:{marginTop:8},children:"Upload"})]})}),F.length>0&&s.jsxs(d.Item,{label:"POSIÇÃO DO TEXTO EM RELAÇÃO À IMAGEM",style:{marginBottom:0},children:[s.jsxs(x.Group,{value:U,onChange:e=>V(e.target.value),children:[s.jsx(x.Button,{value:"top",children:"TEXTO ANTES (MENSAGEM SEPARADA)"}),s.jsx(x.Button,{value:"bottom",children:"TEXTO DEPOIS (LEGENDA)"})]}),s.jsx("div",{style:{fontSize:10,color:"#999",marginTop:4},children:"top"===U?"Envia texto primeiro, depois imagem.":"Envia imagem com o texto como legenda."})]})]})})]}),s.jsxs(h,{title:"RECORRÊNCIA / BLOCOS",size:"small",style:{marginTop:16},children:[s.jsx(d.Item,{name:"recorrencia_ativa",label:"ATIVAR RECORRÊNCIA",initialValue:!1,children:s.jsxs(x.Group,{value:J,onChange:e=>{Y(!!e.target.value),T.setFieldsValue({recorrencia_ativa:!!e.target.value})},children:[s.jsx(x.Button,{value:!1,children:"NÃO"}),s.jsx(x.Button,{value:!0,children:"SIM"})]})}),s.jsxs(S,{style:{display:"flex",marginBottom:8},align:"start",wrap:!0,children:[s.jsx(d.Item,{name:"total_blocos",label:"TOTAL DE BLOCOS",rules:J?[{required:!0}]:void 0,children:s.jsx(y,{min:1,max:999,style:{width:160}})}),s.jsx(d.Item,{name:"mensagens_por_bloco",label:"MENSAGENS POR BLOCO",rules:J?[{required:!0}]:void 0,children:s.jsx(y,{min:1,max:5e3,style:{width:200}})}),s.jsx(d.Item,{name:"blocos_por_dia",label:"BLOCOS POR DIA",rules:J?[{required:!0}]:void 0,children:s.jsx(y,{min:1,max:24,style:{width:160}})})]}),s.jsxs(S,{style:{display:"flex",marginBottom:8},align:"start",wrap:!0,children:[s.jsx(d.Item,{name:"intervalo_min_seg",label:"INTERVALO MÍNIMO (SEG)",rules:J?[{required:!0}]:void 0,children:s.jsx(y,{min:1,max:3600,style:{width:200}})}),s.jsx(d.Item,{name:"intervalo_max_seg",label:"INTERVALO MÁXIMO (SEG)",rules:J?[{required:!0}]:void 0,children:s.jsx(y,{min:1,max:3600,style:{width:200}})}),s.jsx(d.Item,{name:"bloco_atual",label:"BLOCO ATUAL",children:s.jsx(y,{min:0,max:999,style:{width:160}})})]})]}),s.jsxs(h,{title:"DESTINATÁRIOS",size:"small",style:{marginTop:16},children:[s.jsx(d.Item,{label:"SELECIONE A ORIGEM DOS CONTATOS",children:s.jsxs(x.Group,{value:z,onChange:e=>H(e.target.value),children:[s.jsxs(x.Button,{value:"eleitores",children:[s.jsx(b,{})," BASE DE ELEITORES"]}),s.jsxs(x.Button,{value:"arquivo",children:[s.jsx(O,{})," IMPORTAR ARQUIVO"]})]})}),"arquivo"===z&&s.jsxs(d.Item,{label:"ARQUIVO DE CONTATOS (JSON, CSV, XLS, PDF)",required:!0,children:[s.jsx(v,{maxCount:1,fileList:k,onChange:({fileList:e})=>L(e),beforeUpload:()=>!1,accept:".json,.csv,.xls,.xlsx,.pdf",children:s.jsx(I,{icon:s.jsx(C,{}),children:"Selecionar Arquivo"})}),s.jsxs("div",{style:{marginTop:8,color:"#666",fontSize:"12px"},children:["JSON: O conteúdo será salvo no banco.",s.jsx("br",{}),"Outros: O arquivo será anexado."]})]})]}),s.jsxs(S,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[s.jsx(I,{onClick:M,icon:s.jsx(E,{}),children:"CANCELAR"}),s.jsx(I,{type:"primary",onClick:async()=>{try{const t=await T.validateFields();if("sim_nao"===q&&!String(W||"").trim())return void D.error("Informe a pergunta (SIM/NÃO)");if(t.recorrencia_ativa){const e=Number(t.intervalo_min_seg),a=Number(t.intervalo_max_seg);if(!Number.isFinite(e)||!Number.isFinite(a)||e<=0||a<=0)return void D.error("Informe os intervalos mínimo e máximo em segundos");if(e>a)return void D.error("Intervalo mínimo não pode ser maior que o máximo")}const a=e=>new Promise((t,a)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>t(s.result),s.onerror=e=>a(e)}),s={...t,data_inicio:t.data_inicio?t.data_inicio.format("YYYY-MM-DD"):null,data_fim:t.data_fim?t.data_fim.format("YYYY-MM-DD"):null,meta:Z,enviados:ee,nao_enviados:ae,positivos:oe,negativos:ie,aguardando:le};if(F.length>0){const e=F[0].originFileObj;e&&(s.imagem=await a(e))}else w?.imagem&&(s.imagem=null);let o=null;const n={text_position:U};if("sim_nao"===q&&(n.response_mode="SIM_NAO",n.question=String(W||"").trim()),"arquivo"===z&&k.length>0){const t=k[0].originFileObj;if(t&&(s.AnexoFile=t,s.anexo_json=JSON.stringify({contacts:[],config:n}),t.name.endsWith(".json"))){const a=await t.text();try{const e=JSON.parse(a);o={contacts:Array.isArray(e)?e:[],config:n},s.anexo_json=JSON.stringify(o)}catch(e){return void D.error("Arquivo JSON inválido")}}}else"eleitores"===z&&(s.usar_eleitores=!0,o={source:"eleitores",usar_eleitores:!0,contacts:[],config:n},s.anexo_json=JSON.stringify(o));let i;if(w?.id)await X.updateCampanha(w.id,s),i=w.id,D.success("Campanha atualizada");else{i=(await X.createCampanha(s)).id,D.success("Campanha criada")}"arquivo"===z&&s.AnexoFile&&await X.uploadCampanhaAnexo(i,{file:s.AnexoFile,type:"anexo"}),R()}catch(e){D.error(e?.response?.data?.detail||"Erro ao salvar campanha")}},icon:s.jsx(N,{}),children:"SALVAR"})]})]})]})]})}function Q(){const[e,t]=n.useState([]),[a,l]=n.useState(!1),[c,d]=n.useState(!1),[m,p]=n.useState(null),[g,f]=n.useState([]),[x,j]=n.useState({}),[v,A]=n.useState([]),[y,O]=n.useState([]),[C,E]=n.useState([]),[N,_]=n.useState([]),Q=i(),{user:ee}=r(),{message:te,modal:ae}=w.useApp(),se=e=>{const t=String(e||"").trim();if(!t)return"";if(/^data:image\//i.test(t)&&/;base64,/i.test(t)){const e=t.split(/;base64,/i)[1]?.trim()||"";return e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://")||e.startsWith("static/")?e.startsWith("static/")?`/${e}`:e:t}return t.startsWith("data:")||t.startsWith("http://")||t.startsWith("https://")||t.startsWith("/static/")?t:t.startsWith("static/")?`/${t}`:t.startsWith("/")?t:/\.(png|jpg|jpeg|bmp|gif|webp)$/i.test(t)?`/static/campanhas/${t}`:t.includes("/")&&!t.startsWith("/")?`/${t}`:`data:image/png;base64,${t}`},oe=n.useMemo(()=>1!==y.length?null:e.find(e=>e.id===y[0]),[y,e]);n.useEffect(()=>{if(oe){E([`[${u().format("HH:mm:ss")}] Sistema pronto. Aguardando início do disparo.`]);let t=[],a={};const s=e=>{const t=String(e??"").trim();if(!t)return null;if("1"===t||"2"===t)return Number(t);const a=t.toLowerCase();return/\bsim\b/.test(a)||"s"===a?1:/\bnao\b/.test(a)||/\bnão\b/.test(a)||"n"===a?2:/^\(?\s*1\b/.test(a)?1:/^\(?\s*2\b/.test(a)?2:null},o=(e,t)=>{if(!e)return"";const a=Object.keys(e);for(const s of t){const t=a.find(e=>e.trim().toLowerCase()===s.trim().toLowerCase());if(t&&e[t])return e[t]}return""};if(oe.conteudo_arquivo)try{const e=JSON.parse(oe.conteudo_arquivo);Array.isArray(e)?t=e:e.contacts&&Array.isArray(e.contacts)&&(t=e.contacts,a=e.config||{}),t.length>0&&(t=t.map((e,t)=>{const a=o(e,["whatsapp","celular","telefone","phone","mobile","tel"]),n=o(e,["nome","name","cliente","full_name","fullname"])||`Contato ${t+1}`,i=o(e,["resposta","response","respondido","reply"]),r=s(i);return{id:t,nome:n,whatsapp:a,status:e.status||"waiting",resposta:r,original:e}}).filter(e=>e.whatsapp),0===t.length&&E(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO: Nenhum contato com 'whatsapp' encontrado.`]))}catch(e){console.error("Erro ao fazer parse do conteudo_arquivo",e),E(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO: Não foi possível ler o arquivo de contatos.`])}else oe.usar_eleitores&&(E(e=>[...e,`[${u().format("HH:mm:ss")}] INFO: Esta campanha utiliza a base de Eleitores. Visualização individual não carregada para performance.`]),t=[]);0!==t.length||oe.usar_eleitores||E(e=>[...e,`[${u().format("HH:mm:ss")}] AVISO: Nenhum contato válido encontrado no arquivo.`]),_(t),oe._config=a}else E([]),_([])},[oe?.id,oe?.conteudo_arquivo]);const ne=n.useMemo(()=>{if(!oe)return!1;const e=oe.data_inicio,t=oe.data_fim;if(!e)return!1;const a=u(),s=u(e),o=u(t||"2100-01-01");return a.isAfter(s.startOf("day"))&&a.isBefore(o.endOf("day"))||a.isSame(s,"day")||a.isSame(o,"day")},[oe]),ie=n.useMemo(()=>{if(!oe)return!1;const e=oe._config||{};return"SIM_NAO"===String(e.response_mode||"").toUpperCase()},[oe]),re=()=>s.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:[s.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z",fill:"currentColor"}),s.jsx("path",{d:"M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",fill:"currentColor"})]}),le=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M6 7h12M9 7v10m6-10v10M4 7h16l-1 14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),ce=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M3 4h6v16H3V4zm12 0h6v16h-6V4z",fill:"currentColor"})}),de=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),me=e=>{if(!e)return{label:"-",color:"default"};const t=u().startOf("day"),a=e.data_inicio?u(e.data_inicio).startOf("day"):null,s=e.data_fim?u(e.data_fim).endOf("day"):null;let o=!1;const n=e.status;return!0!==n&&"true"!==n&&"TRUE"!==n&&"1"!==n&&1!==n&&"ATIVO"!==String(n).toUpperCase()||(o=!0),!1!==n&&"false"!==n&&"FALSE"!==n&&"0"!==n&&0!==n&&"INATIVO"!==String(n).toUpperCase()||(o=!1),o?a&&t.isBefore(a)?{label:"AGENDADO",color:"blue"}:s&&t.isAfter(s)?{label:"INATIVO",color:"red"}:{label:"ATIVO",color:"green"}:{label:"INATIVO",color:"red"}},ue=async()=>{try{l(!0);const e=await Q.getCampanhasSchema(),a=["id","nome","status","meta","enviados","aguardando","data_inicio","data_fim","created_at"],s={};for(const t of e.columns||[])s[t.name]=t;const o=a.filter(e=>s[e]).map(e=>s[e]),n=(e.columns||[]).filter(e=>!a.includes(e.name));f([...o,...n]);const i=(await Q.getCampanhas()).rows||[];t(i);const r={};for(const t of a)s[t]&&(r[t]=!0);for(const t of n)r[t.name]=!1;const c=`campanhas.columns.visible.${ee?.usuario||"default"}`,d=localStorage.getItem(c);j(d?JSON.parse(d):r);const m=`campanhas.columns.order.${ee?.usuario||"default"}`,u=localStorage.getItem(m);A(u?JSON.parse(u):a.filter(e=>s[e]))}catch(e){te.error(e?.response?.data?.detail||"Erro ao carregar campanhas")}finally{l(!1)}};n.useEffect(()=>{ue()},[]);const pe=g.map(t=>{const a=t.name,o=Array.from(new Set((e||[]).map(e=>e[a]).filter(e=>null!=e))).slice(0,20).map(e=>({text:String(e).toUpperCase(),value:String(e).toUpperCase()})),n=(t.type||"").toLowerCase(),i=new Set(["id","status","data_inicio","data_fim","created_at"]);return{title:{id:"ID",nome:"NOME DA CAMPANHA",descricao:"DESCRIÇÃO",status:"STATUS",data_inicio:"INÍCIO",data_fim:"FIM",meta:"META",enviados:"ENVIADOS",nao_enviados:"NÃO ENVIADOS",positivos:"RESPOSTAS POSITIVAS",negativos:"RESPOSTAS NEGATIVAS",aguardando:"AGUARDANDO RESPOSTAS",created_at:"CRIADO EM"}[a]||a.toUpperCase(),dataIndex:a,align:i.has(a)?"center":"left",filters:o,onFilter:(e,t)=>String(t[a]).toUpperCase()===String(e).toUpperCase(),sorter:(e,t)=>{const s=e[a],o=t[a];return null==s?-1:null==o?1:n.includes("int")||n.includes("numeric")||n.includes("decimal")?Number(s)-Number(o):n.includes("date")||n.includes("timestamp")?new Date(s).getTime()-new Date(o).getTime():String(s).toUpperCase().localeCompare(String(o).toUpperCase())},render:(e,t)=>{if(null==e)return"";if(n.includes("date")||n.includes("timestamp")){const t=new Date(e);if(!isNaN(t.getTime()))return t.toLocaleDateString("pt-BR")}if("status"===a){const{label:e,color:a}=me(t);return s.jsx(M,{color:a,children:e})}return String(e).toUpperCase()},onHeaderCell:()=>({draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain",a)},onDragOver:e=>{e.preventDefault()},onDrop:e=>{const t=e.dataTransfer.getData("text/plain"),s=a;t&&t!==s&&A(e=>{const a=e.filter(e=>e!==t),o=a.indexOf(s);if(-1===o)return e;a.splice(o,0,t);const n=`campanhas.columns.order.${ee?.usuario||"default"}`;return localStorage.setItem(n,JSON.stringify(a)),a})}})}}),he={title:"AÇÕES",dataIndex:"__actions__",align:"center",render:(e,t)=>s.jsxs(S,{children:[s.jsx(I,{type:"text",icon:s.jsx(re,{}),title:"EDITAR",onClick:()=>{p(t),d(!0)}}),s.jsx(I,{type:"text",danger:!0,icon:s.jsx(le,{}),title:"DELETAR",onClick:async()=>{try{if(!t.id)return void te.info("REGISTRO SEM ID");await Q.deleteCampanha(t.id),te.success("CAMPANHA DELETADA"),await ue()}catch(e){te.error(e?.response?.data?.detail||"ERRO AO DELETAR CAMPANHA")}}})]})},ge=(v.length?v:pe.map(e=>e.dataIndex)).map(e=>pe.find(t=>t.dataIndex===e)).filter(Boolean).filter(e=>x[e.dataIndex]).concat([he]),fe=s.jsx("div",{style:{padding:12},children:g.map(e=>s.jsx("div",{style:{marginBottom:6},children:s.jsx(R,{checked:!!x[e.name],onChange:t=>{const a={...x,[e.name]:t.target.checked};j(a);const s=`campanhas.columns.visible.${ee?.usuario||"default"}`;localStorage.setItem(s,JSON.stringify(a))},children:e.name.toUpperCase()})},e.name))});return s.jsxs(o.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[s.jsx(h,{size:"small",style:{marginBottom:16,background:"#fafafa"},styles:{body:{padding:"12px"}},children:s.jsxs(T,{gutter:16,align:"middle",children:[s.jsx(D,{span:16,children:s.jsxs(T,{gutter:8,wrap:!1,children:[s.jsx(D,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f0f5ff",borderColor:"#adc6ff"},children:s.jsx($,{title:"META",value:oe?.meta||0,valueStyle:{color:"#2f54eb",fontSize:"18px"},prefix:s.jsx(b,{})})})}),s.jsx(D,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fff0f6",borderColor:"#ffadd2"},children:s.jsx($,{title:"DISPAROS",value:(oe?.enviados||0)+(oe?.nao_enviados||0),valueStyle:{color:"#eb2f96",fontSize:"18px"},prefix:s.jsx(z,{})})})}),s.jsx(D,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f6ffed",borderColor:"#b7eb8f"},children:s.jsx($,{title:"ENVIADOS",value:oe?.enviados||0,valueStyle:{color:"#3f8600",fontSize:"18px"},prefix:s.jsx(H,{})})})}),s.jsx(D,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fff1f0",borderColor:"#ffa39e"},children:s.jsx($,{title:"NÃO ENV.",value:oe?.nao_enviados||0,valueStyle:{color:"#cf1322",fontSize:"18px"},prefix:s.jsx(k,{})})})}),s.jsx(D,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#e6f7ff",borderColor:"#91d5ff"},children:s.jsx($,{title:"RESPOSTAS POSITIVAS",value:oe?.positivos||0,valueStyle:{color:"#096dd9",fontSize:"18px"}})})}),s.jsx(D,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fffbe6",borderColor:"#ffe58f"},children:s.jsx($,{title:"RESPOSTAS NEGATIVAS",value:oe?.negativos||0,valueStyle:{color:"#d48806",fontSize:"18px"}})})}),s.jsx(D,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f9f0ff",borderColor:"#d3adf7"},children:s.jsx($,{title:"AGUARDANDO RESPOSTAS",value:ie&&oe?.aguardando||0,valueStyle:{color:"#722ed1",fontSize:"18px"},prefix:s.jsx(L,{spin:ie&&(oe?.aguardando||0)>0})})})})]})}),s.jsxs(D,{span:8,style:{display:"flex",alignItems:"center",justifyContent:"space-between",borderLeft:"1px solid #e8e8e8",paddingLeft:16},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[oe?.imagem?s.jsx(F,{src:se(oe.imagem),height:60,width:60,style:{objectFit:"cover",borderRadius:4},alt:"Campanha"}):s.jsx("div",{style:{width:60,height:60,background:"#eee",borderRadius:4,display:"flex",alignItems:"center",justifyContent:"center",color:"#999"},children:s.jsx(P,{style:{fontSize:24}})}),s.jsx("div",{style:{fontSize:12,color:"#666"},children:oe?s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:oe.nome}),s.jsx("br",{}),s.jsx("span",{style:{fontSize:10},children:(()=>{const e=me(oe);return s.jsx(M,{color:e.color,style:{margin:0},children:e.label})})()})]}):s.jsx("span",{children:"Selecione uma campanha"})})]}),s.jsxs("div",{style:{display:"flex",gap:8},children:[s.jsx(U,{title:"Atualizar dados e respostas da campanha",children:s.jsx(I,{onClick:async()=>{if(oe){te.loading({content:"Atualizando...",key:"refresh"});try{await ue(),te.success({content:"Atualizado!",key:"refresh"})}catch{te.error({content:"Erro ao atualizar",key:"refresh"})}}},disabled:!oe,icon:s.jsx(L,{}),children:"ATUALIZAR"})}),s.jsx(U,{title:"Resetar todos os contatos e contadores",children:s.jsx(I,{onClick:()=>{oe&&ae.confirm({title:"RESETAR CAMPANHA",content:'Deseja realmente resetar esta campanha? Todos os contatos voltarão para o status "Aguardando" e os contadores serão zerados (exceto META).',okText:"SIM, RESETAR",cancelText:"CANCELAR",onOk:async()=>{te.loading({content:"Resetando campanha...",key:"reset"});try{const a=N.map(e=>{const t={...e.original,status:"waiting"};return t&&(delete t.resposta,delete t.response,delete t.respondido_em,delete t.respondidoEm,delete t.enviado_em,delete t.enviadoEm),{...e,status:"waiting",original:t}}),s={enviados:0,nao_enviados:0,positivos:0,negativos:0,aguardando:0};let o=a.map(e=>e.original);if(oe.conteudo_arquivo)try{const e=JSON.parse(oe.conteudo_arquivo);!Array.isArray(e)&&e.contacts&&(o={...e,contacts:o})}catch(e){}await Q.updateCampanha(oe.id,{...s,anexo_json:o,status:"ATIVO"}),_(a),t(e=>e.map(e=>e.id===oe.id?{...e,...s,status:"ATIVO"}:e)),E(e=>[...e,`[${u().format("HH:mm:ss")}] CAMPANHA RESETADA.`]),te.success({content:"Campanha resetada com sucesso!",key:"reset"}),await ue()}catch(e){console.error(e),te.error({content:"Erro ao resetar campanha",key:"reset"})}}})},disabled:!oe,icon:s.jsx(V,{}),danger:!0,children:"RESETAR"})}),s.jsx(U,{title:oe?ne?"Iniciar automação":"Fora do período de vigência":"Selecione uma campanha",children:s.jsx(I,{onClick:async()=>{if(oe){te.loading({content:"Iniciando automação...",key:"envio"}),E(e=>[...e,`[${u().format("HH:mm:ss")}] INICIANDO DISPARO DA CAMPANHA: ${oe.nome}`]);try{E(e=>[...e,`[${u().format("HH:mm:ss")}] Verificando conexão com EvolutionAPI...`]);const s=N.filter(e=>"success"!==e.status);E(e=>[...e,`[${u().format("HH:mm:ss")}] Iniciando envio para ${s.length} contatos.`]);let o=[...N],n=0,i=0,r=0;const l=oe.imagem?se(oe.imagem):void 0,c=(()=>{const e=oe.conteudo_arquivo;if(e)try{const t=JSON.parse(e);if(!Array.isArray(t)&&t?.config)return t.config||{}}catch{}return oe._config||{}})(),d="SIM_NAO"===String(c.response_mode||"").toUpperCase(),m=d&&oe.aguardando||0,p=!!oe.recorrencia_ativa,h=Number(oe.total_blocos??5),g=Number(oe.mensagens_por_bloco??500),f=Number(oe.blocos_por_dia??1);let x=Number(oe.bloco_atual??0);const S=Number(oe.intervalo_min_seg??5),j=Number(oe.intervalo_max_seg??120),v=Math.max(1,Math.min(S,j)),A=Math.max(1,Math.max(S,j)),y=p?Math.max(1,Math.floor(g)):Number.POSITIVE_INFINITY;if(p&&Number.isFinite(h)&&x>=h)return E(e=>[...e,`[${u().format("HH:mm:ss")}] RECORRÊNCIA ENCERRADA: blocos concluídos (${x}/${h}).`]),void te.warning({content:"Recorrência já concluiu todos os blocos.",key:"envio"});p&&E(e=>[...e,`[${u().format("HH:mm:ss")}] RECORRÊNCIA ATIVA: bloco ${x+1}/${h}, até ${y} mensagens, intervalo ${v}s-${A}s.`]);let b=0;for(let a=0;a<o.length&&!(b>=y);a++){const s=o[a];if("success"===s.status)continue;b++,E(e=>[...e,`[${u().format("HH:mm:ss")}] Enviando mensagem para ${s.nome} (${s.whatsapp})...`]);const h=s.status;let g=!1,f="";try{let e=String(oe.descricao??"");const t=s.nome||"";if(e=e.replace(/\(NOME\)/gi,t).replace(/\{NOME\}/gi,t).replace(/\(NAME\)/gi,t).replace(/\{NAME\}/gi,t),0===a&&E(t=>[...t,`[${u().format("HH:mm:ss")}] DEBUG: Exemplo de mensagem resolvida: "${e}"`]),d){const t=String(c.question||"").trim(),a=[e.trim()];t&&a.push(t),a.push("RESPONDA:\n1 - SIM\n2 - NÃO"),e=a.filter(Boolean).join("\n\n")}let o=c.text_position||"bottom";if(!e.trim()&&!l)throw new Error("Mensagem vazia");await Q.sendWhatsAppMessage(String(s.whatsapp),e,l,o,{campanha_id:oe.id,contato_nome:s.nome}),g=!0}catch(e){console.error(e),g=!1,f=e.response?.data?.detail||e.message||"Erro desconhecido"}const x=g?(new Date).toISOString():void 0,S={...s.original||{}};g&&x&&(S.enviado_em=x),o[a]={...s,status:g?"success":"error",original:S},g?(n++,"error"===h&&i--,d&&r++):"waiting"===h&&i++,_([...o]),t(e=>e.map(e=>e.id===oe.id?{...e,enviados:(oe.enviados||0)+n,nao_enviados:(oe.nao_enviados||0)+i,aguardando:d?Math.max(0,m+r):0}:e)),E(g?e=>[...e,`[${u().format("HH:mm:ss")}] [SUCESSO] Mensagem entregue para ${s.whatsapp}`]:e=>[...e,`[${u().format("HH:mm:ss")}] [ERRO] Falha ao entregar para ${s.whatsapp}: ${f}`]);const j=p?Math.floor(Math.random()*(A-v+1))+v:1;await new Promise(e=>globalThis.setTimeout(e,1e3*j))}E(e=>[...e,`[${u().format("HH:mm:ss")}] DISPARO FINALIZADO.`]);try{const e=o.map(e=>({...e.original,status:e.status}));let t=e;if(oe.conteudo_arquivo)try{const a=JSON.parse(oe.conteudo_arquivo);!Array.isArray(a)&&a.contacts&&(t={...a,contacts:e})}catch{}const a=p&&b>0,s=a?x+1:x,l=(()=>{if(!p||!a)return;const e=Number.isFinite(f)&&f>0?f:1;if(1===e)return u().add(1,"day").toISOString();const t=Math.max(1,Math.floor(1440/e));return u().add(t,"minute").toISOString()})();await Q.updateCampanha(oe.id,{status:"ATIVO",enviados:(oe.enviados||0)+n,nao_enviados:(oe.nao_enviados||0)+i,aguardando:d?Math.max(0,m+r):0,anexo_json:t,...p?{bloco_atual:s,proxima_execucao:l}:{}}),ue()}catch(a){console.error("Erro ao atualizar status da campanha",a),E(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO AO SALVAR NO BANCO: ${a}`])}te.success({content:"Automação finalizada!",key:"envio"})}catch(s){E(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO CRÍTICO: ${s}`]),te.error({content:"Erro ao iniciar automação",key:"envio"})}}},disabled:!ne,icon:s.jsx(q,{}),type:"primary",style:{background:ne?"#52c41a":void 0,borderColor:ne?"#52c41a":void 0},children:"ENVIAR"})})]})]})]})}),s.jsxs(T,{gutter:16,style:{marginBottom:16},children:[s.jsx(D,{span:6,children:s.jsxs(h,{size:"small",title:"Status dos Contatos",styles:{body:{padding:0,height:400,overflowY:"auto"}},children:[s.jsx(B,{size:"small",dataSource:N,renderItem:e=>s.jsx(B.Item,{style:{padding:"8px 12px"},children:s.jsxs(S,{children:["success"===e.status&&s.jsx(W,{style:{color:"#52c41a"}}),"error"===e.status&&s.jsx(G,{style:{color:"#ff4d4f"}}),"waiting"===e.status&&s.jsx(z,{style:{color:"#faad14"}}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:500},children:e.nome}),s.jsx("div",{style:{fontSize:11,color:"#999"},children:e.whatsapp})]}),1===e.resposta&&s.jsx(M,{color:"green",style:{marginLeft:6},children:"SIM"}),2===e.resposta&&s.jsx(M,{color:"red",style:{marginLeft:6},children:"NÃO"})]})})}),0===N.length&&s.jsx("div",{style:{padding:16,textAlign:"center",color:"#999"},children:oe?"Nenhum contato na lista":"Selecione uma campanha"})]})}),s.jsx(D,{span:8,children:s.jsx(h,{size:"small",title:"Preview da Mensagem",styles:{body:{padding:0,height:400,background:"#e5ddd5",display:"flex",flexDirection:"column"}},children:s.jsx("div",{style:{flex:1,padding:20,overflowY:"auto",backgroundImage:'url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png")',backgroundSize:"contain"},children:oe?s.jsxs("div",{style:{background:"#fff",borderRadius:"0 8px 8px 8px",padding:8,maxWidth:"85%",boxShadow:"0 1px 1px rgba(0,0,0,0.1)"},children:[oe.imagem&&s.jsx(F,{src:se(oe.imagem),style:{width:"100%",borderRadius:8,marginBottom:8},preview:!1}),s.jsx("div",{style:{fontSize:14,lineHeight:"1.4",color:"#303030",whiteSpace:"pre-wrap"},children:(()=>{const e=oe._config||{};let t=String(oe.descricao||"").trim();if("SIM_NAO"===String(e.response_mode||"").toUpperCase()){const a=String(e.question||"").trim(),s=[t];a&&s.push(a),s.push("RESPONDA:\n1 - SIM\n2 - NÃO"),t=s.filter(Boolean).join("\n\n")}return t||"Sem texto"})()}),s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",marginTop:4,gap:4},children:[s.jsx("span",{style:{fontSize:11,color:"#999"},children:u().format("HH:mm")}),s.jsx(W,{style:{fontSize:14,color:"#34b7f1"}})]})]}):s.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",color:"#999",flexDirection:"column",gap:8},children:[s.jsx(J,{style:{fontSize:32}}),s.jsx("span",{children:"Selecione uma campanha para visualizar o preview"})]})})})}),s.jsx(D,{span:10,children:s.jsx(h,{size:"small",title:"Log de Eventos (Caixa Preta)",styles:{body:{padding:12,height:400,background:"#000",color:"#0f0",fontFamily:"monospace",overflowY:"auto"}},children:C.length>0?s.jsx("ul",{style:{listStyle:"none",padding:0,margin:0},children:C.map((e,t)=>s.jsxs("li",{style:{marginBottom:4,borderBottom:"1px solid #333",paddingBottom:2},children:[s.jsx(Y,{style:{fontSize:10,marginRight:8}}),e]},t))}):s.jsx("div",{style:{color:"#666"},children:"Aguardando eventos..."})})})]}),s.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:s.jsxs(S,{children:[s.jsx(X,{placement:"bottomRight",trigger:["click"],menu:{items:[]},popupRender:()=>fe,children:s.jsx(I,{shape:"circle",icon:s.jsx(ce,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},title:"VISUALIZAÇÃO DE COLUNAS"})}),s.jsx(I,{shape:"circle",icon:s.jsx(de,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},onClick:()=>{p(null),d(!0)},title:"NOVA CAMPANHA"})]})}),s.jsx("style",{children:"\n        .campanhas-table .ant-table-thead > tr > th{ background:#FFD700; color:#000; font-family: 'Arimo', Arial, sans-serif; }\n        .campanhas-table .ant-table-thead > tr > th .ant-table-column-title{ display:flex; justify-content:center; align-items:center; text-align:center; }\n        .campanhas-table .ant-table-tbody > tr > td{ font-family: 'Roboto Condensed', Arial, sans-serif; padding:2px 6px; line-height:0.95; height:22px; }\n      "}),s.jsx(K,{loading:a,dataSource:e,columns:ge,rowKey:"id",bordered:!0,size:"small",className:"ant-table-striped campanhas-table",rowSelection:{type:"radio",selectedRowKeys:y,onChange:e=>O(e)},onRow:e=>({onClick:()=>O([e.id])})}),s.jsx(Z,{open:c,initial:m||void 0,onCancel:()=>d(!1),onSaved:async()=>{d(!1),await ue()}})]})}export{Q as default};
