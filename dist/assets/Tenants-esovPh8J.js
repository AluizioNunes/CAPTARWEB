import{p as e,i as t,g as a,j as n,m as r}from"./utils-CdldNp8C.js";import{r as s}from"./react-vendor-qiAl16-a.js";import{u as o,a as l,p as i,L as d}from"./index-CFXHmW6Z.js";import{F as c,i as u,I as g,t as p,S as m,B as _,w as f,x,A as S,l as h,D as b,u as y,v as j,T as C}from"./ui-vendor-W3kvUvq_.js";function D({open:r,initial:h,onCancel:b,onSaved:y}){const[j]=c.useForm(),C=o(),{user:D}=l(),[T,I]=s.useState(""),N=s.useMemo(()=>{const a=D?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const r=new Date(a);return isNaN(r.getTime())?null:r},[D]),A=N?a(N,"dd/MM/yyyy HH:mm",{locale:i}):"",v=String(localStorage.getItem("tenantSlug")||"captar"),O=String(localStorage.getItem("tenantName")||"CAPTAR");s.useEffect(()=>{const e=()=>{if(!N)return void I("");const e=Date.now()-N.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),r=String(t).padStart(2,"0"),s=String(a).padStart(2,"0"),o=String(n).padStart(2,"0");I(`${r}:${s}:${o}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[N]),s.useEffect(()=>{r&&(h?j.setFieldsValue({Nome:h.Nome,Slug:h.Slug,Status:h.Status,Plano:h.Plano}):j.resetFields())},[r,h]);return n.jsxs(u,{open:r,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(O||v).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:D?.usuario?String(D?.usuario).toUpperCase():String(D?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(D?.funcao||"").toUpperCase()} | PERFIL: ${String(D?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${A||"--"} | TEMPO CONECTADO: ${T||"--:--:--"}`})]}),n.jsx(S,{size:"large"})]})]}),onCancel:b,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; } .tenants-modal .ant-form-item{ margin-bottom:6px; }"}),n.jsxs(c,{form:j,layout:"vertical",children:[n.jsx("div",{style:{display:"grid",gap:16},children:n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16},children:[n.jsxs("div",{children:[n.jsx(c.Item,{name:"Nome",label:"Nome",rules:[{required:!0}],children:n.jsx(g,{})}),n.jsx(c.Item,{name:"Slug",label:"Slug",rules:[{required:!0}],children:n.jsx(g,{})})]}),n.jsxs("div",{children:[n.jsx(c.Item,{name:"Status",label:"Status",children:n.jsx(p,{options:[{value:"ATIVO",label:"ATIVO"},{value:"INATIVO",label:"INATIVO"}]})}),n.jsx(c.Item,{name:"Plano",label:"Plano",children:n.jsx(p,{options:[{value:"PADRAO",label:"PADRÃO"},{value:"PRO",label:"PRO"}]})})]})]})}),n.jsxs(m,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(_,{onClick:b,icon:n.jsx(f,{}),children:"CANCELAR"}),n.jsx(_,{type:"primary",onClick:async()=>{try{const e=await j.validateFields();if(h?.IdTenant){await C.updateTenant(h.IdTenant,e);const t={...h,...e,__db__:!!h?.Dsn,__db_created_at__:h?.DbCreatedAt||"",__new__:!1};y(t)}else{const t=(await C.createTenant(e)).id,a=e.Nome,n=String(e.Slug||"").toLowerCase(),r=`captar_t${String(t).padStart(2,"0")}_${n}`;let s="";try{const e=await C.provisionTenant({nome:a,slug:n,db_name:r,db_host:"postgres",db_port:"5432",db_user:"captar",db_password:"captar"});s=String(e?.dsn||""),s&&await C.setTenantDsn(n,s).catch(()=>{}),await C.migrateTenantData(n).catch(()=>{})}catch{}const o={IdTenant:t,Nome:a,Slug:e.Slug,Status:e.Status??"ATIVO",Plano:e.Plano??"PADRAO",Dsn:s,__db__:!!s,__db_created_at__:s?(new Date).toISOString():"",__new__:!0};y(o)}}catch{}},icon:n.jsx(x,{}),children:"SALVAR"})]})]})]})}function T({open:r,initial:p,onCancel:b,onSaved:y}){const[j]=c.useForm(),C=o(),{user:D}=l(),{message:T}=h.useApp(),[I,N]=s.useState(""),A=s.useMemo(()=>{const a=D?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const r=new Date(a);return isNaN(r.getTime())?null:r},[D]),v=A?a(A,"dd/MM/yyyy HH:mm",{locale:i}):"",O=String(localStorage.getItem("tenantSlug")||"captar"),w=String(localStorage.getItem("tenantName")||"CAPTAR");s.useEffect(()=>{r&&(p?j.setFieldsValue(p):j.resetFields())},[r,p]),s.useEffect(()=>{const e=()=>{if(!A)return void N("");const e=Date.now()-A.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),r=String(t).padStart(2,"0"),s=String(a).padStart(2,"0"),o=String(n).padStart(2,"0");N(`${r}:${s}:${o}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[A]);return n.jsxs(u,{open:r,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(w||O).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:D?.usuario?String(D?.usuario).toUpperCase():String(D?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(D?.funcao||"").toUpperCase()} | PERFIL: ${String(D?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${v||"--"} | TEMPO CONECTADO: ${I||"--:--:--"}`})]}),n.jsx(S,{size:"large"})]})]}),onCancel:b,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; } .tenants-modal .ant-form-item{ margin-bottom:6px; }"}),n.jsxs(c,{form:j,layout:"vertical",children:[n.jsx(c.Item,{name:"nome",label:"Nome",rules:[{required:!0}],children:n.jsx(g,{})}),n.jsx(c.Item,{name:"slug",label:"Slug",rules:[{required:!0}],children:n.jsx(g,{})}),n.jsx(c.Item,{name:"db_name",label:"Nome do Banco",rules:[{required:!0}],children:n.jsx(g,{})}),n.jsx(c.Item,{name:"db_host",label:"Host",rules:[{required:!0}],children:n.jsx(g,{})}),n.jsx(c.Item,{name:"db_port",label:"Porta",rules:[{required:!0}],children:n.jsx(g,{})}),n.jsx(c.Item,{name:"db_user",label:"Usuário",rules:[{required:!0}],children:n.jsx(g,{})}),n.jsx(c.Item,{name:"db_password",label:"Senha",rules:[{required:!0}],children:n.jsx(g.Password,{})}),n.jsxs(m,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(_,{onClick:b,icon:n.jsx(f,{}),children:"CANCELAR"}),n.jsx(_,{type:"primary",onClick:async()=>{try{const e=await j.validateFields(),t=await C.provisionTenant(e);T.success(`Banco provisionado: ${t.dsn}`),y({idTenant:t.idTenant,dsn:t.dsn})}catch(e){T.error(e?.response?.data?.detail||"Erro ao provisionar banco")}},icon:n.jsx(x,{}),children:"SALVAR"})]})]})]})}function I({open:r,dsn:o,onCancel:c}){const{user:g}=l(),[p]=s.useState(""),m=s.useMemo(()=>{const a=g?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const r=new Date(a);return isNaN(r.getTime())?null:r},[g]),_=m?a(m,"dd/MM/yyyy HH:mm",{locale:i}):"",f=String(localStorage.getItem("tenantSlug")||"captar"),x=String(localStorage.getItem("tenantName")||"CAPTAR");return n.jsxs(u,{open:r,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(x||f).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:g?.usuario?String(g?.usuario).toUpperCase():String(g?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(g?.funcao||"").toUpperCase()} | PERFIL: ${String(g?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${_||"--"} | TEMPO CONECTADO: ${p||"--:--:--"}`})]}),n.jsx(S,{size:"large"})]})]}),onCancel:c,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; }"}),n.jsx("div",{style:{fontFamily:"monospace"},children:o||"—"})]})}function N(){const e=o(),{message:t,modal:a}=h.useApp(),[i,d]=s.useState([]),[c,g]=s.useState(!1),[p,f]=s.useState(!1),[x,S]=s.useState(null),[N,A]=s.useState(!1),[v,O]=s.useState(void 0),[w,R]=s.useState(!1),[E,U]=s.useState(""),[P,$]=s.useState({}),[k,F]=s.useState([]),{user:L}=l(),[M,B]=s.useState({open:!1}),H=async()=>{try{g(!0);const t=await e.listTenants(),a=(t.rows||[]).map(e=>({...e,__db__:!!e.Dsn,__db_created_at__:e.DbCreatedAt||e.dbCreatedAt||""}));d(e=>{const t=[...(e||[]).filter(e=>e&&e.__new__),...a],n=[],r=new Set;for(const a of t){const e=a.IdTenant?`id:${String(a.IdTenant)}`:`slug:${String(a.Slug||a.slug||"").toUpperCase()}`;r.has(e)||(r.add(e),n.push(a))}return n});const n=["IdTenant","Nome","Slug","Status","Plano","DataCadastro","DataUpdate","__db__","__db_created_at__","__actions__"],r=`tenants.columns.visible.${L?.usuario||"default"}`,s=localStorage.getItem(r),o={};for(const e of n)o[e]=!0;$(s?JSON.parse(s):{...o,__db__:!0,__db_created_at__:!0,__actions__:!0});const l=`tenants.columns.order.${L?.usuario||"default"}`,i=localStorage.getItem(l);F(i?JSON.parse(i):n)}catch(a){t.error(a?.response?.data?.detail||"Erro ao carregar tenants")}finally{g(!1)}};s.useEffect(()=>{H()},[]);const z={IdTenant:"ID",Nome:"NOME",Slug:"SLUG",Status:"STATUS",Plano:"PLANO",DataCadastro:"DATA E HORA DE CADASTRO",DataUpdate:"DATA UPDATE"},V=new Set(["IdTenant","Status","Plano","DataCadastro","DataUpdate"]),q=[...["IdTenant","Nome","Slug","Status","Plano","DataCadastro","DataUpdate"].map(e=>{const t={title:z[e]||e.toUpperCase(),dataIndex:e,align:V.has(e)?"center":"left",sorter:(t,a)=>{const n=t[e],r=a[e];return null==n?-1:null==r?1:"IdTenant"===e?Number(r)-Number(n):e.includes("Data")?new Date(n).getTime()-new Date(r).getTime():String(n).toUpperCase().localeCompare(String(r).toUpperCase())},sortDirections:["ascend","descend"],render:t=>{if(null==t)return"";if(e.includes("Data")){const e=new Date(t);if(!isNaN(e.getTime()))return e.toLocaleString("pt-BR",{hour12:!1})}return String(t).toUpperCase()},onHeaderCell:()=>({draggable:!0,onDragStart:t=>{t.dataTransfer.setData("text/plain",e)},onDragOver:e=>{e.preventDefault()},onDrop:t=>{const a=t.dataTransfer.getData("text/plain"),n=e;a&&a!==n&&F(e=>{const t=e.filter(e=>e!==a),r=t.indexOf(n);if(-1===r)return e;t.splice(r,0,a);const s=`tenants.columns.order.${L?.usuario||"default"}`;return localStorage.setItem(s,JSON.stringify(t)),t})}})};return"IdTenant"===e&&(t.defaultSortOrder="descend"),t}),...[{title:"DB",dataIndex:"__db__",align:"center",sorter:(e,t)=>e.__db__===t.__db__?0:e.__db__?-1:1,sortDirections:["ascend","descend"],onHeaderCell:()=>({draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain","__db__")},onDragOver:e=>{e.preventDefault()},onDrop:e=>{const t=e.dataTransfer.getData("text/plain"),a="__db__";t&&t!==a&&F(e=>{const n=e.filter(e=>e!==t),r=n.indexOf(a);if(-1===r)return e;n.splice(r,0,t);const s=`tenants.columns.order.${L?.usuario||"default"}`;return localStorage.setItem(s,JSON.stringify(n)),n})}}),onCell:()=>({title:"Estado do DSN do Tenant"}),render:e=>e?n.jsx(C,{color:"green",children:"CRIADO"}):n.jsx(C,{children:"NAO CRIADO"})},{title:"DB CRIADO",dataIndex:"__db_created_at__",align:"center",sorter:(e,t)=>{const a=e.__db_created_at__,n=t.__db_created_at__;return a||n?a?n?new Date(a).getTime()-new Date(n).getTime():-1:1:0},sortDirections:["ascend","descend"],onHeaderCell:()=>({draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain","__db_created_at__")},onDragOver:e=>{e.preventDefault()},onDrop:e=>{const t=e.dataTransfer.getData("text/plain"),a="__db_created_at__";t&&t!==a&&F(e=>{const n=e.filter(e=>e!==t),r=n.indexOf(a);if(-1===r)return e;n.splice(r,0,t);const s=`tenants.columns.order.${L?.usuario||"default"}`;return localStorage.setItem(s,JSON.stringify(n)),n})}}),render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—"},{title:"AÇÕES",dataIndex:"__actions__",align:"center",onHeaderCell:()=>({draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain","__actions__")},onDragOver:e=>{e.preventDefault()},onDrop:e=>{const t=e.dataTransfer.getData("text/plain"),a="__actions__";t&&t!==a&&F(e=>{const n=e.filter(e=>e!==t),r=n.indexOf(a);if(-1===r)return e;n.splice(r,0,t);const s=`tenants.columns.order.${L?.usuario||"default"}`;return localStorage.setItem(s,JSON.stringify(n)),n})}}),render:(r,s)=>"captar"===String(s.Slug??s.slug??"").toLowerCase()?n.jsx(C,{color:"geekblue",children:"TENANT PADRÃO DO SISTEMA"}):n.jsxs(m,{children:[n.jsx(_,{type:"text",onClick:()=>{S(s),f(!0)},children:"EDITAR"}),n.jsx(_,{type:"text",danger:!0,onClick:()=>{B({open:!0,record:s})},children:"DELETAR"}),n.jsx(_,{type:"text",onClick:()=>{U(String(s.Dsn||"—")),R(!0)},children:"VER DSN"}),s.__db__?n.jsx(_,{danger:!0,onClick:()=>{a.confirm({title:"Deseja realmente apagar o banco e recriá-lo?",okText:"Sobrescrever",okButtonProps:{danger:!0},cancelText:"Cancelar",onOk:async()=>{try{const a=String(s.Slug||"").toLowerCase(),n=await e.recreateTenantDb(a);t.success(`Banco recriado: ${n.dsn}`),await H()}catch(a){t.error(a?.response?.data?.detail||"Erro ao sobrescrever banco")}}})},children:"SOBRESCREVER O BANCO DE DADOS"}):n.jsx(_,{type:"primary",onClick:()=>{const e=s.IdTenant,t=String(s.Slug||"").toLowerCase(),a=String(s.Nome||""),n=`captar_t${String(e).padStart(2,"0")}_${t}`;O({nome:a,slug:t,db_name:n,db_host:"postgres",db_port:"5432",db_user:"captar",db_password:"captar"}),A(!0)},children:"CRIAR BANCO DE DADOS"})]})}]],J=(k.length?k:q.map(e=>e.dataIndex)).map(e=>q.find(t=>t.dataIndex===e)).filter(Boolean).filter(e=>P[e.dataIndex]);return n.jsxs(r.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[n.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:n.jsxs(m,{children:[n.jsx(b,{placement:"bottomRight",trigger:["click"],menu:{items:[]},popupRender:()=>n.jsx("div",{style:{padding:12},children:Object.keys(P).map(e=>n.jsx("div",{style:{marginBottom:6},children:n.jsx(y,{checked:!!P[e],onChange:t=>{const a={...P,[e]:t.target.checked};$(a);const n=`tenants.columns.visible.${L?.usuario||"default"}`;localStorage.setItem(n,JSON.stringify(a))},children:e.toUpperCase()})},e))}),children:n.jsx(_,{shape:"circle",style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},title:"VISUALIZAÇÃO DE COLUNAS"})}),n.jsx(_,{shape:"circle",style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},onClick:()=>{S(null),f(!0)},title:"NOVO TENANT"})]})}),n.jsx("style",{children:"\n        .tenants-table .ant-table-thead > tr > th{ background:#FFD700; color:#000; font-family: 'Arimo', Arial, sans-serif; }\n        .tenants-table .ant-table-thead > tr > th .ant-table-column-title{ display:flex; justify-content:center; align-items:center; text-align:center; }\n        .tenants-table .ant-table-tbody > tr > td{ font-family: 'Roboto Condensed', Arial, sans-serif; padding:2px 6px; line-height:0.95; height:22px; }\n      "}),n.jsx(j,{rowKey:e=>e.IdTenant||JSON.stringify(e),loading:c,dataSource:i,columns:J,bordered:!0,size:"small",className:"ant-table-striped tenants-table"}),n.jsx(D,{open:p,initial:x||void 0,onCancel:()=>f(!1),onSaved:async e=>{f(!1),S(null);const t={__db__:!1,__db_created_at__:"",...e};d(e=>{const a=(e||[]).filter(e=>Number(e.IdTenant)!==Number(t.IdTenant));return[t,...a]}),window.setTimeout(()=>{H()},t.__new__?1200:0)}}),n.jsx(T,{open:N,initial:v,onCancel:()=>A(!1),onSaved:async()=>{A(!1),await H()}}),n.jsx(I,{open:w,dsn:E,onCancel:()=>R(!1)}),n.jsxs(u,{open:M.open,title:"Apagar Tenant",onCancel:()=>B({open:!1}),footer:null,children:[n.jsx("style",{children:".tenants-delete-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-delete-modal .ant-modal-content{ border-radius: 0 !important; }"}),n.jsx("div",{style:{marginBottom:16,fontSize:14},children:"Esta ação pode remover o tenant e opcionalmente o seu banco de dados."}),n.jsxs(m,{style:{display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(_,{onClick:()=>B({open:!1}),children:"Cancelar"}),n.jsx(_,{danger:!0,style:{borderRadius:20},onClick:async()=>{try{const a=M.record;if(!a)return;await e.deleteTenant(Number(a.IdTenant)),d(e=>e.filter(e=>Number(e.IdTenant)!==Number(a.IdTenant))),t.success("Tenant apagado (banco mantido)"),B({open:!1}),await H()}catch(a){t.error(a?.response?.data?.detail||"Erro ao deletar tenant")}},children:"Deletar somente o tenant (manter banco)"}),n.jsx(_,{danger:!0,type:"primary",style:{borderRadius:20},onClick:async()=>{try{const a=M.record;if(!a)return;const n=String(a.Slug||"").toLowerCase();await e.deleteTenantAndDb(n),d(e=>e.filter(e=>Number(e.IdTenant)!==Number(a.IdTenant))),t.success("Tenant e banco apagados"),B({open:!1}),await H()}catch(a){t.error(a?.response?.data?.detail||"Erro ao deletar tenant e banco")}},children:"Deletar tenant e banco de dados"})]})]})]})}export{N as default};
