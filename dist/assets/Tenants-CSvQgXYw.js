import{j as e,m as a}from"./utils-CdldNp8C.js";import{r as t}from"./react-vendor-qiAl16-a.js";import{u as n}from"./index-qTPmVe1o.js";import{F as s,S as r,B as l,l as i,h as o,I as d,r as c,s as u,T as m}from"./ui-vendor-DfxTKCZ4.js";function x(){const x=n(),[j,p]=t.useState([]),[h,I]=t.useState(!1),[S,T]=t.useState(!1),[y,b]=t.useState(null),[_]=s.useForm(),[N,O]=t.useState(!1),[v]=s.useForm(),[A,g]=t.useState(!1),[w,D]=t.useState(""),C=async()=>{try{I(!0);const e=(await x.listTenants()).rows||[],a=await Promise.all(e.map(async e=>{try{const a=((await x.listTenantParametros(e.IdTenant)).rows||[]).find(e=>"DB_DSN"===String(e.Chave||e.chave).toUpperCase());return{...e,__db__:!!a}}catch{return{...e,__db__:!1}}}));p(a)}catch(e){u.error(e?.response?.data?.detail||"Erro ao carregar tenants")}finally{I(!1)}};t.useEffect(()=>{C()},[]);const f=[{title:"ID",dataIndex:"IdTenant"},{title:"NOME",dataIndex:"Nome"},{title:"SLUG",dataIndex:"Slug"},{title:"STATUS",dataIndex:"Status"},{title:"PLANO",dataIndex:"Plano"},{title:"ATUALIZADO",dataIndex:"DataUpdate"},{title:"DB",dataIndex:"__db__",onCell:e=>({title:"Estado do DSN do Tenant"}),render:a=>a?e.jsx(m,{color:"green",children:"CONFIGURADO"}):e.jsx(m,{children:"NAO CONFIGURADO"})},{title:"AÇÕES",dataIndex:"__actions__",render:(a,t)=>e.jsxs(r,{children:[e.jsx(l,{type:"text",onClick:()=>{b(t),_.setFieldsValue(t),T(!0)},children:"EDITAR"}),e.jsx(l,{type:"text",danger:!0,onClick:async()=>{try{await x.deleteTenant(t.IdTenant),u.success("Tenant deletado"),await C()}catch(e){u.error(e?.response?.data?.detail||"Erro ao deletar")}},children:"DELETAR"}),e.jsx(l,{type:"text",onClick:async()=>{try{const e=((await x.listTenantParametros(t.IdTenant)).rows||[]).find(e=>"DB_DSN"===String(e.Chave||e.chave).toUpperCase());D(e?String(e.Valor||e.valor):"—"),g(!0)}catch{D("—"),g(!0)}},children:"VER DSN"}),e.jsx(l,{type:"primary",onClick:()=>{const e=t.IdTenant,a=String(t.Slug||"").toLowerCase(),n=String(t.Nome||""),s=`captar_t${String(e).padStart(2,"0")}_${a}`;v.setFieldsValue({nome:n,slug:a,db_name:s,db_host:"postgres",db_port:"5432",db_user:"captar",db_password:"captar"}),O(!0)},children:"CRIAR BANCO DE DADOS"})]})}];return e.jsxs(a.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:e.jsx(r,{children:e.jsx(l,{type:"primary",onClick:()=>{b(null),_.resetFields(),T(!0)},children:"NOVO TENANT"})})}),e.jsx(i,{rowKey:e=>e.IdTenant||JSON.stringify(e),loading:h,dataSource:j,columns:f,bordered:!0,size:"middle"}),e.jsx(o,{open:S,title:y?.IdTenant?"Editar Tenant":"Novo Tenant",onCancel:()=>T(!1),onOk:async()=>{try{const e=await _.validateFields();y?.IdTenant?(await x.updateTenant(y.IdTenant,e),u.success("Tenant atualizado")):(await x.createTenant(e),u.success("Tenant criado")),T(!1),b(null),await C()}catch{}},children:e.jsxs(s,{form:_,layout:"vertical",children:[e.jsx(s.Item,{name:"Nome",label:"Nome",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"Slug",label:"Slug",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"Status",label:"Status",children:e.jsx(c,{options:[{value:"ATIVO",label:"ATIVO"},{value:"INATIVO",label:"INATIVO"}]})}),e.jsx(s.Item,{name:"Plano",label:"Plano",children:e.jsx(c,{options:[{value:"PADRAO",label:"PADRÃO"},{value:"PRO",label:"PRO"}]})})]})}),e.jsx(o,{open:N,title:"Criar Banco de Dados do Tenant",onCancel:()=>O(!1),onOk:async()=>{try{const e=await v.validateFields(),a=await x.provisionTenant(e);u.success(`Banco provisionado: ${a.dsn}`),O(!1),await C()}catch(e){u.error(e?.response?.data?.detail||"Erro ao provisionar banco")}},children:e.jsxs(s,{form:v,layout:"vertical",children:[e.jsx(s.Item,{name:"nome",label:"Nome",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"slug",label:"Slug",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"db_name",label:"Nome do Banco",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"db_host",label:"Host",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"db_port",label:"Porta",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"db_user",label:"Usuário",rules:[{required:!0}],children:e.jsx(d,{})}),e.jsx(s.Item,{name:"db_password",label:"Senha",rules:[{required:!0}],children:e.jsx(d.Password,{})})]})}),e.jsx(o,{open:A,title:"DSN do Tenant",onCancel:()=>g(!1),footer:null,children:e.jsx("div",{style:{fontFamily:"monospace"},children:w||"—"})})]})}export{x as default};
