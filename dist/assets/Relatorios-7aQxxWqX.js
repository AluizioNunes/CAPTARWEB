import{j as e,m as a}from"./utils-CdldNp8C.js";import{r as t}from"./react-vendor-qiAl16-a.js";import{u as r}from"./index-BWWBunTH.js";import{l as i,K as n,N as l,C as s,S as o,c as d,Z as c,B as p,_ as x,t as h,I as u,v as m,i as j,Q as g,T as y}from"./ui-vendor-CMHmWg4l.js";function w(){const w=r(),{message:S}=i.useApp(),[C,f]=t.useState(!1),[b,v]=t.useState(!1),[R,O]=t.useState([]),[A,I]=t.useState(void 0),[N,T]=t.useState(""),[P,E]=t.useState("portrait"),[k,U]=t.useState([]),[D,L]=t.useState(!1),[_,F]=t.useState(null),M=async e=>{try{const a=await w.downloadRelatorioPdf(e,P),t=window.URL.createObjectURL(a);if(!window.open(t,"_blank")){const a=document.createElement("a");a.href=t,a.download=`relatorio_${e}.pdf`,document.body.appendChild(a),a.click(),a.remove()}window.setTimeout(()=>window.URL.revokeObjectURL(t),3e3)}catch(a){S.error(a?.response?.data?.detail||"Erro ao baixar PDF")}},z=t.useMemo(()=>(R||[]).map(e=>({label:`${e.nome} (#${e.id})`,value:Number(e.id)})),[R]),B=[{title:"ID",dataIndex:"id",align:"center",sorter:(e,a)=>Number(e.id)-Number(a.id)},{title:"CAMPANHA",dataIndex:"campanha_id",align:"center",render:e=>e?String(e):"—"},{title:"TÍTULO",dataIndex:"titulo",align:"left",render:e=>String(e||"")||"—"},{title:"TIPO",dataIndex:"tipo",align:"center",render:a=>e.jsx(y,{children:String(a||"").toUpperCase()||"—"})},{title:"CRIADO EM",dataIndex:"criado_em",align:"center",render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—"},{title:"CRIADO POR",dataIndex:"criado_por",align:"left",render:e=>e?String(e):"—"},{title:"AÇÕES",dataIndex:"id",align:"center",render:(a,t)=>e.jsxs(o,{children:[e.jsx(p,{size:"small",onClick:async()=>{try{const e=await w.getRelatorio(Number(t.id));F(e),L(!0)}catch(e){S.error(e?.response?.data?.detail||"Erro ao abrir relatório")}},children:"Abrir"}),"COMPROVANTE"===String(t?.tipo||"").toUpperCase()?e.jsx(p,{size:"small",icon:e.jsx(g,{}),onClick:()=>M(Number(t.id)),children:"PDF"}):null]})}],$=async()=>{try{f(!0);const[e,a]=await Promise.all([w.getCampanhas(),w.getRelatorios({limit:200})]);O(e.rows||[]),U(a.rows||[])}catch(e){S.error(e?.response?.data?.detail||"Erro ao carregar relatórios")}finally{f(!1)}};t.useEffect(()=>{$()},[]);return e.jsxs(a.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs(n,{gutter:[16,16],children:[e.jsx(l,{span:24,children:e.jsx(s,{children:e.jsxs(o,{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[e.jsxs(o,{children:[e.jsx(d,{}),e.jsx(c.Title,{level:4,style:{margin:0},children:"AUTOMAÇÃO • RELATÓRIOS"})]}),e.jsx(p,{icon:e.jsx(x,{}),onClick:$,children:"Atualizar"})]})})}),e.jsx(l,{span:24,children:e.jsx(s,{title:"Gerar comprovante",children:e.jsxs(n,{gutter:[12,12],children:[e.jsxs(l,{xs:24,md:8,children:[e.jsx(c.Text,{children:"Campanha"}),e.jsx(h,{style:{width:"100%"},showSearch:!0,optionFilterProp:"label",placeholder:"Selecione",value:A,onChange:e=>I(Number(e)),options:z})]}),e.jsxs(l,{xs:24,md:8,children:[e.jsx(c.Text,{children:"Título (opcional)"}),e.jsx(u,{value:N,onChange:e=>T(e.target.value),placeholder:"Comprovante..."})]}),e.jsxs(l,{xs:24,md:4,children:[e.jsx(c.Text,{children:"Orientação PDF"}),e.jsx(h,{style:{width:"100%"},placeholder:"Selecione",value:P,onChange:e=>E(e),options:[{label:"Retrato",value:"portrait"},{label:"Paisagem",value:"landscape"}]})]}),e.jsx(l,{xs:24,md:4,style:{display:"flex",alignItems:"end"},children:e.jsx(p,{type:"primary",block:!0,loading:b,onClick:async()=>{if(A)try{v(!0),await w.createRelatorioComprovante({campanha_id:A,titulo:N||void 0}),T(""),await $(),S.success("Relatório gerado")}catch(e){S.error(e?.response?.data?.detail||"Erro ao gerar relatório")}finally{v(!1)}else S.warning("Selecione uma campanha")},children:"Gerar"})})]})})}),e.jsx(l,{span:24,children:e.jsx(s,{children:e.jsx(m,{rowKey:e=>e.id||JSON.stringify(e),loading:C,dataSource:k,columns:B,size:"small",bordered:!0})})})]}),e.jsx(j,{open:D,onCancel:()=>L(!1),width:900,footer:e.jsxs(o,{children:["COMPROVANTE"===String(_?.tipo||"").toUpperCase()&&_?.id?e.jsx(p,{icon:e.jsx(g,{}),onClick:()=>M(Number(_.id)),children:"Baixar PDF"}):null,e.jsx(p,{onClick:()=>L(!1),children:"Fechar"})]}),title:_?.titulo||"Relatório",children:e.jsx("pre",{style:{margin:0,maxHeight:520,overflow:"auto"},children:_?JSON.stringify(_,null,2):""})})]})}export{w as default};
