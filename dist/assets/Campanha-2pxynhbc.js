import{p as e,i as t,g as a,j as s,m as o}from"./utils-CdldNp8C.js";import{r as i}from"./react-vendor-qiAl16-a.js";import{u as n,a as r,p as l,L as c}from"./index-CFXHmW6Z.js";import{F as d,s as m,m as u,i as p,C as h,I as f,f as g,a0 as x,S,p as j,U as A,a1 as y,b as v,c as O,B as b,V as E,w as C,x as I,A as N,l as w,T,u as D,K as _,N as M,a2 as R,a3 as z,a4 as H,a5 as $,a6 as k,W as P,a7 as L,a8 as U,_ as F,$ as V,a9 as W,aa as q,ab as B,ac as G,ad as J,D as Y,v as X}from"./ui-vendor-W3kvUvq_.js";function K({open:o,initial:w,onCancel:T,onSaved:D}){const[_]=d.useForm(),[M,R]=m.useMessage(),[z,H]=i.useState("eleitores"),[$,k]=i.useState([]),[P,L]=i.useState([]),[U,F]=i.useState("bottom"),[V,W]=i.useState("nenhum"),[q,B]=i.useState(""),G=n(),{user:J}=r(),[Y,X]=i.useState(0),[K,Q]=i.useState(0),[Z,ee]=i.useState(0),[te,ae]=i.useState(0),[se,oe]=i.useState(0),[ie,ne]=i.useState(0),re=i.useMemo(()=>{const a=J?.login_time;if(!a)return null;const s=e(a);if(t(s))return s;const o=new Date(a);return isNaN(o.getTime())?null:o},[J]),[le,ce]=i.useState(""),de=re?a(re,"dd/MM/yyyy HH:mm",{locale:l}):"",me=String(localStorage.getItem("tenantSlug")||"captar"),ue=String(localStorage.getItem("tenantName")||"CAPTAR"),pe=e=>{const t=String(e||"").trim();if(!t)return"";if(/^data:image\//i.test(t)&&/;base64,/i.test(t)){const e=t.split(/;base64,/i)[1]?.trim()||"";return e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://")||e.startsWith("static/")?e.startsWith("static/")?`/${e}`:e:t}return t.startsWith("data:")||t.startsWith("http://")||t.startsWith("https://")||t.startsWith("/static/")?t:t.startsWith("static/")?`/${t}`:t.startsWith("/")?t:/\.(png|jpg|jpeg|bmp|gif|webp)$/i.test(t)?`/static/campanhas/${t}`:t.includes("/")&&!t.startsWith("/")?`/${t}`:`data:image/png;base64,${t}`};i.useEffect(()=>{const e=()=>{if(!re)return void ce("");const e=Date.now()-re.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),s=Math.floor(e%6e4/1e3),o=String(t).padStart(2,"0"),i=String(a).padStart(2,"0"),n=String(s).padStart(2,"0");ce(`${o}:${i}:${n}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[re]),i.useEffect(()=>{if(o)if(w){_.setFieldsValue({...w,data_inicio:w.data_inicio?u(w.data_inicio):void 0,data_fim:w.data_fim?u(w.data_fim):void 0}),L(w?.imagem?[{uid:"-1",name:"imagem",status:"done",url:pe(w.imagem)}]:[]);const e=w?.conteudo_arquivo||w?.AnexoJSON;let t=null;if(e)try{t="string"==typeof e?JSON.parse(e):e,!Array.isArray(t)&&t?.config&&(F(t.config.text_position||"bottom"),W("SIM_NAO"===t.config.response_mode?"sim_nao":"nenhum"),B(String(t.config.question||"")))}catch{}const a=!(!t||Array.isArray(t)||!0!==t?.usar_eleitores&&"eleitores"!==String(t?.source||"").toLowerCase());H(a?"eleitores":e?"arquivo":"eleitores"),X(w.meta||0),Q(w.enviados||0),ee(w.nao_enviados||0),ae(w.positivos||0),oe(w.negativos||0);const s=(w.enviados||0)-((w.positivos||0)+(w.negativos||0));ne(void 0!==w.aguardando?w.aguardando:s>0?s:0)}else _.resetFields(),H("eleitores"),k([]),L([]),F("bottom"),W("nenhum"),B(""),X(0),Q(0),ee(0),ae(0),oe(0),ne(0)},[o,w]),i.useEffect(()=>{(async()=>{if("eleitores"===z)try{const e=await G.getDashboardStats();X(e.totalEleitores||0)}catch(e){console.error("Erro ao buscar total de eleitores",e)}else if("arquivo"===z&&$.length>0){const e=$[0].originFileObj;if(e)if(e.name.endsWith(".json"))try{const t=await e.text(),a=JSON.parse(t);if(Array.isArray(a)&&(X(a.length),a.length>0)){Object.keys(a[0]).map(e=>e.toLowerCase()).includes("whatsapp")||M.warning('Atenção: O arquivo JSON não contém a chave "whatsapp".')}}catch{}else if(e.name.endsWith(".csv"))try{const t=(await e.text()).split("\n").filter(e=>e.trim().length>0);if(t.length>0){t[0].toLowerCase().includes("whatsapp")||M.warning('Atenção: O arquivo CSV não contém a coluna "whatsapp".'),X(Math.max(0,t.length-1))}else X(0)}catch{}}})()},[z,$,G]);return s.jsxs(s.Fragment,{children:[R,s.jsxs(p,{open:o,title:s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("img",{src:c,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),s.jsxs("div",{style:{fontSize:12},children:["TENANT: ",s.jsx("strong",{style:{color:"#333"},children:String(ue||me).toUpperCase()})]})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[s.jsxs("div",{style:{textAlign:"right"},children:[s.jsx("div",{style:{fontWeight:700},children:J?.usuario?String(J?.usuario).toUpperCase():String(J?.nome||"").toUpperCase()||"USUÁRIO"}),s.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(J?.funcao||"").toUpperCase()} | PERFIL: ${String(J?.perfil||"").toUpperCase()}`}),s.jsx("div",{style:{fontSize:12},children:`LOGIN: ${de||"--"} | TEMPO CONECTADO: ${le||"--:--:--"}`})]}),s.jsx(N,{size:"large"})]})]}),onCancel:T,footer:null,destroyOnHidden:!0,width:980,closable:!1,maskClosable:!1,className:"campanhas-modal",children:[s.jsx("style",{children:".campanhas-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .campanhas-modal .ant-modal-content{ border-radius: 0 !important; } .campanhas-modal .ant-form-item{ margin-bottom:6px; }"}),s.jsxs(d,{form:_,layout:"vertical",children:[s.jsxs(h,{title:"DADOS DA CAMPANHA",size:"small",children:[s.jsx(d.Item,{name:"nome",label:"NOME DA CAMPANHA",rules:[{required:!0,message:"Informe o nome"}],getValueFromEvent:e=>{const t=e?.target?.value;return"string"==typeof t?t.toUpperCase():t},children:s.jsx(f,{prefix:s.jsx(g,{}),placeholder:"Ex: CAMPANHA DE DOAÇÃO"})}),s.jsx(d.Item,{label:"TIPO DE ENVIO",children:s.jsxs(x.Group,{value:V,onChange:e=>W(e.target.value),children:[s.jsx(x.Button,{value:"nenhum",children:"MENSAGEM"}),s.jsx(x.Button,{value:"sim_nao",children:"PERGUNTA SIM / NÃO"})]})}),"sim_nao"===V&&s.jsx(d.Item,{label:"PERGUNTA (SIM/NÃO)",children:s.jsx(f,{value:q,onChange:e=>B(String(e.target.value||"").toUpperCase()),placeholder:"Ex: VOCÊ APOIA NOSSO PROJETO?"})}),s.jsx(d.Item,{name:"descricao",label:"DESCRIÇÃO / MENSAGEM",rules:[{required:!0,whitespace:!0,message:"Informe a mensagem"}],extra:s.jsxs("div",{style:{fontSize:10,color:"#666"},children:["Dica: Use ",s.jsx("strong",{children:"(NOME)"})," ou ",s.jsx("strong",{children:"{NOME}"})," para substituir pelo nome do contato.",s.jsx("br",{}),'Certifique-se que seu arquivo contém uma coluna chamada "Nome", "Name", "Cliente" ou "Full Name".']}),children:s.jsx(f.TextArea,{rows:4,placeholder:"Texto da mensagem que será enviada"})}),s.jsxs(S,{style:{display:"flex",marginBottom:8},align:"start",children:[s.jsx(d.Item,{name:"data_inicio",label:"DATA INÍCIO",rules:[{required:!0}],children:s.jsx(j,{style:{width:150},format:"DD/MM/YYYY"})}),s.jsx(d.Item,{name:"data_fim",label:"DATA FIM",children:s.jsx(j,{style:{width:150},format:"DD/MM/YYYY"})})]}),s.jsx(d.Item,{label:"IMAGEM DA MENSAGEM",children:s.jsxs("div",{style:{display:"flex",gap:16,alignItems:"flex-start"},children:[s.jsx(A,{listType:"picture-card",maxCount:1,fileList:P,onChange:({fileList:e})=>L(e),beforeUpload:()=>!1,accept:"image/*",children:P.length<1&&s.jsxs("div",{children:[s.jsx(y,{}),s.jsx("div",{style:{marginTop:8},children:"Upload"})]})}),P.length>0&&s.jsxs(d.Item,{label:"POSIÇÃO DO TEXTO EM RELAÇÃO À IMAGEM",style:{marginBottom:0},children:[s.jsxs(x.Group,{value:U,onChange:e=>F(e.target.value),children:[s.jsx(x.Button,{value:"top",children:"TEXTO ANTES (MENSAGEM SEPARADA)"}),s.jsx(x.Button,{value:"bottom",children:"TEXTO DEPOIS (LEGENDA)"})]}),s.jsx("div",{style:{fontSize:10,color:"#999",marginTop:4},children:"top"===U?"Envia texto primeiro, depois imagem.":"Envia imagem com o texto como legenda."})]})]})})]}),s.jsxs(h,{title:"DESTINATÁRIOS",size:"small",style:{marginTop:16},children:[s.jsx(d.Item,{label:"SELECIONE A ORIGEM DOS CONTATOS",children:s.jsxs(x.Group,{value:z,onChange:e=>H(e.target.value),children:[s.jsxs(x.Button,{value:"eleitores",children:[s.jsx(v,{})," BASE DE ELEITORES"]}),s.jsxs(x.Button,{value:"arquivo",children:[s.jsx(O,{})," IMPORTAR ARQUIVO"]})]})}),"arquivo"===z&&s.jsxs(d.Item,{label:"ARQUIVO DE CONTATOS (JSON, CSV, XLS, PDF)",required:!0,children:[s.jsx(A,{maxCount:1,fileList:$,onChange:({fileList:e})=>k(e),beforeUpload:()=>!1,accept:".json,.csv,.xls,.xlsx,.pdf",children:s.jsx(b,{icon:s.jsx(E,{}),children:"Selecionar Arquivo"})}),s.jsxs("div",{style:{marginTop:8,color:"#666",fontSize:"12px"},children:["JSON: O conteúdo será salvo no banco.",s.jsx("br",{}),"Outros: O arquivo será anexado."]})]})]}),s.jsxs(S,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[s.jsx(b,{onClick:T,icon:s.jsx(C,{}),children:"CANCELAR"}),s.jsx(b,{type:"primary",onClick:async()=>{try{const t=await _.validateFields();if("sim_nao"===V&&!String(q||"").trim())return void M.error("Informe a pergunta (SIM/NÃO)");const a=e=>new Promise((t,a)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>t(s.result),s.onerror=e=>a(e)}),s={...t,data_inicio:t.data_inicio?t.data_inicio.format("YYYY-MM-DD"):null,data_fim:t.data_fim?t.data_fim.format("YYYY-MM-DD"):null,meta:Y,enviados:K,nao_enviados:Z,positivos:te,negativos:se,aguardando:ie};if(P.length>0){const e=P[0].originFileObj;e&&(s.imagem=await a(e))}else w?.imagem&&(s.imagem=null);let o=null;const i={text_position:U};if("sim_nao"===V&&(i.response_mode="SIM_NAO",i.question=String(q||"").trim()),"arquivo"===z&&$.length>0){const t=$[0].originFileObj;if(t&&(s.AnexoFile=t,s.anexo_json=JSON.stringify({contacts:[],config:i}),t.name.endsWith(".json"))){const a=await t.text();try{const e=JSON.parse(a);o={contacts:Array.isArray(e)?e:[],config:i},s.anexo_json=JSON.stringify(o)}catch(e){return void M.error("Arquivo JSON inválido")}}}else"eleitores"===z&&(s.usar_eleitores=!0,o={source:"eleitores",usar_eleitores:!0,contacts:[],config:i},s.anexo_json=JSON.stringify(o));let n;if(w?.id)await G.updateCampanha(w.id,s),n=w.id,M.success("Campanha atualizada");else{n=(await G.createCampanha(s)).id,M.success("Campanha criada")}"arquivo"===z&&s.AnexoFile&&await G.uploadCampanhaAnexo(n,{file:s.AnexoFile,type:"anexo"}),D()}catch(e){M.error(e?.response?.data?.detail||"Erro ao salvar campanha")}},icon:s.jsx(I,{}),children:"SALVAR"})]})]})]})]})}function Q(){const[e,t]=i.useState([]),[a,l]=i.useState(!1),[c,d]=i.useState(!1),[m,p]=i.useState(null),[f,g]=i.useState([]),[x,j]=i.useState({}),[A,y]=i.useState([]),[O,E]=i.useState([]),[C,I]=i.useState([]),[N,Q]=i.useState([]),Z=n(),{user:ee}=r(),{message:te,modal:ae}=w.useApp(),se=e=>{const t=String(e||"").trim();if(!t)return"";if(/^data:image\//i.test(t)&&/;base64,/i.test(t)){const e=t.split(/;base64,/i)[1]?.trim()||"";return e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://")||e.startsWith("static/")?e.startsWith("static/")?`/${e}`:e:t}return t.startsWith("data:")||t.startsWith("http://")||t.startsWith("https://")||t.startsWith("/static/")?t:t.startsWith("static/")?`/${t}`:t.startsWith("/")?t:/\.(png|jpg|jpeg|bmp|gif|webp)$/i.test(t)?`/static/campanhas/${t}`:t.includes("/")&&!t.startsWith("/")?`/${t}`:`data:image/png;base64,${t}`},oe=i.useMemo(()=>1!==O.length?null:e.find(e=>e.id===O[0]),[O,e]);i.useEffect(()=>{if(oe){I([`[${u().format("HH:mm:ss")}] Sistema pronto. Aguardando início do disparo.`]);let t=[],a={};const s=(e,t)=>{if(!e)return"";const a=Object.keys(e);for(const s of t){const t=a.find(e=>e.trim().toLowerCase()===s.trim().toLowerCase());if(t&&e[t])return e[t]}return""};if(oe.conteudo_arquivo)try{const e=JSON.parse(oe.conteudo_arquivo);Array.isArray(e)?t=e:e.contacts&&Array.isArray(e.contacts)&&(t=e.contacts,a=e.config||{}),t.length>0&&(t=t.map((e,t)=>{const a=s(e,["whatsapp","celular","telefone","phone","mobile","tel"]);return{id:t,nome:s(e,["nome","name","cliente","full_name","fullname"])||`Contato ${t+1}`,whatsapp:a,status:e.status||"waiting",original:e}}).filter(e=>e.whatsapp),0===t.length&&I(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO: Nenhum contato com 'whatsapp' encontrado.`]))}catch(e){console.error("Erro ao fazer parse do conteudo_arquivo",e),I(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO: Não foi possível ler o arquivo de contatos.`])}else oe.usar_eleitores&&(I(e=>[...e,`[${u().format("HH:mm:ss")}] INFO: Esta campanha utiliza a base de Eleitores. Visualização individual não carregada para performance.`]),t=[]);0!==t.length||oe.usar_eleitores||I(e=>[...e,`[${u().format("HH:mm:ss")}] AVISO: Nenhum contato válido encontrado no arquivo.`]),Q(t),oe._config=a}else I([]),Q([])},[oe?.id,oe?.conteudo_arquivo]);const ie=i.useMemo(()=>{if(!oe)return!1;const e=oe.data_inicio,t=oe.data_fim;if(!e)return!1;const a=u(),s=u(e),o=u(t||"2100-01-01");return a.isAfter(s.startOf("day"))&&a.isBefore(o.endOf("day"))||a.isSame(s,"day")||a.isSame(o,"day")},[oe]),ne=()=>s.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:[s.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z",fill:"currentColor"}),s.jsx("path",{d:"M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",fill:"currentColor"})]}),re=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M6 7h12M9 7v10m6-10v10M4 7h16l-1 14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),le=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M3 4h6v16H3V4zm12 0h6v16h-6V4z",fill:"currentColor"})}),ce=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),de=e=>{if(!e)return{label:"-",color:"default"};const t=u().startOf("day"),a=e.data_inicio?u(e.data_inicio).startOf("day"):null,s=e.data_fim?u(e.data_fim).endOf("day"):null;let o=!1;const i=e.status;return!0!==i&&"true"!==i&&"TRUE"!==i&&"1"!==i&&1!==i&&"ATIVO"!==String(i).toUpperCase()||(o=!0),!1!==i&&"false"!==i&&"FALSE"!==i&&"0"!==i&&0!==i&&"INATIVO"!==String(i).toUpperCase()||(o=!1),o?a&&t.isBefore(a)?{label:"AGENDADO",color:"blue"}:s&&t.isAfter(s)?{label:"INATIVO",color:"red"}:{label:"ATIVO",color:"green"}:{label:"INATIVO",color:"red"}},me=async()=>{try{l(!0);const e=await Z.getCampanhasSchema(),a=["id","nome","status","meta","enviados","aguardando","data_inicio","data_fim","created_at"],s={};for(const t of e.columns||[])s[t.name]=t;const o=a.filter(e=>s[e]).map(e=>s[e]),i=(e.columns||[]).filter(e=>!a.includes(e.name));g([...o,...i]);const n=(await Z.getCampanhas()).rows||[];t(n);const r={};for(const t of a)s[t]&&(r[t]=!0);for(const t of i)r[t.name]=!1;const c=`campanhas.columns.visible.${ee?.usuario||"default"}`,d=localStorage.getItem(c);j(d?JSON.parse(d):r);const m=`campanhas.columns.order.${ee?.usuario||"default"}`,u=localStorage.getItem(m);y(u?JSON.parse(u):a.filter(e=>s[e]))}catch(e){te.error(e?.response?.data?.detail||"Erro ao carregar campanhas")}finally{l(!1)}};i.useEffect(()=>{me()},[]);const ue=f.map(t=>{const a=t.name,o=Array.from(new Set((e||[]).map(e=>e[a]).filter(e=>null!=e))).slice(0,20).map(e=>({text:String(e).toUpperCase(),value:String(e).toUpperCase()})),i=(t.type||"").toLowerCase(),n=new Set(["id","status","data_inicio","data_fim","created_at"]);return{title:{id:"ID",nome:"NOME DA CAMPANHA",descricao:"DESCRIÇÃO",status:"STATUS",data_inicio:"INÍCIO",data_fim:"FIM",meta:"META",enviados:"ENVIADOS",nao_enviados:"NÃO ENVIADOS",positivos:"RESPOSTAS POSITIVAS",negativos:"RESPOSTAS NEGATIVAS",aguardando:"AGUARDANDO RESPOSTAS",created_at:"CRIADO EM"}[a]||a.toUpperCase(),dataIndex:a,align:n.has(a)?"center":"left",filters:o,onFilter:(e,t)=>String(t[a]).toUpperCase()===String(e).toUpperCase(),sorter:(e,t)=>{const s=e[a],o=t[a];return null==s?-1:null==o?1:i.includes("int")||i.includes("numeric")||i.includes("decimal")?Number(s)-Number(o):i.includes("date")||i.includes("timestamp")?new Date(s).getTime()-new Date(o).getTime():String(s).toUpperCase().localeCompare(String(o).toUpperCase())},render:(e,t)=>{if(null==e)return"";if(i.includes("date")||i.includes("timestamp")){const t=new Date(e);if(!isNaN(t.getTime()))return t.toLocaleDateString("pt-BR")}if("status"===a){const{label:e,color:a}=de(t);return s.jsx(T,{color:a,children:e})}return String(e).toUpperCase()},onHeaderCell:()=>({draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain",a)},onDragOver:e=>{e.preventDefault()},onDrop:e=>{const t=e.dataTransfer.getData("text/plain"),s=a;t&&t!==s&&y(e=>{const a=e.filter(e=>e!==t),o=a.indexOf(s);if(-1===o)return e;a.splice(o,0,t);const i=`campanhas.columns.order.${ee?.usuario||"default"}`;return localStorage.setItem(i,JSON.stringify(a)),a})}})}}),pe={title:"AÇÕES",dataIndex:"__actions__",align:"center",render:(e,t)=>s.jsxs(S,{children:[s.jsx(b,{type:"text",icon:s.jsx(ne,{}),title:"EDITAR",onClick:()=>{p(t),d(!0)}}),s.jsx(b,{type:"text",danger:!0,icon:s.jsx(re,{}),title:"DELETAR",onClick:async()=>{try{if(!t.id)return void te.info("REGISTRO SEM ID");await Z.deleteCampanha(t.id),te.success("CAMPANHA DELETADA"),await me()}catch(e){te.error(e?.response?.data?.detail||"ERRO AO DELETAR CAMPANHA")}}})]})},he=(A.length?A:ue.map(e=>e.dataIndex)).map(e=>ue.find(t=>t.dataIndex===e)).filter(Boolean).filter(e=>x[e.dataIndex]).concat([pe]),fe=s.jsx("div",{style:{padding:12},children:f.map(e=>s.jsx("div",{style:{marginBottom:6},children:s.jsx(D,{checked:!!x[e.name],onChange:t=>{const a={...x,[e.name]:t.target.checked};j(a);const s=`campanhas.columns.visible.${ee?.usuario||"default"}`;localStorage.setItem(s,JSON.stringify(a))},children:e.name.toUpperCase()})},e.name))});return s.jsxs(o.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[s.jsx(h,{size:"small",style:{marginBottom:16,background:"#fafafa"},styles:{body:{padding:"12px"}},children:s.jsxs(_,{gutter:16,align:"middle",children:[s.jsx(M,{span:16,children:s.jsxs(_,{gutter:8,wrap:!1,children:[s.jsx(M,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f0f5ff",borderColor:"#adc6ff"},children:s.jsx(R,{title:"META",value:oe?.meta||0,valueStyle:{color:"#2f54eb",fontSize:"18px"},prefix:s.jsx(v,{})})})}),s.jsx(M,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fff0f6",borderColor:"#ffadd2"},children:s.jsx(R,{title:"DISPAROS",value:(oe?.enviados||0)+(oe?.nao_enviados||0),valueStyle:{color:"#eb2f96",fontSize:"18px"},prefix:s.jsx(z,{})})})}),s.jsx(M,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f6ffed",borderColor:"#b7eb8f"},children:s.jsx(R,{title:"ENVIADOS",value:oe?.enviados||0,valueStyle:{color:"#3f8600",fontSize:"18px"},prefix:s.jsx(H,{})})})}),s.jsx(M,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fff1f0",borderColor:"#ffa39e"},children:s.jsx(R,{title:"NÃO ENV.",value:oe?.nao_enviados||0,valueStyle:{color:"#cf1322",fontSize:"18px"},prefix:s.jsx($,{})})})}),s.jsx(M,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#e6f7ff",borderColor:"#91d5ff"},children:s.jsx(R,{title:"RESPOSTAS POSITIVAS",value:oe?.positivos||0,valueStyle:{color:"#096dd9",fontSize:"18px"}})})}),s.jsx(M,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fffbe6",borderColor:"#ffe58f"},children:s.jsx(R,{title:"RESPOSTAS NEGATIVAS",value:oe?.negativos||0,valueStyle:{color:"#d48806",fontSize:"18px"}})})}),s.jsx(M,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f9f0ff",borderColor:"#d3adf7"},children:s.jsx(R,{title:"AGUARDANDO RESPOSTAS",value:oe?.aguardando||0,valueStyle:{color:"#722ed1",fontSize:"18px"},prefix:s.jsx(k,{spin:(oe?.aguardando||0)>0})})})})]})}),s.jsxs(M,{span:8,style:{display:"flex",alignItems:"center",justifyContent:"space-between",borderLeft:"1px solid #e8e8e8",paddingLeft:16},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[oe?.imagem?s.jsx(P,{src:se(oe.imagem),height:60,width:60,style:{objectFit:"cover",borderRadius:4},alt:"Campanha"}):s.jsx("div",{style:{width:60,height:60,background:"#eee",borderRadius:4,display:"flex",alignItems:"center",justifyContent:"center",color:"#999"},children:s.jsx(L,{style:{fontSize:24}})}),s.jsx("div",{style:{fontSize:12,color:"#666"},children:oe?s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:oe.nome}),s.jsx("br",{}),s.jsx("span",{style:{fontSize:10},children:(()=>{const e=de(oe);return s.jsx(T,{color:e.color,style:{margin:0},children:e.label})})()})]}):s.jsx("span",{children:"Selecione uma campanha"})})]}),s.jsxs("div",{style:{display:"flex",gap:8},children:[s.jsx(U,{title:"Resetar todos os contatos e contadores",children:s.jsx(b,{onClick:()=>{oe&&ae.confirm({title:"RESETAR CAMPANHA",content:'Deseja realmente resetar esta campanha? Todos os contatos voltarão para o status "Aguardando" e os contadores serão zerados (exceto META).',okText:"SIM, RESETAR",cancelText:"CANCELAR",onOk:async()=>{te.loading({content:"Resetando campanha...",key:"reset"});try{const a=N.map(e=>{const t={...e.original,status:"waiting"};return t&&(delete t.resposta,delete t.response,delete t.respondido_em,delete t.respondidoEm),{...e,status:"waiting",original:t}}),s={enviados:0,nao_enviados:0,positivos:0,negativos:0,aguardando:0};let o=a.map(e=>e.original);if(oe.conteudo_arquivo)try{const e=JSON.parse(oe.conteudo_arquivo);!Array.isArray(e)&&e.contacts&&(o={...e,contacts:o})}catch(e){}await Z.updateCampanha(oe.id,{...s,anexo_json:o,status:"ATIVO"}),Q(a),t(e=>e.map(e=>e.id===oe.id?{...e,...s,status:"ATIVO"}:e)),I(e=>[...e,`[${u().format("HH:mm:ss")}] CAMPANHA RESETADA.`]),te.success({content:"Campanha resetada com sucesso!",key:"reset"}),await me()}catch(e){console.error(e),te.error({content:"Erro ao resetar campanha",key:"reset"})}}})},disabled:!oe,icon:s.jsx(F,{}),danger:!0,children:"RESETAR"})}),s.jsx(U,{title:oe?ie?"Iniciar automação":"Fora do período de vigência":"Selecione uma campanha",children:s.jsx(b,{onClick:async()=>{if(oe){te.loading({content:"Iniciando automação...",key:"envio"}),I(e=>[...e,`[${u().format("HH:mm:ss")}] INICIANDO DISPARO DA CAMPANHA: ${oe.nome}`]);try{I(e=>[...e,`[${u().format("HH:mm:ss")}] Verificando conexão com EvolutionAPI...`]);const s=N.filter(e=>"success"!==e.status);I(e=>[...e,`[${u().format("HH:mm:ss")}] Iniciando envio para ${s.length} contatos.`]);let o=[...N],i=0,n=0,r=0;const l=oe.imagem?se(oe.imagem):void 0;for(let a=0;a<o.length;a++){const s=o[a];if("success"===s.status)continue;I(e=>[...e,`[${u().format("HH:mm:ss")}] Enviando mensagem para ${s.nome} (${s.whatsapp})...`]);const c=s.status;let d=!1,m="";try{let e=String(oe.descricao??"");const t=s.nome||"";e=e.replace(/\(NOME\)/gi,t).replace(/\{NOME\}/gi,t).replace(/\(NAME\)/gi,t).replace(/\{NAME\}/gi,t),0===a&&I(t=>[...t,`[${u().format("HH:mm:ss")}] DEBUG: Exemplo de mensagem resolvida: "${e}"`]);const o=oe._config||{};if("SIM_NAO"===String(o.response_mode||"").toUpperCase()){const t=String(o.question||"").trim(),a=[e.trim()];t&&a.push(t),a.push("RESPONDA:\n1 - SIM\n2 - NÃO"),e=a.filter(Boolean).join("\n\n")}let i=o.text_position||"bottom";if(!e.trim()){if(!l)throw new Error("Mensagem vazia");"top"===i&&(i="bottom")}await Z.sendWhatsAppMessage(String(s.whatsapp),e,l,i),d=!0}catch(e){console.error(e),d=!1,m=e.response?.data?.detail||e.message||"Erro desconhecido"}o[a]={...s,status:d?"success":"error"},d?(i++,r++,"error"===c&&n--):"waiting"===c&&n++,Q([...o]),t(e=>e.map(e=>e.id===oe.id?{...e,enviados:(oe.enviados||0)+i,nao_enviados:(oe.nao_enviados||0)+n,aguardando:Math.max(0,(oe.aguardando||0)+r)}:e)),I(d?e=>[...e,`[${u().format("HH:mm:ss")}] [SUCESSO] Mensagem entregue para ${s.whatsapp}`]:e=>[...e,`[${u().format("HH:mm:ss")}] [ERRO] Falha ao entregar para ${s.whatsapp}: ${m}`]),await new Promise(e=>globalThis.setTimeout(e,1e3))}I(e=>[...e,`[${u().format("HH:mm:ss")}] DISPARO FINALIZADO.`]);try{const e=o.map(e=>({...e.original,status:e.status}));let t=e;if(oe.conteudo_arquivo)try{const a=JSON.parse(oe.conteudo_arquivo);!Array.isArray(a)&&a.contacts&&(t={...a,contacts:e})}catch{}await Z.updateCampanha(oe.id,{status:"ATIVO",enviados:(oe.enviados||0)+i,nao_enviados:(oe.nao_enviados||0)+n,aguardando:Math.max(0,(oe.aguardando||0)+r),anexo_json:t}),me()}catch(a){console.error("Erro ao atualizar status da campanha",a),I(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO AO SALVAR NO BANCO: ${a}`])}te.success({content:"Automação finalizada!",key:"envio"})}catch(s){I(e=>[...e,`[${u().format("HH:mm:ss")}] ERRO CRÍTICO: ${s}`]),te.error({content:"Erro ao iniciar automação",key:"envio"})}}},disabled:!ie,icon:s.jsx(V,{}),type:"primary",style:{background:ie?"#52c41a":void 0,borderColor:ie?"#52c41a":void 0},children:"ENVIAR"})})]})]})]})}),s.jsxs(_,{gutter:16,style:{marginBottom:16},children:[s.jsx(M,{span:6,children:s.jsxs(h,{size:"small",title:"Status dos Contatos",styles:{body:{padding:0,height:400,overflowY:"auto"}},children:[s.jsx(W,{size:"small",dataSource:N,renderItem:e=>s.jsx(W.Item,{style:{padding:"8px 12px"},children:s.jsxs(S,{children:["success"===e.status&&s.jsx(q,{style:{color:"#52c41a"}}),"error"===e.status&&s.jsx(B,{style:{color:"#ff4d4f"}}),"waiting"===e.status&&s.jsx(z,{style:{color:"#faad14"}}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:500},children:e.nome}),s.jsx("div",{style:{fontSize:11,color:"#999"},children:e.whatsapp})]})]})})}),0===N.length&&s.jsx("div",{style:{padding:16,textAlign:"center",color:"#999"},children:oe?"Nenhum contato na lista":"Selecione uma campanha"})]})}),s.jsx(M,{span:8,children:s.jsx(h,{size:"small",title:"Preview da Mensagem",styles:{body:{padding:0,height:400,background:"#e5ddd5",display:"flex",flexDirection:"column"}},children:s.jsx("div",{style:{flex:1,padding:20,overflowY:"auto",backgroundImage:'url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png")',backgroundSize:"contain"},children:oe?s.jsxs("div",{style:{background:"#fff",borderRadius:"0 8px 8px 8px",padding:8,maxWidth:"85%",boxShadow:"0 1px 1px rgba(0,0,0,0.1)"},children:[oe.imagem&&s.jsx(P,{src:se(oe.imagem),style:{width:"100%",borderRadius:8,marginBottom:8},preview:!1}),s.jsx("div",{style:{fontSize:14,lineHeight:"1.4",color:"#303030",whiteSpace:"pre-wrap"},children:oe.descricao||"Sem texto"}),s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",marginTop:4,gap:4},children:[s.jsx("span",{style:{fontSize:11,color:"#999"},children:u().format("HH:mm")}),s.jsx(q,{style:{fontSize:14,color:"#34b7f1"}})]})]}):s.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",color:"#999",flexDirection:"column",gap:8},children:[s.jsx(G,{style:{fontSize:32}}),s.jsx("span",{children:"Selecione uma campanha para visualizar o preview"})]})})})}),s.jsx(M,{span:10,children:s.jsx(h,{size:"small",title:"Log de Eventos (Caixa Preta)",styles:{body:{padding:12,height:400,background:"#000",color:"#0f0",fontFamily:"monospace",overflowY:"auto"}},children:C.length>0?s.jsx("ul",{style:{listStyle:"none",padding:0,margin:0},children:C.map((e,t)=>s.jsxs("li",{style:{marginBottom:4,borderBottom:"1px solid #333",paddingBottom:2},children:[s.jsx(J,{style:{fontSize:10,marginRight:8}}),e]},t))}):s.jsx("div",{style:{color:"#666"},children:"Aguardando eventos..."})})})]}),s.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:s.jsxs(S,{children:[s.jsx(Y,{placement:"bottomRight",trigger:["click"],menu:{items:[]},popupRender:()=>fe,children:s.jsx(b,{shape:"circle",icon:s.jsx(le,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},title:"VISUALIZAÇÃO DE COLUNAS"})}),s.jsx(b,{shape:"circle",icon:s.jsx(ce,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},onClick:()=>{p(null),d(!0)},title:"NOVA CAMPANHA"})]})}),s.jsx("style",{children:"\n        .campanhas-table .ant-table-thead > tr > th{ background:#FFD700; color:#000; font-family: 'Arimo', Arial, sans-serif; }\n        .campanhas-table .ant-table-thead > tr > th .ant-table-column-title{ display:flex; justify-content:center; align-items:center; text-align:center; }\n        .campanhas-table .ant-table-tbody > tr > td{ font-family: 'Roboto Condensed', Arial, sans-serif; padding:2px 6px; line-height:0.95; height:22px; }\n      "}),s.jsx(X,{loading:a,dataSource:e,columns:he,rowKey:"id",bordered:!0,size:"small",className:"ant-table-striped campanhas-table",rowSelection:{type:"radio",selectedRowKeys:O,onChange:e=>E(e)},onRow:e=>({onClick:()=>E([e.id])})}),s.jsx(K,{open:c,initial:m||void 0,onCancel:()=>d(!1),onSaved:async()=>{d(!1),await me()}})]})}export{Q as default};
