import{p as e,i as t,g as a,j as s,m as i}from"./utils-CdldNp8C.js";import{r as n}from"./react-vendor-qiAl16-a.js";import{u as o,a as r,p as l,L as d}from"./index-BWWBunTH.js";import{F as c,s as u,m,i as p,C as h,I as g,f,$ as x,S,p as v,t as j,U as y,a0 as A,b,c as _,B as w,V as O,G as N,w as I,x as C,A as E,l as M,T,u as R,K as D,N as L,a1 as $,a2 as H,a3 as k,a4 as z,a5 as V,W as F,a6 as P,a7 as U,_ as q,a8 as B,a9 as W,aa as G,ab as J,ac as Y,ad as X,D as Z,v as K}from"./ui-vendor-CMHmWg4l.js";function Q({open:i,initial:M,onCancel:T,onSaved:R}){const[D]=c.useForm(),[L,$]=u.useMessage(),[H,k]=n.useState("eleitores"),[z,V]=n.useState([]),[F,P]=n.useState([]),[U,q]=n.useState("bottom"),[B,W]=n.useState("nenhum"),[G,J]=n.useState(""),[Y,X]=n.useState(!1),[Z,K]=n.useState([]),[Q,ee]=n.useState([]),te=o(),{user:ae}=r(),[se,ie]=n.useState(0),[ne,oe]=n.useState(0),[re,le]=n.useState(0),[de,ce]=n.useState(0),[ue,me]=n.useState(0),[pe,he]=n.useState(0),[ge,fe]=n.useState({registros:0,duplicados_distintos:0,excluidos:0,validos:0}),xe=c.useWatch("blocos_por_dia",D),Se=n.useMemo(()=>{const a=ae?.login_time;if(!a)return null;const s=e(a);if(t(s))return s;const i=new Date(a);return isNaN(i.getTime())?null:i},[ae]),[ve,je]=n.useState(""),ye=Se?a(Se,"dd/MM/yyyy HH:mm",{locale:l}):"",Ae=String(localStorage.getItem("tenantSlug")||"captar"),be=String(localStorage.getItem("tenantName")||"CAPTAR"),_e=e=>{const t=String(e||"").trim();if(!t)return"";if(/^data:image\//i.test(t)&&/;base64,/i.test(t)){const e=t.split(/;base64,/i)[1]?.trim()||"";return e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://")||e.startsWith("static/")?e.startsWith("static/")?`/${e}`:e:t}return t.startsWith("data:")||t.startsWith("http://")||t.startsWith("https://")||t.startsWith("/static/")?t:t.startsWith("static/")?`/${t}`:t.startsWith("/")?t:/\.(png|jpg|jpeg|bmp|gif|webp)$/i.test(t)?`/static/campanhas/${t}`:t.includes("/")&&!t.startsWith("/")?`/${t}`:`data:image/png;base64,${t}`};n.useEffect(()=>{const e=()=>{if(!Se)return void je("");const e=Date.now()-Se.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),s=Math.floor(e%6e4/1e3),i=String(t).padStart(2,"0"),n=String(a).padStart(2,"0"),o=String(s).padStart(2,"0");je(`${i}:${n}:${o}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[Se]),n.useEffect(()=>{if(i)if((async()=>{try{const e=await te.listEvolutionApis();K(e||[])}catch{K([])}})(),M){D.setFieldsValue({...M,data_inicio:M.data_inicio?m(M.data_inicio):void 0,data_fim:M.data_fim?m(M.data_fim):void 0}),X(!!M.recorrencia_ativa),P(M?.imagem?[{uid:"-1",name:"imagem",status:"done",url:_e(M.imagem)}]:[]);const e=M?.conteudo_arquivo||M?.AnexoJSON;let t=null;if(e)try{if(t="string"==typeof e?JSON.parse(e):e,!Array.isArray(t)&&t?.config){q(t.config.text_position||"bottom"),W("SIM_NAO"===t.config.response_mode?"sim_nao":"nenhum"),J(String(t.config.question||""));const e=t.config||{},a=e.evolution_api_ids??e.evolution_api_id,s=(Array.isArray(a)?a:null!=a?[a]:[]).map(e=>String(e??"").trim()).filter(e=>!!e);ee(s)}}catch{}const a=!(!t||Array.isArray(t)||!0!==t?.usar_eleitores&&"eleitores"!==String(t?.source||"").toLowerCase());k(a?"eleitores":e?"arquivo":"eleitores"),ie(M.meta||0),oe(M.enviados||0),le(M.nao_enviados||0),ce(M.positivos||0),me(M.negativos||0);const s=(M.enviados||0)-((M.positivos||0)+(M.negativos||0));he(void 0!==M.aguardando?M.aguardando:s>0?s:0)}else D.resetFields(),D.setFieldsValue({recorrencia_ativa:!1,total_blocos:5,mensagens_por_bloco:500,blocos_por_dia:1,intervalo_min_seg:5,intervalo_max_seg:120,bloco_atual:0}),k("eleitores"),V([]),P([]),q("bottom"),W("nenhum"),J(""),X(!1),ee([]),ie(0),oe(0),le(0),ce(0),me(0),he(0),fe({registros:0,duplicados_distintos:0,excluidos:0,validos:0})},[i,M]),n.useEffect(()=>{(async()=>{const e=e=>String(e??"").replace(/\D/g,""),t=t=>{const a=new Map;for(const n of t){if(!n||"object"!=typeof n)continue;const t=Object.keys(n),s=t.find(e=>"whatsapp"===String(e).trim().toLowerCase())||t.find(e=>String(e).trim().toLowerCase().includes("whatsapp"))||t.find(e=>["celular","telefone","phone","mobile","tel"].includes(String(e).trim().toLowerCase())),i=s?n[s]:"",o=e(i);o&&a.set(o,(a.get(o)||0)+1)}let s=0,i=0;for(const e of a.values())e>1&&(s++,i+=e-1);return{duplicados_distintos:s,excluidos:i,validos:a.size}};if("eleitores"===H)try{const e=await te.getDashboardStats();ie(e.totalEleitores||0),fe({registros:0,duplicados_distintos:0,excluidos:0,validos:0})}catch(a){console.error("Erro ao buscar total de eleitores",a)}else if("arquivo"===H&&z.length>0){const e=z[0].originFileObj;if(e)if(e.name.endsWith(".json"))try{const a=await e.text(),s=JSON.parse(a);if(Array.isArray(s)){const e=t(s);if(fe({registros:s.length,duplicados_distintos:e.duplicados_distintos,excluidos:e.excluidos,validos:e.validos}),ie(e.validos),s.length>0){Object.keys(s[0]).map(e=>e.toLowerCase()).includes("whatsapp")||L.warning('Atenção: O arquivo JSON não contém a chave "whatsapp".')}}}catch{}else if(e.name.endsWith(".csv"))try{const a=(await e.text()).split(/\r?\n/).filter(e=>e.trim().length>0);if(a.length>0){const e=a[0],s=(e=>{const t=[",",";","\t","|"];let a=",",s=-1;for(const i of t){const t=e.split(i).length-1;t>s&&(s=t,a=i)}return a})(e),i=e.split(s).map(e=>String(e??"").trim().replace(/^"|"$/g,"").toLowerCase()).findIndex(e=>"whatsapp"===e||e.includes("whatsapp"));i<0&&L.warning('Atenção: O arquivo CSV não contém a coluna "whatsapp".');const n=[];for(let t=1;t<a.length;t++){const e=a[t].split(s),o=i>=0?e[i]:"";n.push({whatsapp:String(o??"").trim().replace(/^"|"$/g,"")})}const o=t(n),r=Math.max(0,a.length-1);fe({registros:r,duplicados_distintos:o.duplicados_distintos,excluidos:o.excluidos,validos:o.validos}),ie(o.validos)}else ie(0),fe({registros:0,duplicados_distintos:0,excluidos:0,validos:0})}catch{}else ie(0),fe({registros:0,duplicados_distintos:0,excluidos:0,validos:0})}})()},[H,z,te]),n.useEffect(()=>{if(!i)return;const e=Number(xe??D.getFieldValue("blocos_por_dia")??1),t=Math.max(1,Math.min(24,Math.floor(e||1))),a=Math.floor(Number(se??0)),s=Math.max(0,Number.isFinite(a)?a:0),n=Math.max(1,Math.min(t,s||1)),o=Math.max(1,Math.ceil((s||1)/n)),r=Number(D.getFieldValue("total_blocos")??0),l=Number(D.getFieldValue("mensagens_por_bloco")??0);r===n&&l===o||D.setFieldsValue({total_blocos:n,mensagens_por_bloco:o})},[i,se,xe,D]);return s.jsxs(s.Fragment,{children:[$,s.jsxs(p,{open:i,title:s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),s.jsxs("div",{style:{fontSize:12},children:["TENANT: ",s.jsx("strong",{style:{color:"#333"},children:String(be||Ae).toUpperCase()})]})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[s.jsxs("div",{style:{textAlign:"right"},children:[s.jsx("div",{style:{fontWeight:700},children:ae?.usuario?String(ae?.usuario).toUpperCase():String(ae?.nome||"").toUpperCase()||"USUÁRIO"}),s.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(ae?.funcao||"").toUpperCase()} | PERFIL: ${String(ae?.perfil||"").toUpperCase()}`}),s.jsx("div",{style:{fontSize:12},children:`LOGIN: ${ye||"--"} | TEMPO CONECTADO: ${ve||"--:--:--"}`})]}),s.jsx(E,{size:"large"})]})]}),onCancel:T,footer:null,destroyOnHidden:!0,width:980,closable:!1,maskClosable:!1,className:"campanhas-modal",children:[s.jsx("style",{children:".campanhas-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .campanhas-modal .ant-modal-content{ border-radius: 0 !important; } .campanhas-modal .ant-form-item{ margin-bottom:6px; }"}),s.jsxs(c,{form:D,layout:"vertical",children:[s.jsxs(h,{title:"DADOS DA CAMPANHA",size:"small",children:[s.jsx(c.Item,{name:"nome",label:"NOME DA CAMPANHA",rules:[{required:!0,message:"Informe o nome"}],getValueFromEvent:e=>{const t=e?.target?.value;return"string"==typeof t?t.toUpperCase():t},children:s.jsx(g,{prefix:s.jsx(f,{}),placeholder:"Ex: CAMPANHA DE DOAÇÃO"})}),s.jsx(c.Item,{label:"TIPO DE ENVIO",children:s.jsxs(x.Group,{value:B,onChange:e=>W(e.target.value),children:[s.jsx(x.Button,{value:"nenhum",children:"MENSAGEM"}),s.jsx(x.Button,{value:"sim_nao",children:"PERGUNTA SIM / NÃO"})]})}),"sim_nao"===B&&s.jsx(c.Item,{label:"PERGUNTA (SIM/NÃO)",children:s.jsx(g,{value:G,onChange:e=>J(String(e?.target?.value||"").toUpperCase()),placeholder:"Ex: VOCÊ APOIA NOSSO PROJETO?"})}),s.jsx(c.Item,{name:"descricao",label:"DESCRIÇÃO / MENSAGEM",rules:[{whitespace:!0,message:"Mensagem inválida"}],extra:s.jsxs("div",{style:{fontSize:10,color:"#666"},children:["Dica: Use ",s.jsx("strong",{children:"(NOME)"})," ou ",s.jsx("strong",{children:"{NOME}"})," para substituir pelo nome do contato.",s.jsx("br",{}),'Certifique-se que seu arquivo contém uma coluna chamada "Nome", "Name", "Cliente" ou "Full Name".']}),children:s.jsx(g.TextArea,{rows:4,placeholder:"Texto da mensagem que será enviada"})}),s.jsxs(S,{style:{display:"flex",marginBottom:8},align:"start",children:[s.jsx(c.Item,{name:"data_inicio",label:"DATA INÍCIO",rules:[{required:!0}],children:s.jsx(v,{style:{width:150},format:"DD/MM/YYYY"})}),s.jsx(c.Item,{name:"data_fim",label:"DATA FIM",children:s.jsx(v,{style:{width:150},format:"DD/MM/YYYY"})})]}),s.jsx(c.Item,{label:"EVOLUTION API (INSTÂNCIAS)",children:s.jsx(j,{mode:"multiple",allowClear:!0,value:Q,placeholder:Z.length?"Selecione uma ou mais instâncias":"Nenhuma instância encontrada",options:(Z||[]).map(e=>({value:String(e.id??"").trim(),label:`${String(e.name||e.nome||e.instance_name||e.id)}${e.number?` - ${String(e.number)}`:""}${e.connectionStatus?` (${String(e.connectionStatus)})`:""}`})),onChange:e=>{const t=Array.isArray(e)?e:[];ee(t.map(e=>String(e??"").trim()).filter(e=>!!e))}})}),s.jsx(c.Item,{label:"IMAGEM DA MENSAGEM",children:s.jsxs("div",{style:{display:"flex",gap:16,alignItems:"flex-start"},children:[s.jsx(y,{listType:"picture-card",maxCount:1,fileList:F,onChange:({fileList:e})=>P(e),beforeUpload:()=>!1,accept:"image/*",children:F.length<1&&s.jsxs("div",{children:[s.jsx(A,{}),s.jsx("div",{style:{marginTop:8},children:"Upload"})]})}),F.length>0&&s.jsxs(c.Item,{label:"POSIÇÃO DO TEXTO EM RELAÇÃO À IMAGEM",style:{marginBottom:0},children:[s.jsxs(x.Group,{value:U,onChange:e=>q(e.target.value),children:[s.jsx(x.Button,{value:"top",children:"TEXTO ANTES (MENSAGEM SEPARADA)"}),s.jsx(x.Button,{value:"bottom",children:"TEXTO DEPOIS (LEGENDA)"})]}),s.jsx("div",{style:{fontSize:10,color:"#999",marginTop:4},children:"top"===U?"Envia texto primeiro, depois imagem.":"Envia imagem com o texto como legenda."})]})]})})]}),s.jsxs(h,{title:"DESTINATÁRIOS",size:"small",style:{marginTop:16},children:[s.jsx(c.Item,{label:"SELECIONE A ORIGEM DOS CONTATOS",children:s.jsxs(x.Group,{value:H,onChange:e=>k(e.target.value),children:[s.jsxs(x.Button,{value:"eleitores",children:[s.jsx(b,{})," BASE DE ELEITORES"]}),s.jsxs(x.Button,{value:"arquivo",children:[s.jsx(_,{})," IMPORTAR ARQUIVO"]})]})}),"arquivo"===H&&s.jsxs(c.Item,{label:"ARQUIVO DE CONTATOS (JSON, CSV, XLS, PDF)",required:!0,children:[s.jsx(y,{maxCount:1,fileList:z,onChange:({fileList:e})=>V(e),beforeUpload:()=>!1,accept:".json,.csv,.xls,.xlsx,.pdf",children:s.jsx(w,{icon:s.jsx(O,{}),children:"Selecionar Arquivo"})}),s.jsxs("div",{style:{marginTop:8,color:"#666",fontSize:"12px"},children:["JSON: O conteúdo será salvo no banco.",s.jsx("br",{}),"Outros: O arquivo será anexado."]})]})]}),s.jsxs(h,{title:"RECORRÊNCIA / BLOCOS",size:"small",style:{marginTop:16},children:["arquivo"===H&&z.length>0?s.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginBottom:10},children:[s.jsxs("div",{style:{background:"#fafafa",border:"1px solid #eee",padding:"6px 10px"},children:["REGISTROS NO ARQUIVO: ",s.jsx("strong",{children:ge.registros})]}),s.jsxs("div",{style:{background:"#fafafa",border:"1px solid #eee",padding:"6px 10px"},children:["NÚMEROS REPETIDOS: ",s.jsx("strong",{children:ge.duplicados_distintos})]}),s.jsxs("div",{style:{background:"#fafafa",border:"1px solid #eee",padding:"6px 10px"},children:["NÃO VÃO ENTRAR: ",s.jsx("strong",{children:ge.excluidos})]}),s.jsxs("div",{style:{background:"#f6ffed",border:"1px solid #b7eb8f",padding:"6px 10px"},children:["CONTATOS VÁLIDOS PARA ENVIO: ",s.jsx("strong",{children:ge.validos})]})]}):null,s.jsx(c.Item,{name:"recorrencia_ativa",label:"ATIVAR RECORRÊNCIA",initialValue:!1,children:s.jsxs(x.Group,{value:Y,onChange:e=>{X(!!e.target.value),D.setFieldsValue({recorrencia_ativa:!!e.target.value})},children:[s.jsx(x.Button,{value:!1,children:"NÃO"}),s.jsx(x.Button,{value:!0,children:"SIM"})]})}),s.jsxs(S,{style:{display:"flex",marginBottom:8},align:"start",wrap:!0,children:[s.jsx(c.Item,{name:"total_blocos",label:"TOTAL DE BLOCOS",rules:Y?[{required:!0}]:void 0,children:s.jsx(N,{min:1,max:999,style:{width:160}})}),s.jsx(c.Item,{name:"mensagens_por_bloco",label:"MENSAGENS POR BLOCO",rules:Y?[{required:!0}]:void 0,children:s.jsx(N,{min:1,max:5e3,style:{width:200}})}),s.jsx(c.Item,{name:"blocos_por_dia",label:"BLOCOS POR DIA",rules:Y?[{required:!0}]:void 0,children:s.jsx(N,{min:1,max:24,style:{width:160}})})]}),s.jsxs(S,{style:{display:"flex",marginBottom:8},align:"start",wrap:!0,children:[s.jsx(c.Item,{name:"intervalo_min_seg",label:"INTERVALO MÍNIMO (SEG)",rules:[{required:!0}],children:s.jsx(N,{min:1,max:3600,style:{width:200}})}),s.jsx(c.Item,{name:"intervalo_max_seg",label:"INTERVALO MÁXIMO (SEG)",rules:[{required:!0}],children:s.jsx(N,{min:1,max:3600,style:{width:200}})}),s.jsx(c.Item,{name:"bloco_atual",label:"BLOCO ATUAL",children:s.jsx(N,{min:0,max:999,style:{width:160}})})]})]}),s.jsxs(S,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[s.jsx(w,{onClick:T,icon:s.jsx(I,{}),children:"CANCELAR"}),s.jsx(w,{type:"primary",onClick:async()=>{try{const t=await D.validateFields();if("sim_nao"===B&&!String(G||"").trim())return void L.error("Informe a pergunta (SIM/NÃO)");{const e=Number(t.intervalo_min_seg),a=Number(t.intervalo_max_seg);if(!Number.isFinite(e)||!Number.isFinite(a)||e<=0||a<=0)return void L.error("Informe os intervalos mínimo e máximo em segundos");if(e>a)return void L.error("Intervalo mínimo não pode ser maior que o máximo")}const a=e=>new Promise((t,a)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>t(s.result),s.onerror=e=>a(e)}),s={...t,data_inicio:t.data_inicio?t.data_inicio.format("YYYY-MM-DD"):null,data_fim:t.data_fim?t.data_fim.format("YYYY-MM-DD"):null,meta:se,enviados:ne,nao_enviados:re,positivos:de,negativos:ue,aguardando:pe};if(F.length>0){const e=F[0].originFileObj;e&&(s.imagem=await a(e))}else M?.imagem&&(s.imagem=null);let i=null;const n={text_position:U};if("sim_nao"===B&&(n.response_mode="SIM_NAO",n.question=String(G||"").trim()),Q.length&&(n.evolution_api_ids=Q),"arquivo"===H&&z.length>0){const t=z[0].originFileObj;if(t&&(s.AnexoFile=t,s.anexo_json=JSON.stringify({contacts:[],config:n}),t.name.endsWith(".json"))){const a=await t.text();try{const e=JSON.parse(a),t=e=>String(e??"").replace(/\D/g,""),o=e=>{const a=[],s=new Set;for(const i of e){if(!i||"object"!=typeof i)continue;const e=Object.keys(i),n=e.find(e=>"whatsapp"===String(e).trim().toLowerCase())||e.find(e=>String(e).trim().toLowerCase().includes("whatsapp"))||e.find(e=>["celular","telefone","phone","mobile","tel"].includes(String(e).trim().toLowerCase())),o=n?i[n]:"",r=t(o);r&&(s.has(r)||(s.add(r),n&&(i[n]=r),a.push(i)))}return a};i={contacts:Array.isArray(e)?o(e):[],config:n},s.anexo_json=JSON.stringify(i)}catch(e){return void L.error("Arquivo JSON inválido")}}}else"eleitores"===H&&(s.usar_eleitores=!0,i={source:"eleitores",usar_eleitores:!0,contacts:[],config:n},s.anexo_json=JSON.stringify(i));let o;if(M?.id)await te.updateCampanha(M.id,s),o=M.id,L.success("Campanha atualizada");else{o=(await te.createCampanha(s)).id,L.success("Campanha criada")}"arquivo"===H&&s.AnexoFile&&await te.uploadCampanhaAnexo(o,{file:s.AnexoFile,type:"anexo"}),R()}catch(e){L.error(e?.response?.data?.detail||"Erro ao salvar campanha")}},icon:s.jsx(C,{}),children:"SALVAR"})]})]})]})]})}function ee(){const[e,t]=n.useState([]),[a,l]=n.useState(!1),[d,c]=n.useState(!1),[u,p]=n.useState(null),[g,f]=n.useState([]),[x,v]=n.useState({}),[y,A]=n.useState([]),[_,O]=n.useState([]),[N,I]=n.useState([]),[C,E]=n.useState([]),[ee,te]=n.useState([]),[ae,se]=n.useState(null),ie=o(),{user:ne}=r(),{message:oe,modal:re}=M.useApp(),le=e=>{const t=String(e||"").trim();if(!t)return"";if(/^data:image\//i.test(t)&&/;base64,/i.test(t)){const e=t.split(/;base64,/i)[1]?.trim()||"";return e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://")||e.startsWith("static/")?e.startsWith("static/")?`/${e}`:e:t}return t.startsWith("data:")||t.startsWith("http://")||t.startsWith("https://")||t.startsWith("/static/")?t:t.startsWith("static/")?`/${t}`:t.startsWith("/")?t:/\.(png|jpg|jpeg|bmp|gif|webp)$/i.test(t)?`/static/campanhas/${t}`:t.includes("/")&&!t.startsWith("/")?`/${t}`:`data:image/png;base64,${t}`},de=n.useMemo(()=>1!==_.length?null:e.find(e=>e.id===_[0]),[_,e]),ce=n.useMemo(()=>{const e=de?.conteudo_arquivo;if(!e)return{};try{const t="string"==typeof e?JSON.parse(e):e;if(t&&"object"==typeof t&&!Array.isArray(t)){const e=t.config;if(e&&"object"==typeof e)return e}}catch{}return{}},[ie,de?.id,de?.conteudo_arquivo]),ue=n.useMemo(()=>{if(!de?.id)return null;return`campanhas.eventLogs.${String(ne?.usuario||"default")}.${Number(de.id)}`},[de?.id,ne?.usuario]);n.useEffect(()=>{if(ue){try{const e=localStorage.getItem(ue);if(e){const t=JSON.parse(e);if(Array.isArray(t))return void I(t.map(e=>String(e)))}}catch{}I([`[${m().format("HH:mm:ss")}] Sistema pronto. Aguardando início do disparo.`])}else I([])},[ue]),n.useEffect(()=>{if(ue)try{localStorage.setItem(ue,JSON.stringify((N||[]).slice(-2e3)))}catch{}},[ue,N]);const me=n.useCallback(async()=>{try{const e=await ie.listEvolutionInstances();te(e?.rows||[])}catch{te([])}},[ie]);n.useEffect(()=>{me()},[me]);const pe=n.useMemo(()=>{const e=ce||{},t=e.evolution_api_ids??e.evolution_api_id,a=(Array.isArray(t)?t:null!=t?[t]:[]).map(e=>String(e??"").trim()).filter(e=>!!e),s=ee||[];if(!a.length)return s;const i=new Set(a),n=s.filter(e=>i.has(String(e?.id??"").trim()));return n.length?n:s},[ee,ce]);n.useEffect(()=>{if(!de)return void se(null);if(!pe.length)return void se(null);const e=ae;if("ALL"===e)return;if("string"==typeof e&&pe.some(t=>String(t?.id??"").trim()===e))return;const t=pe.find(e=>"CONNECTED"===String(e?.connectionStatus||"").toUpperCase());se(String((t||pe[0])?.id??"").trim()||null)},[pe,de?.id,ae,de]),n.useEffect(()=>{if(de){let t=[];const a=e=>{const t=String(e??"").trim();if(!t)return null;if("1"===t||"2"===t)return Number(t);const a=t.toLowerCase();return/\bsim\b/.test(a)||"s"===a?1:/\bnao\b/.test(a)||/\bnão\b/.test(a)||"n"===a?2:/^\(?\s*1\b/.test(a)?1:/^\(?\s*2\b/.test(a)?2:null},s=e=>{if(!0===e||!1===e)return e;const t=String(e??"").trim().toLowerCase();return t?"true"===t||"1"===t||"sim"===t||"s"===t||"valido"===t||"válido"===t||"false"!==t&&"0"!==t&&"nao"!==t&&"não"!==t&&"n"!==t&&"invalido"!==t&&"inválido"!==t&&null:null},i=(e,t)=>{if(!e)return"";const a=Object.keys(e);for(const s of t){const t=a.find(e=>e.trim().toLowerCase()===s.trim().toLowerCase());if(t){const a=e[t];if(null==a)continue;if("string"==typeof a&&!a.trim())continue;return a}}return""};if(de.conteudo_arquivo)try{const e=JSON.parse(de.conteudo_arquivo);if(Array.isArray(e)?t=e:e.contacts&&Array.isArray(e.contacts)&&(t=e.contacts),t.length>0){t=t.map((e,t)=>{const n=i(e,["whatsapp","celular","telefone","phone","mobile","tel"]),o=i(e,["nome","name","cliente","full_name","fullname"])||`Contato ${t+1}`,r=i(e,["resposta","response","respondido","reply"]),l=a(r),d=s(i(e,["is_whatsapp","isWhatsapp","whatsapp_valido","whatsappValido"])),c=i(e,["whatsapp_jid","whatsappJid","jid"]);return{id:t,nome:o,whatsapp:n,status:e.status||"waiting",resposta:l,is_whatsapp:null===d?void 0:d,whatsapp_jid:c?String(c):void 0,original:e}}).filter(e=>e.whatsapp);const e=e=>String(e??"").replace(/\D/g,""),n=new Map;for(const a of t){const t=e(a.whatsapp);t&&n.set(t,(n.get(t)||0)+1)}const o=new Set;let r=0,l=0;for(const t of n.values())t>1&&(l++,r+=t-1);t=t.map(t=>({...t,whatsapp:e(t.whatsapp)})).filter(e=>!!String(e.whatsapp||"").trim()).filter(e=>{const t=String(e.whatsapp);return!!t&&(!o.has(t)&&(o.add(t),!0))}),(l>0||r>0)&&I(e=>[...e,`[${m().format("HH:mm:ss")}] LISTA: ${l} número(s) repetido(s), ${r} registro(s) não entrarão. Válidos: ${t.length}.`]),0===t.length&&I(e=>[...e,`[${m().format("HH:mm:ss")}] ERRO: Nenhum contato com 'whatsapp' encontrado.`])}}catch(e){console.error("Erro ao fazer parse do conteudo_arquivo",e),I(e=>[...e,`[${m().format("HH:mm:ss")}] ERRO: Não foi possível ler o arquivo de contatos.`])}else de.usar_eleitores&&(I(e=>[...e,`[${m().format("HH:mm:ss")}] INFO: Esta campanha utiliza a base de Eleitores. Visualização individual não carregada para performance.`]),t=[]);0!==t.length||de.usar_eleitores||I(e=>[...e,`[${m().format("HH:mm:ss")}] AVISO: Nenhum contato válido encontrado no arquivo.`]),E(t);let n=!1;return(async()=>{try{if(!t.length)return;const e=e=>String(e??"").replace(/\D/g,""),a=Array.from(new Set(t.map(t=>e(t.whatsapp)).filter(Boolean)));if(!a.length)return;const[s,i]=await Promise.allSettled([ie.whatsappCheckNumbers({numbers:a}),ie.whatsappPresenceCache({numbers:a})]),o=new Map;if("fulfilled"===s.status)for(const t of s.value?.rows||[]){const a=e(t.number);a&&o.set(a,{is_whatsapp:!!t.is_whatsapp,jid:t.jid??null})}const r=new Map;if("fulfilled"===i.status)for(const t of i.value?.rows||[]){const a=e(t.number);if(!a)continue;const s=t.presence;r.set(a,s?String(s):null)}if(n)return;E(t=>t.map(t=>{const a=e(t.whatsapp),s=o.get(a),i=r.get(a),n={...t.original||{}};return s&&(n.is_whatsapp=s.is_whatsapp,n.whatsapp_jid=s.jid??null),{...t,is_whatsapp:s?s.is_whatsapp:t.is_whatsapp,whatsapp_jid:s?s.jid??null:t.whatsapp_jid,presence:void 0!==i?i:t.presence,original:n}}))}catch{}})(),()=>{n=!0}}E([])},[ie,de?.id,de?.conteudo_arquivo]);const he=n.useMemo(()=>{if(!de)return!1;const e=de.data_inicio,t=de.data_fim;if(!e)return!1;const a=m(),s=m(e),i=m(t||"2100-01-01");return a.isAfter(s.startOf("day"))&&a.isBefore(i.endOf("day"))||a.isSame(s,"day")||a.isSame(i,"day")},[de]),ge=n.useMemo(()=>{if(!de)return!1;return"SIM_NAO"===String((ce||{}).response_mode||"").toUpperCase()},[de,ce]),fe=()=>s.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:[s.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z",fill:"currentColor"}),s.jsx("path",{d:"M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",fill:"currentColor"})]}),xe=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M6 7h12M9 7v10m6-10v10M4 7h16l-1 14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),Se=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M3 4h6v16H3V4zm12 0h6v16h-6V4z",fill:"currentColor"})}),ve=()=>s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:s.jsx("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),je=e=>{if(!e)return{label:"-",color:"default"};const t=m().startOf("day"),a=e.data_inicio?m(e.data_inicio).startOf("day"):null,s=e.data_fim?m(e.data_fim).endOf("day"):null;let i=!1;const n=e.status;return!0!==n&&"true"!==n&&"TRUE"!==n&&"1"!==n&&1!==n&&"ATIVO"!==String(n).toUpperCase()||(i=!0),!1!==n&&"false"!==n&&"FALSE"!==n&&"0"!==n&&0!==n&&"INATIVO"!==String(n).toUpperCase()||(i=!1),i?a&&t.isBefore(a)?{label:"AGENDADO",color:"blue"}:s&&t.isAfter(s)?{label:"INATIVO",color:"red"}:{label:"ATIVO",color:"green"}:{label:"INATIVO",color:"red"}},ye=n.useCallback(async e=>{try{l(!0);if(e?.refreshSchema??0===g.length){const e=await ie.getCampanhasSchema(),t=["id","nome","status","meta","enviados","entregues","visualizados","aguardando","data_inicio","data_fim","created_at"],a={};for(const p of e.columns||[])a[p.name]=p;const s=t.filter(e=>a[e]).map(e=>a[e]),i=(e.columns||[]).filter(e=>!t.includes(e.name));f([...s,...i]);const n={};for(const p of t)a[p]&&(n[p]=!0);for(const p of i)n[p.name]=!1;const o=`campanhas.columns.visible.${ne?.usuario||"default"}`,r=localStorage.getItem(o),l=(()=>{try{return r?JSON.parse(r):null}catch{return null}})();v(l?{...n,...l}:n);const d=`campanhas.columns.order.${ne?.usuario||"default"}`,c=localStorage.getItem(d),u=(()=>{try{return c?JSON.parse(c):null}catch{return null}})(),m=t.filter(e=>a[e]);if(Array.isArray(u)){const e=u.filter(e=>"string"==typeof e&&a[String(e)]),t=new Set(e);for(const a of m)t.has(a)||e.push(a);A(e)}else A(m)}const a=(await ie.getCampanhas()).rows||[];t(a)}catch(a){oe.error(a?.response?.data?.detail||"Erro ao carregar campanhas")}finally{l(!1)}},[ie,g.length,oe,ne]);n.useEffect(()=>{ye({refreshSchema:!0})},[ye]),n.useEffect(()=>{if(!de||!ge)return;const e=globalThis.setInterval(async()=>{"undefined"!=typeof document&&"hidden"===document.visibilityState||await ye({refreshSchema:!1})},15e3);return()=>globalThis.clearInterval(e)},[ge,ye,de?.id]);const Ae=g.map(t=>{const a=t.name,i=Array.from(new Set((e||[]).map(e=>e[a]).filter(e=>null!=e))).slice(0,20).map(e=>({text:String(e).toUpperCase(),value:String(e).toUpperCase()})),n=(t.type||"").toLowerCase(),o=new Set(["id","status","meta","enviados","entregues","visualizados","nao_enviados","positivos","negativos","aguardando","data_inicio","data_fim","created_at"]);return{title:{id:"ID",nome:"NOME DA CAMPANHA",descricao:"DESCRIÇÃO",status:"STATUS",data_inicio:"INÍCIO",data_fim:"FIM",meta:"META",enviados:"ENVIADOS",entregues:"ENTREGUES",visualizados:"VISUALIZADOS",nao_enviados:"NÃO ENVIADOS",positivos:"RESPOSTAS POSITIVAS",negativos:"RESPOSTAS NEGATIVAS",aguardando:"AGUARDANDO RESPOSTAS",created_at:"CRIADO EM"}[a]||a.toUpperCase(),dataIndex:a,align:o.has(a)?"center":"left",filters:i,onFilter:(e,t)=>String(t[a]).toUpperCase()===String(e).toUpperCase(),sorter:(e,t)=>{const s=e[a],i=t[a];return null==s?-1:null==i?1:n.includes("int")||n.includes("numeric")||n.includes("decimal")?Number(s)-Number(i):n.includes("date")||n.includes("timestamp")?new Date(s).getTime()-new Date(i).getTime():String(s).toUpperCase().localeCompare(String(i).toUpperCase())},render:(e,t)=>{if(null==e)return"";if(n.includes("date")||n.includes("timestamp")){const t=new Date(e);if(!isNaN(t.getTime()))return t.toLocaleDateString("pt-BR")}if("status"===a){const{label:e,color:a}=je(t);return s.jsx(T,{color:a,children:e})}return String(e).toUpperCase()},onHeaderCell:()=>({draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain",a)},onDragOver:e=>{e.preventDefault()},onDrop:e=>{const t=e.dataTransfer.getData("text/plain"),s=a;t&&t!==s&&A(e=>{const a=e.filter(e=>e!==t),i=a.indexOf(s);if(-1===i)return e;a.splice(i,0,t);const n=`campanhas.columns.order.${ne?.usuario||"default"}`;return localStorage.setItem(n,JSON.stringify(a)),a})}})}}),be={title:"AÇÕES",dataIndex:"__actions__",align:"center",render:(e,t)=>s.jsxs(S,{children:[s.jsx(w,{type:"text",icon:s.jsx(fe,{}),title:"EDITAR",onClick:()=>{p(t),c(!0)}}),s.jsx(w,{type:"text",danger:!0,icon:s.jsx(xe,{}),title:"DELETAR",onClick:async()=>{try{if(!t.id)return void oe.info("REGISTRO SEM ID");await ie.deleteCampanha(t.id),oe.success("CAMPANHA DELETADA"),await ye()}catch(e){oe.error(e?.response?.data?.detail||"ERRO AO DELETAR CAMPANHA")}}})]})},_e=(y.length?y:Ae.map(e=>e.dataIndex)).map(e=>Ae.find(t=>t.dataIndex===e)).filter(Boolean).filter(e=>x[e.dataIndex]).concat([be]),we=s.jsx("div",{style:{padding:12},children:g.map(e=>s.jsx("div",{style:{marginBottom:6},children:s.jsx(R,{checked:!!x[e.name],onChange:t=>{const a={...x,[e.name]:t.target.checked};v(a);const s=`campanhas.columns.visible.${ne?.usuario||"default"}`;localStorage.setItem(s,JSON.stringify(a))},children:e.name.toUpperCase()})},e.name))});return s.jsxs(i.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[s.jsx(h,{size:"small",style:{marginBottom:16,background:"#fafafa"},styles:{body:{padding:"12px"}},children:s.jsxs(D,{gutter:16,align:"middle",children:[s.jsx(L,{span:16,children:s.jsxs(D,{gutter:8,wrap:!1,children:[s.jsx(L,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f0f5ff",borderColor:"#adc6ff"},children:s.jsx($,{title:"META",value:de?.meta||0,valueStyle:{color:"#2f54eb",fontSize:"18px"},prefix:s.jsx(b,{})})})}),s.jsx(L,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fff0f6",borderColor:"#ffadd2"},children:s.jsx($,{title:"DISPAROS",value:(de?.enviados||0)+(de?.nao_enviados||0),valueStyle:{color:"#eb2f96",fontSize:"18px"},prefix:s.jsx(H,{})})})}),s.jsx(L,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f6ffed",borderColor:"#b7eb8f"},children:s.jsx($,{title:"ENVIADOS",value:de?.enviados||0,valueStyle:{color:"#3f8600",fontSize:"18px"},prefix:s.jsx(k,{})})})}),s.jsx(L,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fff1f0",borderColor:"#ffa39e"},children:s.jsx($,{title:"NÃO ENV.",value:de?.nao_enviados||0,valueStyle:{color:"#cf1322",fontSize:"18px"},prefix:s.jsx(z,{})})})}),s.jsx(L,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#e6f7ff",borderColor:"#91d5ff"},children:s.jsx($,{title:"RESPOSTAS POSITIVAS",value:de?.positivos||0,valueStyle:{color:"#096dd9",fontSize:"18px"}})})}),s.jsx(L,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#fffbe6",borderColor:"#ffe58f"},children:s.jsx($,{title:"RESPOSTAS NEGATIVAS",value:de?.negativos||0,valueStyle:{color:"#d48806",fontSize:"18px"}})})}),s.jsx(L,{flex:"1",children:s.jsx(h,{size:"small",style:{textAlign:"center",background:"#f9f0ff",borderColor:"#d3adf7"},children:s.jsx($,{title:"AGUARDANDO RESPOSTAS",value:ge&&de?.aguardando||0,valueStyle:{color:"#722ed1",fontSize:"18px"},prefix:s.jsx(V,{spin:ge&&(de?.aguardando||0)>0})})})})]})}),s.jsxs(L,{span:8,style:{display:"flex",alignItems:"center",justifyContent:"space-between",borderLeft:"1px solid #e8e8e8",paddingLeft:16},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[de?.imagem?s.jsx(F,{src:le(de.imagem),height:60,width:60,style:{objectFit:"cover",borderRadius:4},alt:"Campanha"}):s.jsx("div",{style:{width:60,height:60,background:"#eee",borderRadius:4,display:"flex",alignItems:"center",justifyContent:"center",color:"#999"},children:s.jsx(P,{style:{fontSize:24}})}),s.jsx("div",{style:{fontSize:12,color:"#666"},children:de?s.jsxs(s.Fragment,{children:[s.jsx("strong",{children:de.nome}),s.jsx("br",{}),s.jsx("span",{style:{fontSize:10},children:(()=>{const e=je(de);return s.jsx(T,{color:e.color,style:{margin:0},children:e.label})})()})]}):s.jsx("span",{children:"Selecione uma campanha"})})]}),s.jsxs("div",{style:{display:"flex",gap:8},children:[s.jsx(j,{value:ae??void 0,placeholder:"Instância Evolution",style:{minWidth:220},disabled:!de||!pe.length,options:[{value:"ALL",label:"TODAS AS INSTÂNCIAS (ALTERNAR)"},...(pe||[]).map(e=>{const t=String(e?.connectionStatus||"").toUpperCase(),a=String(e?.name||e?.nome||e?.id),s=String(e?.number||"").trim(),i=`${a}${s?` - ${s}`:""}${t?` (${t})`:""}`;return{value:String(e?.id??"").trim(),label:i}})],onChange:e=>{se("ALL"===e?"ALL":(e?String(e).trim():null)||null)},allowClear:!0}),s.jsx(U,{title:"Atualizar dados e respostas da campanha",children:s.jsx(w,{onClick:async()=>{if(de){oe.loading({content:"Atualizando...",key:"refresh"});try{await ye({refreshSchema:!0}),oe.success({content:"Atualizado!",key:"refresh"})}catch{oe.error({content:"Erro ao atualizar",key:"refresh"})}}},disabled:!de,icon:s.jsx(V,{}),children:"ATUALIZAR"})}),s.jsx(U,{title:"Resetar todos os contatos e contadores",children:s.jsx(w,{onClick:()=>{de&&re.confirm({title:"RESETAR CAMPANHA",content:'Deseja realmente resetar esta campanha? Todos os contatos voltarão para o status "Aguardando" e os contadores serão zerados (exceto META).',okText:"SIM, RESETAR",cancelText:"CANCELAR",onOk:async()=>{oe.loading({content:"Resetando campanha...",key:"reset"});try{await ie.resetCampanhaDisparos(de.id);const a=C.map(e=>{const t={...e.original,status:"waiting"};return t&&(delete t.resposta,delete t.response,delete t.respondido_em,delete t.respondidoEm,delete t.enviado_em,delete t.enviadoEm),{...e,status:"waiting",original:t}}),s={enviados:0,nao_enviados:0,positivos:0,negativos:0,aguardando:0};let i=a.map(e=>e.original);if(de.conteudo_arquivo)try{const e=JSON.parse(de.conteudo_arquivo);!Array.isArray(e)&&e.contacts&&(i={...e,contacts:i})}catch(e){}await ie.updateCampanha(de.id,{...s,anexo_json:i,status:"ATIVO"}),E(a),t(e=>e.map(e=>e.id===de.id?{...e,...s,status:"ATIVO"}:e));try{ue&&localStorage.removeItem(ue)}catch{}I([`[${m().format("HH:mm:ss")}] Sistema pronto. Aguardando início do disparo.`,`[${m().format("HH:mm:ss")}] CAMPANHA RESETADA.`]),oe.success({content:"Campanha resetada com sucesso!",key:"reset"}),await ye()}catch(e){console.error(e),oe.error({content:"Erro ao resetar campanha",key:"reset"})}}})},disabled:!de,icon:s.jsx(q,{}),danger:!0,children:"RESETAR"})}),s.jsx(U,{title:de?he?"Iniciar automação":"Fora do período de vigência":"Selecione uma campanha",children:s.jsx(w,{onClick:async()=>{if(de){oe.loading({content:"Iniciando automação...",key:"envio"}),I(e=>[...e,`[${m().format("HH:mm:ss")}] INICIANDO DISPARO DA CAMPANHA: ${de.nome}`]);try{I(e=>[...e,`[${m().format("HH:mm:ss")}] Verificando conexão com EvolutionAPI...`]);const s=C.filter(e=>"success"!==e.status);I(e=>[...e,`[${m().format("HH:mm:ss")}] Iniciando envio para ${s.length} contatos.`]);let i=[...C],n=0,o=0,r=0;const l=de.imagem?le(de.imagem):void 0,d=(()=>ce||{})(),c="SIM_NAO"===String(d.response_mode||"").toUpperCase(),u=(()=>{const e=d.evolution_api_ids??d.evolution_api_id;return(Array.isArray(e)?e:null!=e?[e]:[]).map(e=>String(e??"").trim()).filter(e=>!!e)})(),p=Math.max(0,(de.enviados||0)-((de.positivos||0)+(de.negativos||0))),h=c?void 0!==de.aguardando&&null!==de.aguardando?Number(de.aguardando||0):p:0,g=!!de.recorrencia_ativa,f=Number(de.total_blocos??5),x=Number(de.mensagens_por_bloco??500),S=Number(de.blocos_por_dia??1);let v=Number(de.bloco_atual??0);const j=Number(de.intervalo_min_seg??5),y=Number(de.intervalo_max_seg??120),A=Math.max(1,Math.min(j,y)),b=Math.max(1,Math.max(j,y)),_=g?Math.max(1,Math.floor(x)):Number.POSITIVE_INFINITY;if(g&&Number.isFinite(f)&&v>=f)return I(e=>[...e,`[${m().format("HH:mm:ss")}] RECORRÊNCIA ENCERRADA: blocos concluídos (${v}/${f}).`]),void oe.warning({content:"Recorrência já concluiu todos os blocos.",key:"envio"});g&&I(e=>[...e,`[${m().format("HH:mm:ss")}] RECORRÊNCIA ATIVA: bloco ${v+1}/${f}, até ${_} mensagens, intervalo ${A}s-${b}s.`]);let w=0,O=0,N=null;const M=(()=>{if("ALL"!==ae)return[];const e=pe||[],t=e.filter(e=>"CONNECTED"===String(e?.connectionStatus||"").toUpperCase());return(t.length?t:e).filter(e=>!!String(e?.id??"").trim())})();try{const e=e=>String(e??"").replace(/\D/g,""),t=Array.from(new Set(i.filter(e=>"boolean"!=typeof e.is_whatsapp).map(t=>e(t.whatsapp)).filter(Boolean)));if(t.length){I(e=>[...e,`[${m().format("HH:mm:ss")}] Validando números no WhatsApp (${t.length})...`]);const a="string"==typeof ae&&ae&&"ALL"!==ae?ae:void 0,s=await ie.whatsappCheckNumbers({numbers:t,evolution_api_id:a}),n=new Map;for(const t of s?.rows||[]){const a=e(t.number);a&&n.set(a,{is_whatsapp:!!t.is_whatsapp,jid:t.jid??null})}i=i.map(t=>{const a=e(t.whatsapp),s=n.get(a);return s?{...t,is_whatsapp:s.is_whatsapp,whatsapp_jid:s.jid??null,original:{...t.original||{},is_whatsapp:s.is_whatsapp,whatsapp_jid:s.jid??null}}:t}),E([...i])}}catch{}for(let a=0;a<i.length&&!(w>=_);a++){const s=i[a];if("success"===s.status)continue;w++;const p=O;O++,I(e=>[...e,`[${m().format("HH:mm:ss")}] Enviando mensagem para ${s.nome} (${s.whatsapp})...`]);const g=s.status;let f=!1,x="";if(!1===s.is_whatsapp)f=!1,x="Número não possui WhatsApp";else try{let e=String(de.descricao??"");const t=s.nome||"";if(e=e.replace(/\(NOME\)/gi,t).replace(/\{NOME\}/gi,t).replace(/\(NAME\)/gi,t).replace(/\{NAME\}/gi,t),0===p&&I(t=>[...t,`[${m().format("HH:mm:ss")}] DEBUG: Exemplo de mensagem resolvida: "${e}"`]),c){const t=String(d.question||"").trim(),a=[e.trim()];t&&a.push(t),a.push("RESPONDA:\n1 - SIM\n2 - NÃO"),e=a.filter(Boolean).join("\n\n")}let a=d.text_position||"bottom";if(!e.trim()&&!l)throw new Error("Mensagem vazia");const i="ALL"===ae?M.length?String(M[p%M.length]?.id??"").trim():void 0:"string"==typeof ae?ae:u.length?u[p%u.length]:void 0;await ie.sendWhatsAppMessage(String(s.whatsapp),e,l,a,{campanha_id:de.id,contato_nome:s.nome,evolution_api_id:i??void 0}),f=!0}catch(e){console.error(e),f=!1,x=e.response?.data?.detail||e.message||"Erro desconhecido"}const S=Date.now();N=S;const v=f?new Date(S).toISOString():void 0,j={...s.original||{}};f&&v&&(j.enviado_em=v),"boolean"==typeof s.is_whatsapp&&(j.is_whatsapp=s.is_whatsapp),void 0!==s.whatsapp_jid&&(j.whatsapp_jid=s.whatsapp_jid),void 0!==s.resposta&&null!==s.resposta&&(j.resposta=s.resposta),s.respondido_em&&(j.respondido_em=s.respondido_em),i[a]={...s,status:f?"success":"error",original:j},f?(n++,"error"===g&&o--,c&&r++):"waiting"===g&&o++,E([...i]),t(e=>e.map(e=>e.id===de.id?{...e,enviados:(de.enviados||0)+n,nao_enviados:(de.nao_enviados||0)+o,aguardando:c?Math.max(0,h+r):0}:e)),I(f?e=>[...e,`[${m().format("HH:mm:ss")}] [SUCESSO] Mensagem entregue para ${s.whatsapp}`]:e=>[...e,`[${m().format("HH:mm:ss")}] [ERRO] Falha ao entregar para ${s.whatsapp}: ${x}`]);const y=Number.isFinite(A)&&Number.isFinite(b)&&A>0&&b>0?Math.floor(Math.random()*(b-A+1))+A:1,_=(N??Date.now())+1e3*y,C=Math.max(0,_-Date.now());I(e=>[...e,`[${m().format("HH:mm:ss")}] INTERVALO: aguardando ${Math.ceil(C/1e3)}s (range ${A}-${b}).`]),await new Promise(e=>globalThis.setTimeout(e,C))}I(e=>[...e,`[${m().format("HH:mm:ss")}] DISPARO FINALIZADO.`]);try{const e=i.map(e=>{const t={...e.original||{}};return"boolean"==typeof e.is_whatsapp&&(t.is_whatsapp=e.is_whatsapp),void 0!==e.whatsapp_jid&&(t.whatsapp_jid=e.whatsapp_jid),void 0!==e.resposta&&null!==e.resposta&&(t.resposta=e.resposta),e.respondido_em&&(t.respondido_em=e.respondido_em),t.status=e.status,t});let t=e;if(de.conteudo_arquivo)try{const a=JSON.parse(de.conteudo_arquivo);!Array.isArray(a)&&a.contacts&&(t={...a,contacts:e})}catch{}const a=g&&w>0,s=a?v+1:v,l=(()=>{if(!g||!a)return;const e=Number.isFinite(S)&&S>0?S:1;if(1===e)return m().add(1,"day").toISOString();const t=Math.max(1,Math.floor(1440/e));return m().add(t,"minute").toISOString()})();await ie.updateCampanha(de.id,{status:"ATIVO",enviados:(de.enviados||0)+n,nao_enviados:(de.nao_enviados||0)+o,aguardando:c?Math.max(0,h+r):0,anexo_json:t,...g?{bloco_atual:s,proxima_execucao:l}:{}}),ye({refreshSchema:!1})}catch(a){console.error("Erro ao atualizar status da campanha",a),I(e=>[...e,`[${m().format("HH:mm:ss")}] ERRO AO SALVAR NO BANCO: ${a}`])}oe.success({content:"Automação finalizada!",key:"envio"})}catch(s){I(e=>[...e,`[${m().format("HH:mm:ss")}] ERRO CRÍTICO: ${s}`]),oe.error({content:"Erro ao iniciar automação",key:"envio"})}}},disabled:!he,icon:s.jsx(B,{}),type:"primary",style:{background:he?"#52c41a":void 0,borderColor:he?"#52c41a":void 0},children:"ENVIAR"})})]})]})]})}),s.jsxs(D,{gutter:16,style:{marginBottom:16},children:[s.jsx(L,{span:6,children:s.jsxs(h,{size:"small",title:"Status dos Contatos",styles:{body:{padding:0,height:400,overflowY:"auto"}},children:[s.jsx(W,{size:"small",dataSource:C,renderItem:e=>s.jsx(W.Item,{style:{padding:"8px 12px"},children:s.jsxs(S,{children:["success"===e.status&&s.jsx(G,{style:{color:"#52c41a"}}),"error"===e.status&&s.jsx(J,{style:{color:"#ff4d4f"}}),"waiting"===e.status&&s.jsx(H,{style:{color:"#faad14"}}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:500},children:e.nome}),s.jsx("div",{style:{fontSize:11,color:"#999"},children:e.whatsapp})]}),!0===e.is_whatsapp&&s.jsx(T,{color:"green",style:{marginLeft:6},children:"WHATSAPP VÁLIDO"}),!1===e.is_whatsapp&&s.jsx(T,{color:"red",style:{marginLeft:6},children:"WHATSAPP INVÁLIDO"}),(()=>{const t=String(e.presence||"").toLowerCase().trim();return t?"available"===t||"online"===t?s.jsx(T,{color:"green",style:{marginLeft:6},children:"ONLINE"}):"unavailable"===t||"offline"===t?s.jsx(T,{style:{marginLeft:6},children:"OFFLINE"}):"composing"===t||"typing"===t?s.jsx(T,{color:"blue",style:{marginLeft:6},children:"DIGITANDO"}):"recording"===t?s.jsx(T,{color:"purple",style:{marginLeft:6},children:"GRAVANDO"}):s.jsx(T,{style:{marginLeft:6},children:t.toUpperCase()}):null})(),1===e.resposta&&s.jsx(T,{color:"green",style:{marginLeft:6},children:"SIM"}),2===e.resposta&&s.jsx(T,{color:"red",style:{marginLeft:6},children:"NÃO"})]})})}),0===C.length&&s.jsx("div",{style:{padding:16,textAlign:"center",color:"#999"},children:de?"Nenhum contato na lista":"Selecione uma campanha"})]})}),s.jsx(L,{span:8,children:s.jsx(h,{size:"small",title:"Preview da Mensagem",styles:{body:{padding:0,height:400,background:"#e5ddd5",display:"flex",flexDirection:"column"}},children:s.jsx("div",{style:{flex:1,padding:20,overflowY:"auto",backgroundImage:'url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png")',backgroundSize:"contain"},children:de?s.jsxs("div",{style:{background:"#fff",borderRadius:"0 8px 8px 8px",padding:8,maxWidth:"85%",boxShadow:"0 1px 1px rgba(0,0,0,0.1)"},children:[de.imagem&&s.jsx(F,{src:le(de.imagem),style:{width:"100%",borderRadius:8,marginBottom:8},preview:!1}),s.jsx("div",{style:{fontSize:14,lineHeight:"1.4",color:"#303030",whiteSpace:"pre-wrap"},children:(()=>{const e=ce||{};let t=String(de.descricao||"").trim();if("SIM_NAO"===String(e.response_mode||"").toUpperCase()){const a=String(e.question||"").trim(),s=[t];a&&s.push(a),s.push("RESPONDA:\n1 - SIM\n2 - NÃO"),t=s.filter(Boolean).join("\n\n")}return t||"Sem texto"})()}),s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",marginTop:4,gap:4},children:[s.jsx("span",{style:{fontSize:11,color:"#999"},children:m().format("HH:mm")}),s.jsx(G,{style:{fontSize:14,color:"#34b7f1"}})]})]}):s.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",color:"#999",flexDirection:"column",gap:8},children:[s.jsx(Y,{style:{fontSize:32}}),s.jsx("span",{children:"Selecione uma campanha para visualizar o preview"})]})})})}),s.jsx(L,{span:10,children:s.jsx(h,{size:"small",title:"Log de Eventos (Caixa Preta)",styles:{body:{padding:12,height:400,background:"#000",color:"#0f0",fontFamily:"monospace",overflowY:"auto"}},children:N.length>0?s.jsx("ul",{style:{listStyle:"none",padding:0,margin:0},children:N.map((e,t)=>s.jsxs("li",{style:{marginBottom:4,borderBottom:"1px solid #333",paddingBottom:2},children:[s.jsx(X,{style:{fontSize:10,marginRight:8}}),e]},t))}):s.jsx("div",{style:{color:"#666"},children:"Aguardando eventos..."})})})]}),s.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:s.jsxs(S,{children:[s.jsx(Z,{placement:"bottomRight",trigger:["click"],menu:{items:[]},popupRender:()=>we,children:s.jsx(w,{shape:"circle",icon:s.jsx(Se,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},title:"VISUALIZAÇÃO DE COLUNAS"})}),s.jsx(w,{shape:"circle",icon:s.jsx(ve,{}),style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},onClick:()=>{p(null),c(!0)},title:"NOVA CAMPANHA"})]})}),s.jsx("style",{children:"\n        .campanhas-table .ant-table-thead > tr > th{ background:#FFD700; color:#000; font-family: 'Arimo', Arial, sans-serif; }\n        .campanhas-table .ant-table-thead > tr > th .ant-table-column-title{ display:flex; justify-content:center; align-items:center; text-align:center; }\n        .campanhas-table .ant-table-tbody > tr > td{ font-family: 'Roboto Condensed', Arial, sans-serif; padding:2px 6px; line-height:0.95; height:22px; }\n      "}),s.jsx(K,{loading:a,dataSource:e,columns:_e,rowKey:"id",bordered:!0,size:"small",className:"ant-table-striped campanhas-table",rowSelection:{type:"radio",selectedRowKeys:_,onChange:e=>O(e)},onRow:e=>({onClick:()=>O([e.id])})}),s.jsx(Q,{open:d,initial:u||void 0,onCancel:()=>c(!1),onSaved:async()=>{c(!1),await ye()}})]})}export{ee as default};
