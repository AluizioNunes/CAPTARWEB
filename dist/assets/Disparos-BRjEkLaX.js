import{j as e,m as r}from"./utils-CdldNp8C.js";import{r as t}from"./react-vendor-qiAl16-a.js";import{u as n}from"./index-BWWBunTH.js";import{l as a,T as s,K as o,N as i,C as l,S as c,f as d,Z as u,t as m,B as g,_ as p,v as S}from"./ui-vendor-CMHmWg4l.js";function h(){const[h,x]=t.useState(!1),[A,j]=t.useState([]),[N,f]=t.useState([]),[w,I]=t.useState(null),[O,D]=t.useState(null),[b,E]=t.useState(""),[T,_]=t.useState(!1),[y,C]=t.useState({}),[v,U]=t.useState({current:1,pageSize:50}),z=n(),{message:R}=a.useApp(),V=e=>{const r=String(e).toUpperCase().trim();return"ENVIADO"===r||"ENTREGUE"===r||"VISUALIZADO"===r?"green":"FALHA"===r?"red":"PENDENTE"===r?"default":"blue"},L=e=>{const r=String(e).toUpperCase().trim();return"POSITIVO"===r?"green":"NEGATIVO"===r?"red":"AGUARDANDO"===r?"default":"blue"},P=t.useMemo(()=>{const r=[{title:"NOME",dataIndex:"nome",align:"left",sorter:(e,r)=>String(e.nome||"").localeCompare(String(r.nome||""))},{title:"NÚMERO",dataIndex:"numero",align:"left",sorter:(e,r)=>String(e.numero||"").localeCompare(String(r.numero||"")),render:r=>{const t=String(r||"").trim(),n=t?y[t]:void 0;return e.jsxs(c,{size:8,wrap:!0,children:[e.jsx("span",{children:t||"—"}),!0===n?e.jsx(s,{color:"green",children:"WHATSAPP VÁLIDO"}):null,!1===n?e.jsx(s,{color:"red",children:"WHATSAPP INVÁLIDO"}):null]})}},{title:"STATUS ENVIO",dataIndex:"envio_status",align:"center",render:r=>{const t=String(r||"").toUpperCase()||"—";return e.jsx(s,{color:V(t),children:t})}},{title:"DATA ENVIO",dataIndex:"envio_datahora",align:"center",render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—",sorter:(e,r)=>new Date(e.envio_datahora||0).getTime()-new Date(r.envio_datahora||0).getTime()},{title:"ENTREGUE",dataIndex:"entregue_em",align:"center",render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—",sorter:(e,r)=>new Date(e.entregue_em||0).getTime()-new Date(r.entregue_em||0).getTime()},{title:"VISUALIZADO",dataIndex:"visualizado_em",align:"center",render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—",sorter:(e,r)=>new Date(e.visualizado_em||0).getTime()-new Date(r.visualizado_em||0).getTime()},{title:"STATUS DA MENSAGEM",dataIndex:"__status_mensagem__",align:"center",render:(r,t)=>{const n=!!t?.entregue_em,a=!!t?.visualizado_em;return n?e.jsxs(c,{size:6,wrap:!0,children:[e.jsx(s,{color:"green",children:"RECEBIDO"}),a?e.jsx(s,{color:"blue",children:"VISUALIZADO"}):e.jsx(s,{children:"AGUARDANDO VISUALIZAÇÃO"})]}):e.jsx(s,{color:"red",children:"NÃO RECEBIDO"})}}];return T?[...r,{title:"RESPOSTA",dataIndex:"resposta_classificacao",align:"center",render:r=>{const t=String(r||"").toUpperCase()||"—";return e.jsx(s,{color:L(t),children:t})}},{title:"DATA RESPOSTA",dataIndex:"resposta_datahora",align:"center",render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—",sorter:(e,r)=>new Date(e.resposta_datahora||0).getTime()-new Date(r.resposta_datahora||0).getTime()}]:r},[T,y]),B=async e=>{const r="number"==typeof e?e:w;if(r)try{x(!0),C({}),U({current:1,pageSize:50});const e=await z.getCampanhaDisparosGrid(r),t=e.rows||[];j(t),D(e.stats||null),E(String(e.pergunta||""));try{const r=e?.campanha?.anexo_json,t="string"==typeof r?JSON.parse(r):r,n=t?.config||{};_("SIM_NAO"===String(n?.response_mode||"").toUpperCase())}catch{_(!1)}try{const e=t.slice(0,50),r=Array.from(new Set(e.map(e=>String(e?.numero||"").trim()).filter(Boolean)));if(r.length){const e=await z.whatsappCheckNumbers({numbers:r}),t={};for(const r of e?.rows||[]){const e=String(r?.number||"").trim();e&&(t[e]=!!r?.is_whatsapp)}C(t)}}catch{}}catch(t){R.error(t?.response?.data?.detail||"Erro ao carregar disparos da campanha")}finally{x(!1)}};t.useEffect(()=>{(async()=>{try{x(!0);const e=(await z.getCampanhas()).rows||[];if(f(e),e.length&&null===w){const r=e[0];r?.id&&I(Number(r.id))}}catch(e){R.error(e?.response?.data?.detail||"Erro ao carregar campanhas")}finally{x(!1)}})()},[]),t.useEffect(()=>{w&&B(w)},[w]);const G=t.useMemo(()=>(N||[]).map(e=>({label:`${String(e.nome||"").toUpperCase()} (${e.id})`,value:Number(e.id)})),[N]),M=t.useMemo(()=>N.find(e=>Number(e.id)===Number(w)),[N,w]);return e.jsx(r.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs(o,{gutter:[16,16],children:[e.jsx(i,{span:24,children:e.jsx(l,{children:e.jsxs(c,{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[e.jsxs(c,{children:[e.jsx(d,{}),e.jsx(u.Title,{level:4,style:{margin:0},children:"AUTOMAÇÃO • DISPAROS"})]}),e.jsxs(c,{children:[e.jsx(m,{style:{width:420},placeholder:"Selecione uma campanha",showSearch:!0,optionFilterProp:"label",value:w??void 0,options:G,onChange:e=>I(Number(e))}),e.jsx(g,{icon:e.jsx(p,{}),onClick:()=>B(),children:"Atualizar"})]})]})})}),e.jsx(i,{span:24,children:e.jsxs(l,{children:[e.jsxs(c,{style:{marginBottom:12,width:"100%",justifyContent:"space-between"},children:[e.jsxs(c,{children:[e.jsx(u.Text,{strong:!0,children:M?String(M.nome||"").toUpperCase():"—"}),b?e.jsx(s,{color:"blue",children:b}):null]}),e.jsxs(c,{wrap:!0,children:[e.jsxs(s,{color:"default",children:["CONTATOS: ",Number(O?.total_contatos||0)]}),e.jsxs(s,{color:"green",children:["ENVIADOS: ",Number(O?.enviados||0)]}),e.jsxs(s,{color:"green",children:["ENTREGUES: ",Number(O?.entregues||0)]}),e.jsxs(s,{color:"green",children:["VISUALIZADOS: ",Number(O?.visualizados||0)]}),e.jsxs(s,{color:"red",children:["FALHAS: ",Number(O?.falhas||0)]}),T&&e.jsxs(s,{color:"blue",children:["RESPOSTAS: ",Number(O?.respostas||0)]}),T&&e.jsxs(s,{color:"green",children:["POSITIVOS: ",Number(O?.positivos||0)]}),T&&e.jsxs(s,{color:"red",children:["NEGATIVOS: ",Number(O?.negativos||0)]}),T&&e.jsxs(s,{color:"default",children:["AGUARDANDO: ",Number(O?.aguardando||0)]})]})]}),e.jsx(S,{rowKey:e=>String(e.numero||JSON.stringify(e)),loading:h,dataSource:A,columns:P,size:"small",bordered:!0,pagination:{pageSize:v.pageSize,current:v.current,showSizeChanger:!0},onChange:async(e,r,t,n)=>{const a={current:Number(e?.current||1),pageSize:Number(e?.pageSize||50)};U(a);try{const e=(a.current-1)*a.pageSize,r=(n?.currentDataSource||A).slice(e,e+a.pageSize),t=Array.from(new Set(r.map(e=>String(e?.numero||"").trim()).filter(Boolean))).filter(e=>void 0===y[e]);if(!t.length)return;const s=await z.whatsappCheckNumbers({numbers:t}),o=s?.rows||[];C(e=>{const r={...e};for(const t of o){const e=String(t?.number||"").trim();e&&(r[e]=!!t?.is_whatsapp)}return r})}catch{}}})]})})]})})}export{h as default};
