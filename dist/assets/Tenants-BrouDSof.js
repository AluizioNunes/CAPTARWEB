import{p as e,i as t,g as a,j as n,m as s}from"./utils-CdldNp8C.js";import{r}from"./react-vendor-qiAl16-a.js";import{u as l,b as o,p as i,L as d}from"./index-By6kXOGT.js";import{F as c,i as u,I as m,t as p,S as g,B as x,q as f,r as S,A as h,s as y,h as j,D as b,w as C,m as I,T}from"./ui-vendor-BtVq8T1Y.js";function N({open:s,initial:y,onCancel:j,onSaved:b}){const[C]=c.useForm(),I=l(),{user:T}=o(),[N,A]=r.useState(""),v=r.useMemo(()=>{const a=T?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const s=new Date(a);return isNaN(s.getTime())?null:s},[T]),D=v?a(v,"dd/MM/yyyy HH:mm",{locale:i}):"",O=String(localStorage.getItem("tenantSlug")||"captar"),_=String(localStorage.getItem("tenantName")||"CAPTAR");r.useEffect(()=>{const e=()=>{if(!v)return void A("");const e=Date.now()-v.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),s=String(t).padStart(2,"0"),r=String(a).padStart(2,"0"),l=String(n).padStart(2,"0");A(`${s}:${r}:${l}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[v]),r.useEffect(()=>{s&&(y?C.setFieldsValue({Nome:y.Nome,Slug:y.Slug,Status:y.Status,Plano:y.Plano}):C.resetFields())},[s,y]);return n.jsxs(u,{open:s,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(_||O).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:T?.usuario?String(T?.usuario).toUpperCase():String(T?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(T?.funcao||"").toUpperCase()} | PERFIL: ${String(T?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${D||"--"} | TEMPO CONECTADO: ${N||"--:--:--"}`})]}),n.jsx(h,{size:"large"})]})]}),onCancel:j,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; } .tenants-modal .ant-form-item{ margin-bottom:6px; }"}),n.jsxs(c,{form:C,layout:"vertical",children:[n.jsx("div",{style:{display:"grid",gap:16},children:n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16},children:[n.jsxs("div",{children:[n.jsx(c.Item,{name:"Nome",label:"Nome",rules:[{required:!0}],children:n.jsx(m,{})}),n.jsx(c.Item,{name:"Slug",label:"Slug",rules:[{required:!0}],children:n.jsx(m,{})})]}),n.jsxs("div",{children:[n.jsx(c.Item,{name:"Status",label:"Status",children:n.jsx(p,{options:[{value:"ATIVO",label:"ATIVO"},{value:"INATIVO",label:"INATIVO"}]})}),n.jsx(c.Item,{name:"Plano",label:"Plano",children:n.jsx(p,{options:[{value:"PADRAO",label:"PADRÃO"},{value:"PRO",label:"PRO"}]})})]})]})}),n.jsxs(g,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(x,{onClick:j,icon:n.jsx(f,{}),children:"CANCELAR"}),n.jsx(x,{type:"primary",onClick:async()=>{try{const e=await C.validateFields();if(y?.IdTenant){await I.updateTenant(y.IdTenant,e);const t={...y,...e};b(t)}else{const t={IdTenant:(await I.createTenant(e)).id,Nome:e.Nome,Slug:e.Slug,Status:e.Status??"ATIVO",Plano:e.Plano??"PADRAO"};b(t)}}catch{}},icon:n.jsx(S,{}),children:"SALVAR"})]})]})]})}function A({open:s,initial:p,onCancel:j,onSaved:b}){const[C]=c.useForm(),I=l(),{user:T}=o(),[N,A]=r.useState(""),v=r.useMemo(()=>{const a=T?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const s=new Date(a);return isNaN(s.getTime())?null:s},[T]),D=v?a(v,"dd/MM/yyyy HH:mm",{locale:i}):"",O=String(localStorage.getItem("tenantSlug")||"captar"),_=String(localStorage.getItem("tenantName")||"CAPTAR");r.useEffect(()=>{s&&(p?C.setFieldsValue(p):C.resetFields())},[s,p]),r.useEffect(()=>{const e=()=>{if(!v)return void A("");const e=Date.now()-v.getTime(),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),s=String(t).padStart(2,"0"),r=String(a).padStart(2,"0"),l=String(n).padStart(2,"0");A(`${s}:${r}:${l}`)};e();const t=setInterval(e,1e3);return()=>clearInterval(t)},[v]);return n.jsxs(u,{open:s,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(_||O).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:T?.usuario?String(T?.usuario).toUpperCase():String(T?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(T?.funcao||"").toUpperCase()} | PERFIL: ${String(T?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${D||"--"} | TEMPO CONECTADO: ${N||"--:--:--"}`})]}),n.jsx(h,{size:"large"})]})]}),onCancel:j,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; } .tenants-modal .ant-form-item{ margin-bottom:6px; }"}),n.jsxs(c,{form:C,layout:"vertical",children:[n.jsx(c.Item,{name:"nome",label:"Nome",rules:[{required:!0}],children:n.jsx(m,{})}),n.jsx(c.Item,{name:"slug",label:"Slug",rules:[{required:!0}],children:n.jsx(m,{})}),n.jsx(c.Item,{name:"db_name",label:"Nome do Banco",rules:[{required:!0}],children:n.jsx(m,{})}),n.jsx(c.Item,{name:"db_host",label:"Host",rules:[{required:!0}],children:n.jsx(m,{})}),n.jsx(c.Item,{name:"db_port",label:"Porta",rules:[{required:!0}],children:n.jsx(m,{})}),n.jsx(c.Item,{name:"db_user",label:"Usuário",rules:[{required:!0}],children:n.jsx(m,{})}),n.jsx(c.Item,{name:"db_password",label:"Senha",rules:[{required:!0}],children:n.jsx(m.Password,{})}),n.jsxs(g,{style:{marginTop:16,display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(x,{onClick:j,icon:n.jsx(f,{}),children:"CANCELAR"}),n.jsx(x,{type:"primary",onClick:async()=>{try{const e=await C.validateFields(),t=await I.provisionTenant(e);y.success(`Banco provisionado: ${t.dsn}`),b({idTenant:t.idTenant,dsn:t.dsn})}catch(e){y.error(e?.response?.data?.detail||"Erro ao provisionar banco")}},icon:n.jsx(S,{}),children:"SALVAR"})]})]})]})}function v({open:s,dsn:l,onCancel:c}){const{user:m}=o(),[p]=r.useState(""),g=r.useMemo(()=>{const a=m?.login_time;if(!a)return null;const n=e(a);if(t(n))return n;const s=new Date(a);return isNaN(s.getTime())?null:s},[m]),x=g?a(g,"dd/MM/yyyy HH:mm",{locale:i}):"",f=String(localStorage.getItem("tenantSlug")||"captar"),S=String(localStorage.getItem("tenantName")||"CAPTAR");return n.jsxs(u,{open:s,title:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[n.jsxs("div",{className:"navbar-logo",style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("img",{src:d,alt:"CAPTAR",style:{height:110,backgroundColor:"#ffffff",borderRadius:8,padding:6}}),n.jsxs("div",{style:{fontSize:12},children:["TENANT: ",n.jsx("strong",{style:{color:"#333"},children:String(S||f).toUpperCase()})]})]}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[n.jsxs("div",{style:{textAlign:"right"},children:[n.jsx("div",{style:{fontWeight:700},children:m?.usuario?String(m?.usuario).toUpperCase():String(m?.nome||"").toUpperCase()||"USUÁRIO"}),n.jsx("div",{style:{fontSize:12},children:`FUNÇÃO: ${String(m?.funcao||"").toUpperCase()} | PERFIL: ${String(m?.perfil||"").toUpperCase()}`}),n.jsx("div",{style:{fontSize:12},children:`LOGIN: ${x||"--"} | TEMPO CONECTADO: ${p||"--:--:--"}`})]}),n.jsx(h,{size:"large"})]})]}),onCancel:c,footer:null,destroyOnHidden:!0,width:800,closable:!1,maskClosable:!1,className:"tenants-modal",children:[n.jsx("style",{children:".tenants-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-modal .ant-modal-content{ border-radius: 0 !important; }"}),n.jsx("div",{style:{fontFamily:"monospace"},children:l||"—"})]})}function D(){const e=l(),{message:t,modal:a}=j.useApp(),[i,d]=r.useState([]),[c,m]=r.useState(!1),[p,f]=r.useState(!1),[S,h]=r.useState(null),[y,D]=r.useState(!1),[O,_]=r.useState(void 0),[R,w]=r.useState(!1),[E,U]=r.useState(""),[P,k]=r.useState({}),[F,$]=r.useState([]),{user:L}=o(),[M,B]=r.useState({open:!1}),z=async()=>{try{m(!0);const t=await e.listTenants(),a=(t.rows||[]).map(e=>({...e,__db__:!!e.Dsn,__db_created_at__:e.DbCreatedAt||e.dbCreatedAt||""}));d(a);const n=["IdTenant","Nome","Slug","Status","Plano","DataCadastro","DataUpdate"],s=`tenants.columns.visible.${L?.usuario||"default"}`,r=localStorage.getItem(s),l={};for(const e of n)l[e]=!0;k(r?JSON.parse(r):{...l,__db__:!0,__db_created_at__:!0});const o=`tenants.columns.order.${L?.usuario||"default"}`,i=localStorage.getItem(o);$(i?JSON.parse(i):n)}catch(a){t.error(a?.response?.data?.detail||"Erro ao carregar tenants")}finally{m(!1)}};r.useEffect(()=>{z()},[]);const V={IdTenant:"ID",Nome:"NOME",Slug:"SLUG",Status:"STATUS",Plano:"PLANO",DataCadastro:"DATA E HORA DE CADASTRO",DataUpdate:"DATA UPDATE"},H=new Set(["IdTenant","Status","Plano","DataCadastro","DataUpdate"]),q=["IdTenant","Nome","Slug","Status","Plano","DataCadastro","DataUpdate"].map(e=>{const t={title:V[e]||e.toUpperCase(),dataIndex:e,align:H.has(e)?"center":"left",sorter:(t,a)=>{const n=t[e],s=a[e];return null==n?-1:null==s?1:"IdTenant"===e?Number(s)-Number(n):e.includes("Data")?new Date(n).getTime()-new Date(s).getTime():String(n).toUpperCase().localeCompare(String(s).toUpperCase())},sortDirections:["ascend","descend"],render:t=>{if(null==t)return"";if(e.includes("Data")){const e=new Date(t);if(!isNaN(e.getTime()))return e.toLocaleString("pt-BR",{hour12:!1})}return String(t).toUpperCase()},onHeaderCell:()=>({draggable:!0,onDragStart:t=>{t.dataTransfer.setData("text/plain",e)},onDragOver:e=>{e.preventDefault()},onDrop:t=>{const a=t.dataTransfer.getData("text/plain"),n=e;a&&a!==n&&$(e=>{const t=e.filter(e=>e!==a),s=t.indexOf(n);if(-1===s)return e;t.splice(s,0,a);const r=`tenants.columns.order.${L?.usuario||"default"}`;return localStorage.setItem(r,JSON.stringify(t)),t})}})};return"IdTenant"===e&&(t.defaultSortOrder="descend"),t}),J=[{title:"DB",dataIndex:"__db__",onCell:()=>({title:"Estado do DSN do Tenant"}),render:e=>e?n.jsx(T,{color:"green",children:"CRIADO"}):n.jsx(T,{children:"NAO CRIADO"})},{title:"DB CRIADO",dataIndex:"__db_created_at__",render:e=>e?new Date(e).toLocaleString("pt-BR",{hour12:!1}):"—"},{title:"AÇÕES",dataIndex:"__actions__",render:(s,r)=>n.jsxs(g,{children:[n.jsx(x,{type:"text",onClick:()=>{h(r),f(!0)},children:"EDITAR"}),n.jsx(x,{type:"text",danger:!0,onClick:()=>{B({open:!0,record:r})},children:"DELETAR"}),n.jsx(x,{type:"text",onClick:()=>{U(String(r.Dsn||"—")),w(!0)},children:"VER DSN"}),r.__db__?n.jsx(x,{danger:!0,onClick:()=>{a.confirm({title:"Deseja realmente apagar o banco e recriá-lo?",okText:"Sobrescrever",okButtonProps:{danger:!0},cancelText:"Cancelar",onOk:async()=>{try{const a=String(r.Slug||"").toLowerCase(),n=await e.recreateTenantDb(a);t.success(`Banco recriado: ${n.dsn}`),await z()}catch(a){t.error(a?.response?.data?.detail||"Erro ao sobrescrever banco")}}})},children:"SOBRESCREVER O BANCO DE DADOS"}):n.jsx(x,{type:"primary",onClick:()=>{const e=r.IdTenant,t=String(r.Slug||"").toLowerCase(),a=String(r.Nome||""),n=`captar_t${String(e).padStart(2,"0")}_${t}`;_({nome:a,slug:t,db_name:n,db_host:"postgres",db_port:"5432",db_user:"captar",db_password:"captar"}),D(!0)},children:"CRIAR BANCO DE DADOS"})]})}],G=(F.length?F:q.map(e=>e.dataIndex)).map(e=>q.find(t=>t.dataIndex===e)).filter(Boolean).filter(e=>P[e.dataIndex]).concat(J);return n.jsxs(s.div,{className:"page-container",initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.3},children:[n.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:12},children:n.jsxs(g,{children:[n.jsx(b,{placement:"bottomRight",trigger:["click"],menu:{items:[]},popupRender:()=>n.jsx("div",{style:{padding:12},children:Object.keys(P).map(e=>n.jsx("div",{style:{marginBottom:6},children:n.jsx(C,{checked:!!P[e],onChange:t=>{const a={...P,[e]:t.target.checked};k(a);const n=`tenants.columns.visible.${L?.usuario||"default"}`;localStorage.setItem(n,JSON.stringify(a))},children:e.toUpperCase()})},e))}),children:n.jsx(x,{shape:"circle",style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},title:"VISUALIZAÇÃO DE COLUNAS"})}),n.jsx(x,{shape:"circle",style:{background:"#FFD700",borderColor:"#FFD700",color:"#000"},onClick:()=>{h(null),f(!0)},title:"NOVO TENANT"})]})}),n.jsx("style",{children:"\n        .tenants-table .ant-table-thead > tr > th{ background:#FFD700; color:#000; font-family: 'Arimo', Arial, sans-serif; }\n        .tenants-table .ant-table-thead > tr > th .ant-table-column-title{ display:flex; justify-content:center; align-items:center; text-align:center; }\n        .tenants-table .ant-table-tbody > tr > td{ font-family: 'Roboto Condensed', Arial, sans-serif; padding:2px 6px; line-height:0.95; height:22px; }\n      "}),n.jsx(I,{rowKey:e=>e.IdTenant||JSON.stringify(e),loading:c,dataSource:i,columns:G,bordered:!0,size:"small",className:"ant-table-striped tenants-table"}),n.jsx(N,{open:p,initial:S||void 0,onCancel:()=>f(!1),onSaved:async e=>{f(!1),h(null),d(t=>[e,...t].filter((e,t,a)=>a.findIndex(t=>Number(t.IdTenant)===Number(e.IdTenant))===t)),await z()}}),n.jsx(A,{open:y,initial:O,onCancel:()=>D(!1),onSaved:async()=>{D(!1),await z()}}),n.jsx(v,{open:R,dsn:E,onCancel:()=>w(!1)}),n.jsxs(u,{open:M.open,title:"Apagar Tenant",onCancel:()=>B({open:!1}),footer:null,children:[n.jsx("style",{children:".tenants-delete-modal .ant-modal-header{ border-bottom: 1px solid #e8e8e8; } .tenants-delete-modal .ant-modal-content{ border-radius: 0 !important; }"}),n.jsx("div",{style:{marginBottom:16,fontSize:14},children:"Esta ação pode remover o tenant e opcionalmente o seu banco de dados."}),n.jsxs(g,{style:{display:"flex",justifyContent:"flex-end",width:"100%"},children:[n.jsx(x,{onClick:()=>B({open:!1}),children:"Cancelar"}),n.jsx(x,{danger:!0,style:{borderRadius:20},onClick:async()=>{try{const a=M.record;if(!a)return;await e.deleteTenant(Number(a.IdTenant)),d(e=>e.filter(e=>Number(e.IdTenant)!==Number(a.IdTenant))),t.success("Tenant apagado (banco mantido)"),B({open:!1}),await z()}catch(a){t.error(a?.response?.data?.detail||"Erro ao deletar tenant")}},children:"Deletar somente o tenant (manter banco)"}),n.jsx(x,{danger:!0,type:"primary",style:{borderRadius:20},onClick:async()=>{try{const a=M.record;if(!a)return;const n=String(a.Slug||"").toLowerCase();await e.deleteTenantAndDb(n),d(e=>e.filter(e=>Number(e.IdTenant)!==Number(a.IdTenant))),t.success("Tenant e banco apagados"),B({open:!1}),await z()}catch(a){t.error(a?.response?.data?.detail||"Erro ao deletar tenant e banco")}},children:"Deletar tenant e banco de dados"})]})]})]})}export{D as default};
